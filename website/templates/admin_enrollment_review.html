

{% extends "admin_base.html" %}

{% block title %}Enrollment Review - {% if application.old_student_id %}{{ application.old_student_id }}{% else
%}P2025{{ "%04d" | format(application.applicant_id) }}{% endif %}{% endblock %}
{% block page_title %}Enrollment Review{% endblock %}

{% block breadcrumb %}
{% if application.application_status == 'Enrolling' %}
<a href="{{ url_for('auth.admin_enrolling_applications') }}" class="text-gray-500 hover:text-primary">Enrolling
    Applications</a>
{% elif application.application_status == 'Enrolled' %}
<a href="{{ url_for('auth.admin_enrolled_applications') }}" class="text-gray-500 hover:text-primary">Enrolled
    Students</a>
{% elif application.application_status == 'Dropped' %}
<a href="{{ url_for('auth.admin_dropped_applications') }}" class="text-gray-500 hover:text-primary">Dropped Students</a>
{% elif application.application_status == 'Not Enrolled' %}
<a href="{{ url_for('auth.admin_not_enrolled_applications') }}" class="text-gray-500 hover:text-primary">Not Enrolled
    Applications</a>
{% else %}
<a href="{{ url_for('auth.admin_all_applications') }}" class="text-gray-500 hover:text-primary">All Applications</a>
{% endif %}
<i class="ri-arrow-right-s-line mx-1 text-gray-400"></i>
<span>Review {% if application.old_student_id %}{{ application.old_student_id }}{% else %}P2025{{ "%04d" |
    format(application.applicant_id) }}{% endif %}</span>
{% endblock %}

{% block content %}
<style>
    .tab-nav-link {
        cursor: pointer;
        padding: 0.75rem 1.25rem;
        border-bottom: 3px solid transparent;
        color: #4b5563;
        font-weight: 500;
        transition: color 0.2s, border-color 0.2s;
    }

    .tab-nav-link.active {
        color: #4f46e5;
        border-bottom-color: #4f46e5;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .data-item {
        background-color: #f9fafb;
        padding: 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }

    .data-item-label {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .data-item-value {
        font-size: 0.875rem;
        color: #1f2937;
        font-weight: 600;
    }

    .doc-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        border-radius: 0.375rem;
        background-color: #f9fafb;
        border: 1px solid #e5e7eb;
    }

    .doc-item-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .doc-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 9999px;
    }

    .doc-provided {
        background-color: #dcfce7;
        color: #166534;
    }

    .doc-missing {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .view-doc-btn {
        background-color: #eef2ff;
        color: #4338ca;
        border: 1px solid #c7d2fe;
    }

    .upload-form {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .upload-form input[type="file"] {
        font-size: 0.75rem;
    }

    .upload-form button {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
    }
</style>

<div class="flex flex-col lg:flex-row gap-6">
    <!-- Left Column: Student Info & Actions -->
    <div class="w-full lg:w-1/3 lg:max-w-sm flex-shrink-0">
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-100 sticky top-24">
            <h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4">Student & Actions</h3>
            <div class="flex items-center mb-4">
                <img src="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) }}"
                    alt="Student Photo" class="w-20 h-20 rounded-full object-cover mr-4 border-2 border-primary/20">
                <div>
                    <p class="font-bold text-xl text-gray-900">{{ application.first_name }} {{ application.last_name }}
                    </p>
                    <div class="flex items-center gap-2">
                        <p class="text-sm text-gray-500">Student ID:
                            <span class="font-bold text-gray-800">
                                {% set display_id = application.old_student_id or application.control_number or ('S-' ~
                                '%05d'|format(application.student_user_id)) %}
                                {{ display_id }}
                            </span>
                        </p>
                        <button id="editStudentIdBtn" data-applicant-id="{{ application.applicant_id }}"
                            class="text-gray-400 hover:text-primary text-xs" title="Edit Student IDs">
                            <i class="ri-pencil-line"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">Program: {{ application.program_choice }}</p>

                    {% if student_academic_status %}
                    <p class="text-sm text-gray-500 mt-1">
                        Marks:
                        {% if student_academic_status == 'Regular' %}
                        <span
                            class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Regular</span>
                        {% else %}
                        <span
                            class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">Irregular</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- START: Section Management (Admin Override) -->
            <div class="mt-6 mb-4 p-4 border border-blue-200 rounded-lg bg-blue-50">
                <h4 class="text-md font-semibold text-blue-800 mb-2">Section Assignment</h4>
                
                {% if application.section_id %}
                    <!-- Currently Assigned Section (from DB join) -->
                    <div class="flex justify-between items-start mb-2">
                        <div>
                             <p class="text-xs text-gray-500 uppercase">Current Section</p>
                             <p class="text-lg font-bold text-blue-700">{{ application.section_name if application.section_name else 'Unknown' }}</p>
                        </div>
                        {% if application.is_section_permanent %}
                            <span class="px-2 py-1 text-xs font-bold bg-green-100 text-green-700 rounded border border-green-200">Permanent</span>
                        {% else %}
                             <span class="px-2 py-1 text-xs font-bold bg-yellow-100 text-yellow-700 rounded border border-yellow-200">Pending</span>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="flex items-center gap-2 mb-2 text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200">
                         <i class="ri-alert-line"></i>
                         <p class="text-xs italic">No section assigned yet. Will be auto-assigned upon approval unless selected below.</p>
                    </div>
                {% endif %}

                <!-- Admin Override Dropdown -->
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <label for="admin_section_override" class="block text-xs font-bold text-gray-600 mb-1 uppercase">Change / Assign Section</label>
                    <select id="admin_section_override" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">-- Auto-Assign / Keep Current --</option>
                        <!-- Options populated via JS -->
                    </select>
                    <p class="text-[10px] text-gray-500 mt-1">Select to manually override.</p>
                </div>
            </div>
            <!-- END: Section Management -->

            <!-- START: Approval Checklist -->
            <div class="mt-6 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-md font-semibold text-gray-800 mb-3">Approval Checklist for {{ selected_term_id and
                    all_academic_terms | selectattr('id', 'equalto', selected_term_id) | first | attr('year_name') }}
                </h4>
                <div class="space-y-3" id="approval-checklist">
                    <!-- President -->
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-medium text-gray-700">President's Office</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">
                                {% if enrollment_record and enrollment_record.president_approval_date %}
                                {{ enrollment_record.president_approval_date.strftime('%b %d, %Y') }}
                                {% endif %}
                            </span>
                            <input type="checkbox" data-role="president"
                                class="approval-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary"
                                {% if enrollment_record and enrollment_record.is_approved_by_president %}checked{% endif
                                %}>
                        </div>
                    </label>
                    <!-- Accounting -->
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-medium text-gray-700">Accounting</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">
                                {% if enrollment_record and enrollment_record.accounting_approval_date %}
                                {{ enrollment_record.accounting_approval_date.strftime('%b %d, %Y') }}
                                {% endif %}
                            </span>
                            <input type="checkbox" data-role="accounting"
                                class="approval-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary"
                                {% if enrollment_record and enrollment_record.is_approved_by_accounting %}checked{%
                                endif %}>
                        </div>
                    </label>
                    <!-- Dean -->
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-medium text-gray-700">College Dean</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">
                                {% if enrollment_record and enrollment_record.dean_approval_date %}
                                {{ enrollment_record.dean_approval_date.strftime('%b %d, %Y') }}
                                {% endif %}
                            </span>
                            <input type="checkbox" data-role="dean"
                                class="approval-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary"
                                {% if enrollment_record and enrollment_record.is_approved_by_dean %}checked{% endif %}>
                        </div>
                    </label>
                </div>
            </div>
            <!-- END: Approval Checklist -->

            <div class="space-y-3">

                <button id="approveBtn" title="Mark this student as officially enrolled."
                    class="w-full flex items-center justify-center px-4 py-2.5 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed"
                    disabled>
                    <i class="ri-check-double-line mr-2"></i> Approve Enrollment
                </button>
                <button id="rejectBtn" {% if application.enrollment_student_type=='Existing' %}
                    title="Reject and move to 'Dropped'. Use if student is no longer continuing." {% else %}
                    title="Reject and move to 'Not Enrolled'. Use if a new student fails to complete enrollment." {%
                    endif %}
                    class="w-full flex items-center justify-center px-4 py-2.5 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                    <i class="ri-close-circle-line mr-2"></i> Reject Submission
                </button>
                <button id="dropBtn" title="Manually drop an enrolled or enrolling student."
                    class="w-full flex items-center justify-center px-4 py-2.5 bg-gray-500 text-white rounded-md text-sm font-medium hover:bg-gray-600">
                    <i class="ri-user-unfollow-line mr-2"></i> Drop Student
                </button>
            </div>
            {% if has_grades %}
            <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-xs">
                <strong>Warning:</strong> This student has grades recorded. Dropping them will change their status but
                will not delete their grade history.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column: Details in Tabs -->
    <div class="flex-1">
        <div class="bg-white rounded-lg shadow-md border border-gray-100">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-2 px-4" id="tab-navigation">
                    <a class="tab-nav-link active" data-target="enrollment-details">Enrollment Details</a>
                    <a class="tab-nav-link" data-target="student-inventory">Student Inventory</a>
                    <a class="tab-nav-link" data-target="documents">Documents</a>
                    <a class="tab-nav-link" data-target="grades">Grades</a>
                </nav>
            </div>
            <div class="p-6">
                <!-- Enrollment Details Pane -->
                <div id="enrollment-details" class="tab-pane active">
                    <h4 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">Enrollment Submission</h4>
                    <div class="data-grid">
                        {% for label, value in enrollment_details.items() %}
                        <div class="data-item">
                            <span class="data-item-label">{{ label }}</span>
                            <span class="data-item-value">{{ value or 'N/A' }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Student Inventory Pane -->
                <div id="student-inventory" class="tab-pane">
                    <h4 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">Student Inventory Data</h4>
                    {% if inventory_data %}
                    <div class="data-grid">
                        {% for label, value in inventory_data.items() %}
                        <div class="data-item">
                            <span class="data-item-label">{{ label }}</span>
                            <span class="data-item-value">{{ value or 'N/A' }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-sm">No inventory data was submitted with this enrollment.</p>
                    {% endif %}
                </div>

                <!-- Documents Pane -->
                <div id="documents" class="tab-pane">
                    <h4 class="text-md font-semibold text-gray-700 mb-4 pb-2 border-b">Document Management</h4>

                    <div class="space-y-4">
                        {% set doc_map = {
                        'shs_card': {'label': 'Form 138 (SHS Card)', 'enroll_prefix': 'enrollment_shs_card',
                        'initial_prefix': 'shs_card', 'enroll_url': 'enrollment_card', 'initial_url': 'card'},
                        'shs_diploma': {'label': 'SHS Diploma', 'enroll_prefix': 'enrollment_shs_diploma',
                        'initial_prefix': 'shs_diploma', 'enroll_url': 'enrollment_diploma', 'initial_url': 'diploma'},
                        'good_moral': {'label': 'Good Moral Certificate', 'enroll_prefix': 'enrollment_good_moral',
                        'initial_prefix': None, 'enroll_url': 'enrollment_good_moral', 'initial_url': None},
                        'psa_birth': {'label': 'PSA Birth Certificate', 'enroll_prefix': 'enrollment_psa_birth',
                        'initial_prefix': 'birth_certificate', 'enroll_url': 'enrollment_psa', 'initial_url':
                        'birth_cert'},
                        'photos_2x2': {'label': '2x2 Photos', 'enroll_prefix': 'enrollment_photos_2x2',
                        'initial_prefix': 'photo', 'enroll_url': 'enrollment_photos', 'initial_url': None},
                        'entrance_fee_proof': {'label': 'Signature', 'enroll_prefix': 'enrollment_entrance_fee_proof',
                        'initial_prefix': None, 'enroll_url': 'enrollment_fee', 'initial_url': None},
                        'voters_id': {'label': 'Voter\'s ID', 'enroll_prefix': 'enrollment_voters_id', 'initial_prefix':
                        None, 'enroll_url': 'enrollment_voters', 'initial_url': None},
                        'cbs': {'label': 'Verified CBS', 'enroll_prefix': 'enrollment_cbs', 'initial_prefix': None,
                        'enroll_url': 'enrollment_cbs', 'initial_url': None},
                        'brgy_cert': {'label': 'Brgy. Certification', 'enroll_prefix': 'enrollment_brgy_cert',
                        'initial_prefix': None, 'enroll_url': 'enrollment_brgy', 'initial_url': None}
                        } %}

                        {% for doc_key, info in doc_map.items() %}
                        {% set enrollment_file = application[info.enroll_prefix ~ '_file'] %}
                        {% set initial_file = application[info.initial_prefix] if info.initial_prefix == 'photo' else
                        (application[info.initial_prefix ~ '_file'] if info.initial_prefix else None) %}
                        {% set doc_exists = enrollment_file or initial_file %}
                        <div class="doc-item" id="doc-item-{{ doc_key }}">
                            <div class="doc-item-info">
                                <span class="doc-status-badge {{ 'doc-provided' if doc_exists else 'doc-missing' }}">
                                    {% if doc_exists %}✓ Provided{% else %}✗ Missing{% endif %}
                                </span>
                                <span class="font-medium text-sm text-gray-800">{{ info.label }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                {% if enrollment_file %}
                                <button type="button" class="view-doc-btn px-2 py-1 text-xs font-medium rounded-md"
                                    data-view-url="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type=info.enroll_url) }}"
                                    data-download-url="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type=info.enroll_url, action='download') }}"
                                    data-doc-title="{{ application[info.enroll_prefix ~ '_filename'] or info.label }}"
                                    data-doc-type="{{ 'image' if (application[info.enroll_prefix ~ '_mimetype'] and 'image' in application[info.enroll_prefix ~ '_mimetype']) else 'pdf' }}">
                                    View
                                </button>
                                {% elif initial_file %}
                                {% if info.initial_prefix == 'photo' %}
                                <button type="button" class="view-doc-btn px-2 py-1 text-xs font-medium rounded-md"
                                    data-view-url="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) }}"
                                    data-download-url="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id, action='download') }}"
                                    data-doc-title="{{ application['photo_filename'] or info.label }}"
                                    data-doc-type="image">
                                    View (Initial)
                                </button>
                                {% else %}
                                <button type="button" class="view-doc-btn px-2 py-1 text-xs font-medium rounded-md"
                                    data-view-url="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type=info.initial_url) }}"
                                    data-download-url="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type=info.initial_url, action='download') }}"
                                    data-doc-title="{{ application[info.initial_prefix ~ '_filename'] or info.label }}"
                                    data-doc-type="{{ 'image' if (application[info.initial_prefix ~ '_mimetype'] and 'image' in application[info.initial_prefix ~ '_mimetype']) else 'pdf' }}">
                                    View (Initial)
                                </button>
                                {% endif %}
                                {% endif %}
                                <form class="upload-form" data-doc-type="{{ doc_key }}">
                                    <input type="file" name="file" class="text-xs" required>
                                    <button type="submit"
                                        class="px-2 py-1 text-xs font-medium rounded-md bg-primary text-white hover:bg-primary/90">
                                        {% if doc_exists %}Replace{% else %}Upload{% endif %}
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Grades Pane -->
                <div id="grades" class="tab-pane">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <h4 class="text-md font-semibold text-gray-700">Grades Overview</h4>
                        <a href="{{ url_for('auth.admin_manage_grades_page', student_user_id=application.student_user_id) }}"
                            class="text-sm font-medium text-primary hover:underline">Manage Grades</a>
                    </div>
                    {% if has_grades and subjects_by_year %}
                    {% for year, semesters in subjects_by_year.items()|sort %}
                    <div class="mb-6">
                        <h5 class="text-lg font-semibold text-gray-800 mb-2 p-2 bg-gray-100 rounded">Year {{ year }}
                        </h5>
                        {% for semester, subjects in semesters.items()|sort %}
                        {% set has_grades_for_sem = subjects | selectattr('id', 'in', student_grades.keys()) | list |
                        length > 0 %}
                        {% if has_grades_for_sem %}
                        <div class="mb-4">
                            <h6 class="text-md font-medium text-gray-600 mb-2 border-b pb-1">Semester {{ semester }}
                            </h6>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Code</th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Subject Title</th>
                                            <th class="px-4 py-2 text-center font-medium text-gray-600">Grade</th>
                                            <th class="px-4 py-2 text-left font-medium text-gray-600">Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for subject in subjects %}
                                        {% set grade_info = student_grades.get(subject.id) %}
                                        {% if grade_info %}
                                        <tr>
                                            <td class="px-4 py-2 whitespace-nowrap font-mono">{{ subject.subject_code }}
                                            </td>
                                            <td class="px-4 py-2">{{ subject.subject_title }}</td>
                                            <td class="px-4 py-2 text-center font-semibold">{{ grade_info.grade if
                                                grade_info.grade is not none else 'N/A' }}</td>
                                            <td class="px-4 py-2">{{ grade_info.remarks or 'N/A' }}</td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-gray-500 text-sm">No grades have been recorded for this student yet.</p>
                    {% endif %}
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div id="document-viewer-modal"
    class="fixed inset-0 bg-gray-800 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl flex flex-col w-full max-w-2xl h-5/6 max-h-[85vh]">
        <!-- Modal Header -->
        <div class="flex-shrink-0 bg-gray-100 p-3 flex justify-between items-center border-b">
            <h3 id="modal-doc-title" class="text-lg font-semibold text-gray-800 truncate pr-4">Document Viewer</h3>
            <div class="flex items-center gap-4">
                <a id="modal-download-btn" href="#"
                    class="inline-flex items-center gap-2 bg-primary text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-primary/80">
                    <i class="ri-download-2-line"></i>
                    <span>Download</span>
                </a>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">
                    <i class="ri-close-line text-2xl"></i>
                </button>
            </div>
        </div>
        <!-- Modal Content -->
        <div id="modal-doc-content" class="flex-grow bg-gray-200 overflow-y-auto">
            <!-- Iframe or image will be inserted here by JS -->
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const applicantId = "{{ application.applicant_id }}";
        const selectedTermId = {{ selected_term_id | tojson }};
        const hasGrades = {{ has_grades | tojson }};
        const studentType = "{{ application.enrollment_student_type or 'New' }}";
        const redirectUrl = "{{ url_for('auth.admin_enrolling_applications') }}";

        const termSelect = document.getElementById('term_id');
        if (termSelect) {
            termSelect.addEventListener('change', function () {
                document.getElementById('term-select-form').submit();
            });
        }

        // --- SECTION FETCHING LOGIC FOR ADMIN ---
        const sectionSelect = document.getElementById('admin_section_override');
        const programTitle = "{{ application.program_choice }}";
        const yearLevel = "{{ application.enrollment_year_level }}";

        async function loadSectionsForAdmin() {
            if (!sectionSelect) return;
            
            try {
                const response = await fetch(`/api/get-sections?program=${encodeURIComponent(programTitle)}&year=${encodeURIComponent(yearLevel)}`);
                const sections = await response.json();
                
                sections.forEach(sec => {
                    const option = document.createElement('option');
                    option.value = sec.id;
                    option.textContent = `${sec.section_name} (${sec.current_count}/${sec.max_students})`; // Show capacity
                    
                    // Pre-select current if matches
                    if (sec.id == "{{ application.section_id }}") {
                        option.selected = true;
                    }
                    sectionSelect.appendChild(option);
                });
            } catch (e) {
                console.error("Failed to load sections", e);
            }
        }
        loadSectionsForAdmin();
        // -----------------------------------------

        // Tab switching logic
        const tabLinks = document.querySelectorAll('.tab-nav-link');
        const tabPanes = document.querySelectorAll('.tab-pane');
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                tabLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const targetId = link.dataset.target;
                tabPanes.forEach(pane => {
                    pane.classList.toggle('active', pane.id === targetId);
                });
            });
        });

        // Action buttons logic
        const approveBtn = document.getElementById('approveBtn');
        approveBtn.addEventListener('click', () => handleAction('approve'));
        document.getElementById('dropBtn').addEventListener('click', () => handleAction('drop'));

        document.getElementById('rejectBtn').addEventListener('click', async () => {
            let title, inputPlaceholder;

            if (studentType === 'Existing') {
                title = 'Reject & Drop Student';
                inputPlaceholder = 'Reason for dropping this existing student...';
            } else {
                title = 'Reject & Mark as Not Enrolled';
                inputPlaceholder = 'Reason for marking this new student as not enrolled...';
            }

            const { value: reason } = await Swal.fire({
                title: title,
                input: 'textarea',
                inputLabel: 'Reason for Rejection',
                inputPlaceholder: inputPlaceholder,
                inputAttributes: { 'aria-label': 'Type your reason here' },
                showCancelButton: true,
                confirmButtonText: 'Confirm Rejection',
                confirmButtonColor: '#d33'
            });
            if (reason) {
                handleAction('reject', reason);
            }
        });

        async function handleAction(action, reason = null) {
            let confirmationText = `Are you sure you want to ${action} this enrollment?`;
            if (action === 'drop' && hasGrades) {
                confirmationText = "This student has grades recorded. Dropping them will only change their status. Are you sure you want to proceed?";
            } else if (action === 'reject') {
                if (studentType === 'Existing') {
                    confirmationText = "This will reject the enrollment and move the student to 'Dropped'. Are you sure?";
                } else {
                    confirmationText = "This will reject the enrollment and move the student to 'Not Enrolled'. Are you sure?";
                }
            }
            
            // Get selected section override
            const manualSectionId = sectionSelect ? sectionSelect.value : null;

            Swal.fire({
                title: 'Confirm Action',
                text: confirmationText,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: `Yes, proceed!`
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/admin/enrollment/${applicantId}/action`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                action, 
                                reason, 
                                term_id: selectedTermId,
                                manual_section_id: manualSectionId // Send override ID
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            await Swal.fire('Success!', data.message, 'success');
                            window.location.href = redirectUrl;
                        } else {
                            throw new Error(data.message);
                        }
                    } catch (error) {
                        Swal.fire('Error!', error.message || 'An unknown error occurred.', 'error');
                    }
                }
            });
        }

        // Document upload logic
        document.querySelectorAll('.upload-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const docType = form.dataset.docType;
                const fileInput = form.querySelector('input[type="file"]');
                if (!fileInput.files.length) {
                    showToast('Please select a file to upload.', 'error');
                    return;
                }
                const formData = new FormData();
                formData.append('doc_type', docType);
                formData.append('file', fileInput.files[0]);

                const submitBtn = form.querySelector('button');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Uploading...';

                try {
                    const response = await fetch(`/admin/enrollment/${applicantId}/upload-doc`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast(data.message, 'success');
                        setTimeout(() => location.reload(), 1500); // Reload to show updated status
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    showToast(error.message || 'Upload failed.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    // Text will be reset on reload
                }
            });
        });

        function showToast(message, type = 'info') {
            Swal.fire({ toast: true, position: 'top-end', icon: type, title: message, showConfirmButton: false, timer: 3000, timerProgressBar: true });
        }

        // --- START: Approval Checklist & Document Viewer Logic ---
        const approvalCheckboxes = document.querySelectorAll('.approval-checkbox');

        function checkAllApprovals() {
            const allChecked = Array.from(approvalCheckboxes).every(cb => cb.checked);
            approveBtn.disabled = !allChecked;
        }

        approvalCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', async function () {
                const role = this.dataset.role;
                const isChecked = this.checked;
                const originalState = !isChecked; // for reverting on failure

                // Disable all checkboxes to prevent race conditions
                approvalCheckboxes.forEach(cb => cb.disabled = true);

                try {
                    const response = await fetch(`/admin/enrollment/${applicantId}/toggle-approval`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: role, status: isChecked, term_id: selectedTermId })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showToast(data.message, 'success');
                        // Reload to get updated dates from server
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        throw new Error(data.message);
                    }
                } catch (error) {
                    showToast(error.message || 'Failed to update status.', 'error');
                    this.checked = originalState; // Revert checkbox on error
                    // Re-enable checkboxes on failure
                    approvalCheckboxes.forEach(cb => cb.disabled = false);
                }

                checkAllApprovals(); // Update button state based on new checkbox state
            });
        });

        checkAllApprovals(); // Initial check on page load

        const docViewerModal = document.getElementById('document-viewer-modal');
        const modalDocTitle = document.getElementById('modal-doc-title');
        const modalDownloadBtn = document.getElementById('modal-download-btn');
        const modalDocContent = document.getElementById('modal-doc-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const viewDocButtons = document.querySelectorAll('.view-doc-btn');

        viewDocButtons.forEach(button => {
            button.addEventListener('click', () => {
                const viewUrl = button.dataset.viewUrl;
                const downloadUrl = button.dataset.downloadUrl;
                const docTitle = button.dataset.docTitle;
                const docType = button.dataset.docType || 'pdf';

                modalDocTitle.textContent = docTitle;
                modalDownloadBtn.href = downloadUrl;
                modalDocContent.innerHTML = '';

                let contentElement;
                if (docType === 'image') {
                    contentElement = document.createElement('img');
                    contentElement.src = viewUrl;
                    contentElement.alt = docTitle;
                    contentElement.className = 'w-full h-full object-contain';
                } else {
                    contentElement = document.createElement('iframe');
                    contentElement.src = viewUrl;
                    contentElement.className = 'w-full h-full border-0';
                }

                modalDocContent.appendChild(contentElement);
                docViewerModal.classList.remove('hidden');
                docViewerModal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            });
        });

        function closeModal() {
            docViewerModal.classList.add('hidden');
            docViewerModal.classList.remove('flex');
            modalDocContent.innerHTML = '';
            document.body.style.overflow = '';
        }

        modalCloseBtn.addEventListener('click', closeModal);
        docViewerModal.addEventListener('click', (e) => {
            if (e.target === docViewerModal) {
                closeModal();
            }
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape" && !docViewerModal.classList.contains('hidden')) {
                closeModal();
            }
        });
        // --- END: Approval Checklist & Document Viewer Logic ---
    });
</script>
{% endblock %}