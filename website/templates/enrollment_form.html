

{% extends 'base.html' %}

{% block title %}Enrollment Form{% endblock %}

{% block style %}
<style>
    /* Radio button styling */
    input[type="radio"].custom-radio {
        appearance: none;
        -webkit-appearance: none;
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        outline: none;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
    }

    input[type="radio"].custom-radio:checked {
        background-color: #4f46e5;
        border-color: #4f46e5;
    }

    input[type="radio"].custom-radio:checked::before {
        content: '';
        display: block;
        width: 0.625rem;
        height: 0.625rem;
        margin: 3px;
        background-color: white;
        border-radius: 50%;
    }

    /* Inventory Form Specific Styles */
    .form-section h3 {
        text-align: left;
        background-color: #eef2ff;
        color: #4338ca;
        padding: 8px;
        margin-top: 30px;
        font-size: 1.1em;
        font-weight: 600;
        border-left: 5px solid #4f46e5;
    }

    .inventory-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .inventory-table th,
    .inventory-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
        font-size: 0.875rem;
    }

    .inventory-table th {
        background-color: #f3f4f6;
    }

    .inventory-table input[type="text"] {
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 6px;
    }
</style>
{% endblock %}

{% block body %}

<body class="bg-gray-50" style="margin-top: 100px;">
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 sm:p-8">
            <div class="text-center border-b pb-6 mb-6">
                <i class="ri-user-follow-line text-5xl text-primary"></i>
                <h1 class="text-3xl font-bold text-gray-900 mt-4">Enrollment Form & Student Inventory</h1>
                <p class="text-gray-600 mt-2">Congratulations! Please complete this final form to secure your
                    enrollment.</p>
            </div>

            {% if application %}
            <form id="enrollmentForm"
                action="{{ url_for('auth.submit_enrollment', applicant_id=application.applicant_id) }}" method="POST"
                enctype="multipart/form-data">

                <!-- Applicant Summary -->
                <div class="space-y-6 text-sm">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">Applicant Summary</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 bg-gray-50 p-4 rounded-md border">
                            <p><strong>Applicant Name:</strong> {% if application.old_student_id %}{{
                                application.old_student_id }}
                                {% elif application.control_number %}{{ application.control_number }}
                                {% elif application %}P{{ application.academic_year[:4] if application.academic_year
                                else '2025' }}{{ "%04d" | format(application.applicant_id) }}
                                {% else %}N/A{% endif %}</p>
                            <p><strong>Email:</strong> {{ application.email_address }}</p>
                        </div>
                    </div>
                </div>

                <!-- Enrollment Details -->
                <div class="mt-8 pt-6 border-t">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Enrollment Details</h2>

                    <!-- Program Selection -->
                    <div class="mb-6">
                        <label for="program_choice" class="block text-sm font-medium text-gray-700 mb-1">1. Select
                            Program <span class="text-red-500">*</span></label>
                        <select id="program_choice" name="program_choice" required
                            class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-primary focus:border-primary">
                            <option value="" disabled>Choose Program...</option>
                            {% for prog in programs %}
                            <option value="{{ prog.title }}" {% if prog.title==application.program_choice %}selected{%
                                endif %}>
                                {{ prog.title }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Confirm or change your program choice.</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="year_level" class="block text-sm font-medium text-gray-700 mb-1">2. Year
                                Level</label>
                            
                            {% if application.enrollment_student_type == 'New' %}
                                <!-- NEW STUDENT LOGIC: Locked to 1st Year -->
                                <input type="text" value="1st Year" readonly 
                                    class="w-full border-gray-300 rounded-md shadow-sm text-sm bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                                <input type="hidden" name="year_level" value="1st Year">
                                <p class="text-xs text-blue-600 mt-1">New students automatically start at 1st Year.</p>
                            
                            {% else %}
                                <!-- EXISTING STUDENT LOGIC: Dropdown -->
                                <select id="year_level" name="year_level" required
                                    class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-primary focus:border-primary transition-colors">
                                    <option value="" disabled selected>Choose year...</option>
                                    <option value="1st Year">1st Year</option>
                                    <option value="2nd Year">2nd Year</option>
                                    <option value="3rd Year">3rd Year</option>
                                    <option value="4th Year">4th Year</option>
                                    <option value="5th Year">5th Year</option>
                                </select>
                                <p id="year_level_note" class="text-xs text-orange-600 mt-1 hidden">Changing program resets Year Level to 1st Year.</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">3. Semester</label>
                            <input type="text" id="semester" name="semester" 
                                   value="{{ active_term.semester if active_term else '' }}" 
                                   readonly 
                                   class="w-full border-gray-300 rounded-md shadow-sm text-sm bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                            <p class="text-xs text-gray-500 mt-1">Automatically set based on the active academic term.</p>
                        </div>
                    </div>

                    <!-- SECTION SELECTION (Only for Existing Students without Section) -->
                    {% if (application.enrollment_student_type == 'Existing' or application.old_student_id) and not application.section_id %}
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md" id="section_selection_container">
                        <h3 class="text-sm font-bold text-blue-800 mb-2">4. Select Your Section</h3>
                        <p class="text-xs text-blue-600 mb-3">
                            As an existing student entering the new system, please select your assigned section. 
                            <strong>This selection will become permanent.</strong>
                        </p>
                        
                        <label for="section_id" class="block text-sm font-medium text-gray-700 mb-1">Select Section <span class="text-red-500">*</span></label>
                        <select id="section_id" name="section_id" required class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-primary focus:border-primary">
                            <option value="" disabled selected>Select Program & Year first...</option>
                            <!-- Options populated via JS -->
                        </select>
                    </div>
                    {% endif %}

                    <!-- DOCUMENT UPLOAD SECTION -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">5. Enrollment Documents</h3>
                        <div class="space-y-4 p-4 rounded-md bg-gray-50 border">

                            <p class="text-xs text-gray-600 mb-4">Upload the required documents below. Max file size:
                                5MB. Accepted formats: PDF, JPG, PNG.</p>

                            {% set doc_map = {
                            'enrollment_good_moral_file_input': ('a. Good Moral Certificate', False),
                            'enrollment_voters_id_file_input': ('c. Voter\'s ID / Certificate (if available)', False),
                            'enrollment_cbs_file_input': ('d. Verified CBS', False),
                            'enrollment_brgy_cert_file_input': ('e. Barangay Certification', False)
                            } %}

                            <!-- Standard Files Loop -->
                            {% for name, info in doc_map.items() %}
                            {% set label, submitted = info %}
                            <div>
                                <label for="{{ name }}" class="block text-sm font-medium text-gray-700">{{ label
                                    }}</label>
                                <input type="file" name="{{ name }}" id="{{ name }}" accept=".pdf,.jpg,.jpeg,.png"
                                    class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-primary hover:file:bg-indigo-100">
                            </div>
                            {% endfor %}

                            <!-- Signature File Upload -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <label for="enrollment_entrance_fee_proof_file_input" class="block text-sm font-medium text-gray-700 mb-2">
                                    b. Upload Signature <span class="text-red-500">*</span>
                                </label>
                                <input type="file" 
                                    name="enrollment_entrance_fee_proof_file_input" 
                                    id="enrollment_entrance_fee_proof_file_input" 
                                    accept=".pdf,.jpg,.jpeg,.png"
                                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-primary hover:file:bg-indigo-100"
                                    required>
                                <p class="text-xs text-gray-500 mt-1">Please sign on a white paper, take a photo or scan it, and upload here.</p>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- Inventory Form Section -->
                <div class="mt-8 pt-6 border-t">
                    <div class="form-section">
                        <h3>I. PERSONAL INFORMATION</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                            <div class="md:col-span-2"><label class="font-medium">Gender *</label>
                                <div class="flex gap-4 mt-2"><label class="flex items-center"><input type="radio"
                                            name="gender" value="Female" class="custom-radio" required> <span
                                            class="ml-2">Female</span></label><label class="flex items-center"><input
                                            type="radio" name="gender" value="Male" class="custom-radio"> <span
                                            class="ml-2">Male</span></label></div>
                            </div>
                            <div><label class="font-medium">Age</label><input type="number" name="age"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Religion *</label><input type="text" name="religion"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div class="md:col-span-2"><label class="font-medium">Complete Address *</label><input
                                    type="text" name="complete_address"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div><label class="font-medium">Mobile Number *</label><input type="tel"
                                    name="mobile_number" value="{{ application.mobile_number or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div><label class="font-medium">Facebook Account</label><input type="text"
                                    name="facebook_account"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Interests/Hobbies</label><input type="text"
                                    name="interest_hobbies"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Health Condition</label><input type="text"
                                    name="health_condition"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>II. EDUCATIONAL BACKGROUND</h3>
                        <div class="overflow-x-auto">
                            <table class="inventory-table">
                                <thead>
                                    <tr>
                                        <th>LEVEL</th>
                                        <th>SCHOOL</th>
                                        <th>DATES</th>
                                        <th>AWARDS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Pre-Elementary</td>
                                        <td><input type="text" name="pre_elementary_school"></td>
                                        <td><input type="text" name="pre_elementary_dates"></td>
                                        <td><input type="text" name="pre_elementary_awards"></td>
                                    </tr>
                                    <tr>
                                        <td>Elementary</td>
                                        <td><input type="text" name="elementary_school"></td>
                                        <td><input type="text" name="elementary_dates"></td>
                                        <td><input type="text" name="elementary_awards"></td>
                                    </tr>
                                    <tr>
                                        <td>Secondary</td>
                                        <td><input type="text" name="secondary_school"
                                                value="{{ application.senior_high_school or '' }}"></td>
                                        <td><input type="text" name="secondary_dates"
                                                value="{{ (application.senior_high_school_year_from ~ ' - ' ~ application.senior_high_school_year_to) if application.senior_high_school_year_from else '' }}">
                                        </td>
                                        <td><input type="text" name="secondary_awards"></td>
                                    </tr>
                                    <tr>
                                        <td>Vocational</td>
                                        <td><input type="text" name="vocational_school"></td>
                                        <td><input type="text" name="vocational_dates"></td>
                                        <td><input type="text" name="vocational_awards"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>III. HOME AND FAMILY BACKGROUND</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mt-4 text-sm">
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Father's Info</h4><label
                                    class="font-medium">Name *</label><input type="text" name="father_name"
                                    value="{{ application.father_name or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required><label
                                    class="font-medium mt-2 block">Age</label><input type="number" name="father_age"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><label
                                    class="font-medium mt-2 block">Status *</label>
                                <div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio"
                                            name="father_status" value="Living" class="custom-radio" checked required>
                                        <span class="ml-2">Living</span></label><label class="flex items-center"><input
                                            type="radio" name="father_status" value="Deceased" class="custom-radio">
                                        <span class="ml-2">Deceased</span></label></div><label
                                    class="font-medium mt-2 block">Education</label><input type="text"
                                    name="father_education"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><label
                                    class="font-medium mt-2 block">Occupation *</label><input type="text"
                                    name="father_occupation" value="{{ application.father_occupation or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required><label
                                    class="font-medium mt-2 block">Contact</label><input type="tel"
                                    name="father_contact" value="{{ application.father_contact_number or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800 mb-2">Mother's Info</h4><label
                                    class="font-medium">Name *</label><input type="text" name="mother_name"
                                    value="{{ application.mother_maiden_name or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required><label
                                    class="font-medium mt-2 block">Age</label><input type="number" name="mother_age"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><label
                                    class="font-medium mt-2 block">Status *</label>
                                <div class="flex gap-4 mt-1"><label class="flex items-center"><input type="radio"
                                            name="mother_status" value="Living" class="custom-radio" checked required>
                                        <span class="ml-2">Living</span></label><label class="flex items-center"><input
                                            type="radio" name="mother_status" value="Deceased" class="custom-radio">
                                        <span class="ml-2">Deceased</span></label></div><label
                                    class="font-medium mt-2 block">Education</label><input type="text"
                                    name="mother_education"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><label
                                    class="font-medium mt-2 block">Occupation *</label><input type="text"
                                    name="mother_occupation" value="{{ application.mother_occupation or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required><label
                                    class="font-medium mt-2 block">Contact</label><input type="tel"
                                    name="mother_contact" value="{{ application.mother_contact_number or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="md:col-span-2"><label class="font-medium">Parents' Marital Status *</label>
                                <div class="flex flex-wrap gap-4 mt-2"><label class="flex items-center"><input
                                            type="radio" name="parents_marital_status" value="Single Parent"
                                            class="custom-radio" required> <span class="ml-2">Single
                                            Parent</span></label><label class="flex items-center"><input type="radio"
                                            name="parents_marital_status" value="Married but Separated"
                                            class="custom-radio"> <span class="ml-2">Married but
                                            Separated</span></label><label class="flex items-center"><input type="radio"
                                            name="parents_marital_status" value="Married and staying together"
                                            class="custom-radio"> <span class="ml-2">Married & Together</span></label>
                                </div>
                            </div>
                            <div><label class="font-medium"># of Children *</label><input type="number"
                                    name="number_of_children"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div><label class="font-medium"># of Brothers</label><input type="number"
                                    name="number_of_brothers"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium"># of Sisters</label><input type="number"
                                    name="number_of_sisters"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Guardian Name (if any)</label><input type="text"
                                    name="guardian_name" value="{{ application.guardian_name or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Guardian Relationship</label><input type="text"
                                    name="guardian_relationship"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Guardian Contact</label><input type="tel"
                                    name="guardian_contact" value="{{ application.guardian_contact_number or '' }}"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div class="md:col-span-2"><label class="font-medium">Family Income *</label>
                                <div class="flex flex-wrap gap-4 mt-2"><label class="flex items-center"><input
                                            type="radio" name="family_income" value="P 10,000.00 Below"
                                            class="custom-radio" checked required> <span class="ml-2">Below
                                            ₱10k</span></label><label class="flex items-center"><input type="radio"
                                            name="family_income" value="P 10,000.00 - P 20,000.00" class="custom-radio">
                                        <span class="ml-2">₱10k - ₱20k</span></label><label
                                        class="flex items-center"><input type="radio" name="family_income"
                                            value="Above P 20,000.00" class="custom-radio"> <span class="ml-2">Above
                                            ₱20k</span></label></div>
                            </div>
                            <div><label class="font-medium">Favorite Colors</label><input type="text"
                                    name="favorite_colors"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Favorite Sports</label><input type="text"
                                    name="favorite_sports"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div><label class="font-medium">Favorite Foods</label><input type="text"
                                    name="favorite_foods"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                            <div class="md:col-span-2"><label class="font-medium">Family Description *</label>
                                <div class="flex flex-wrap gap-4 mt-2">
                                    <label class="flex items-center"><input type="radio" name="family_description"
                                            value="Broken Family" class="custom-radio"> <span class="ml-2">Broken
                                            Family</span></label>
                                    <label class="flex items-center"><input type="radio" name="family_description"
                                            value="OFW" class="custom-radio"> <span class="ml-2">OFW</span></label>
                                    <label class="flex items-center"><input type="radio" name="family_description"
                                            value="Separated" class="custom-radio"> <span
                                            class="ml-2">Separated</span></label>
                                    <label class="flex items-center"><input type="radio" name="family_description"
                                            value="Single Parent" class="custom-radio"> <span class="ml-2">Single
                                            Parent</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>EMERGENCY CONTACT INFORMATION</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 text-sm">
                            <div><label class="font-medium">Name *</label><input type="text"
                                    name="emergency_contact_name"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div><label class="font-medium">Number *</label><input type="tel"
                                    name="emergency_contact_number"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                            <div><label class="font-medium">Relationship *</label><input type="text"
                                    name="emergency_contact_relationship"
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                        </div>
                    </div>
                </div>

                <!-- Submission Controls -->
                <div class="mt-8 pt-6 border-t">
                    <div class="flex items-start p-4 rounded-md bg-yellow-50 border border-yellow-200 text-sm">
                        <i class="ri-alert-line text-yellow-500 text-xl mr-3 mt-1"></i>
                        <div>
                            <h3 class="font-semibold text-yellow-800">Final Confirmation</h3>
                            <p class="text-yellow-700">By submitting, you confirm your intent to enroll. Your submission
                                will be forwarded to the registrar for verification. Final enrollment depends on the
                                successful submission of all documents and payment of fees.</p>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end items-center gap-4">
                        <a href="{{ url_for('views.application_status_page') }}"
                            class="text-sm font-medium text-gray-600 hover:text-primary">Cancel and Go Back</a>
                        <button type="submit"
                            class="bg-primary text-white px-6 py-3 rounded-button font-medium whitespace-nowrap flex items-center text-sm hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="ri-checkbox-circle-line mr-2"></i> Submit Enrollment
                        </button>
                    </div>
                </div>
            </form>
            {% else %}
            <div class="text-center text-red-600 bg-red-50 p-4 rounded-md">
                <p>Error: Could not load application details. Please go back and try again.</p><a
                    href="{{ url_for('views.application_status_page') }}"
                    class="mt-4 inline-block text-primary hover:underline">Return to Status Page</a>
            </div>
            {% endif %}
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const programSelect = document.getElementById('program_choice');
            const yearSelect = document.getElementById('year_level');
            const yearNote = document.getElementById('year_level_note');
            
            // For Section Logic
            const sectionSelect = document.getElementById('section_id');
            const sectionContainer = document.getElementById('section_selection_container');
            
            // Store the original program provided by the backend
            const originalProgram = "{{ application.program_choice }}";
        
            function checkProgramChange() {
                const selectedProgram = programSelect.value;
        
                if (selectedProgram !== originalProgram) {
                    // User changed program -> Reset to 1st Year
                    if(yearSelect) {
                        yearSelect.value = "1st Year";
                        // Lock visually but keep value submittable
                        yearSelect.style.pointerEvents = 'none'; 
                        yearSelect.style.backgroundColor = '#f3f4f6'; 
                        yearSelect.style.color = '#6b7280'; 
                    }
                    
                    if(yearNote) yearNote.classList.remove('hidden');

                    // Hide Section Selection (Auto-assign for shifters/new program)
                    if(sectionContainer) {
                        sectionContainer.classList.add('hidden');
                        if(sectionSelect) sectionSelect.removeAttribute('required');
                    }
                } else {
                    // User reverted to original program
                    if(yearSelect) {
                        yearSelect.style.pointerEvents = 'auto';
                        yearSelect.style.backgroundColor = '';
                        yearSelect.style.color = '';
                    }
                    
                    if(yearNote) yearNote.classList.add('hidden');

                    // Show Section Selection if applicable (Existing Student)
                    if(sectionContainer) {
                        sectionContainer.classList.remove('hidden');
                        if(sectionSelect) sectionSelect.setAttribute('required', 'required');
                        fetchSections(); // Load sections
                    }
                }
            }

            // Fetch sections dynamically
            async function fetchSections() {
                if (!sectionSelect) return; 

                const prog = programSelect.value;
                const year = yearSelect.value;
                
                if(prog && year) {
                    sectionSelect.innerHTML = '<option value="" disabled>Loading...</option>';
                    sectionSelect.disabled = true;
                    
                    try {
                        const response = await fetch(`/api/get-sections?program=${encodeURIComponent(prog)}&year=${encodeURIComponent(year)}`);
                        const sections = await response.json();
                        
                        sectionSelect.innerHTML = '<option value="" disabled selected>Choose Section...</option>';
                        
                        if(sections.length === 0) {
                            const option = document.createElement('option');
                            option.text = "No sections available";
                            option.disabled = true;
                            sectionSelect.appendChild(option);
                        } else {
                            sections.forEach(sec => {
                                const option = document.createElement('option');
                                option.value = sec.id;
                                option.textContent = sec.section_name; 
                                sectionSelect.appendChild(option);
                            });
                        }
                        sectionSelect.disabled = false;
                    } catch (e) {
                        console.error("Error loading sections", e);
                        sectionSelect.innerHTML = '<option value="" disabled>Error loading sections</option>';
                    }
                }
            }
            
            // Init checks
            checkProgramChange();
        
            // Listeners
            programSelect.addEventListener('change', () => {
                checkProgramChange();
            });

            if(yearSelect) {
                yearSelect.addEventListener('change', () => {
                    // Re-fetch sections if year changes (only for original program flow)
                    if(programSelect.value === originalProgram) {
                        fetchSections();
                    }
                });
            }

            // --- Radio Button Deselection Logic ---
            const radioGroups = document.querySelectorAll('input[name="family_description"]');
            let lastCheckedRadio = null;

            radioGroups.forEach(radio => {
                radio.addEventListener('click', function (e) {
                    if (this === lastCheckedRadio) {
                        this.checked = false;
                        lastCheckedRadio = null;
                    } else {
                        lastCheckedRadio = this;
                    }
                });
            });

            const checked = document.querySelector('input[name="family_description"]:checked');
            if (checked) lastCheckedRadio = checked;
        });
    </script>
</body>
{% endblock %}