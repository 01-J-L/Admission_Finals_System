{% extends 'admin_base.html' %}

{% set is_new = not program %}
{% set form_title = 'Add New Program' if is_new else 'Edit Program: ' + program.title %}

{% block title %}{{ form_title }}{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('auth.admin_manage_content') }}" class="text-gray-500 hover:text-primary">Manage Content</a>
<i class="ri-arrow-right-s-line mx-1 text-gray-400"></i>
<a href="{{ url_for('auth.admin_manage_programs') }}" class="text-gray-500 hover:text-primary">Programs</a>
<i class="ri-arrow-right-s-line mx-1 text-gray-400"></i>
<span>{{ 'Add' if is_new else 'Edit' }}</span>
{% endblock %}

{% block page_title %}{{ form_title }}{% endblock %}

{% block content %}
<form method="POST" enctype="multipart/form-data" class="space-y-8 bg-white p-8 rounded-lg shadow-md">
    
    <!-- Basic Info -->
    <div class="border-b border-gray-200 pb-6">
        <h3 class="text-lg font-semibold leading-6 text-gray-900">Basic Information</h3>
        <div class="mt-4 grid grid-cols-1 gap-x-6 gap-y-4 sm:grid-cols-6">
            
            <div class="sm:col-span-2">
                <label for="program_id" class="block text-sm font-medium leading-6 text-gray-900">Program ID (short code)</label>
                <input type="text" name="program_id" id="program_id" value="{{ program.program_id or '' }}" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm {% if not is_new %}bg-gray-100 cursor-not-allowed{% endif %}"
                       required {% if not is_new %}readonly{% endif %}>
            </div>

            <div class="sm:col-span-4">
                <label for="title" class="block text-sm font-medium leading-6 text-gray-900">Program Title</label>
                <input type="text" name="title" id="title" value="{{ program.title or '' }}" 
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" required>
            </div>

            <!-- NEW: Max Units Input -->
            <div class="sm:col-span-2">
                <label for="max_units" class="block text-sm font-medium leading-6 text-gray-900">Max Units per Semester</label>
                <input type="number" name="max_units" id="max_units" value="{{ program.max_units if program else '26' }}" 
                       min="1" max="50"
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm" required>
                <p class="text-xs text-gray-500 mt-1">Limit for regular enrollment.</p>
            </div>

            <div class="sm:col-span-6">
                <label for="description" class="block text-sm font-medium leading-6 text-gray-900">Short Description</label>
                <textarea name="description" id="description" rows="3" 
                          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm">{{ program.description or '' }}</textarea>
            </div>

            <div class="sm:col-span-6">
                <label for="hero_image" class="block text-sm font-medium leading-6 text-gray-900">Header Image</label>
                {% if program and program.hero_image_filename %}
                <div class="mt-2 mb-2 flex items-center gap-x-3">
                    <img src="{{ url_for('static', filename='images/uploads/' + program.hero_image_filename) }}" class="h-16 w-32 object-cover rounded-md">
                    <span class="text-xs text-gray-500">Current Image. Upload a new one to replace it.</span>
                </div>
                {% endif %}
                <input type="file" name="hero_image" id="hero_image" accept="image/jpeg,image/png,image/webp"
                       class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-primary hover:file:bg-violet-100">
            </div>
        </div>
    </div>

    <!-- Dynamic Sections -->
    <div id="dynamic-sections-container" class="space-y-8">
        <!-- Objectives -->
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900">Objectives</h3>
            <div id="objectives-container" class="mt-4 space-y-3">
                {% for objective in program.objectives or [] %}
                <div class="flex items-center gap-x-3">
                    <input type="text" name="objectives[]" value="{{ objective }}" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700"><i class="ri-delete-bin-line"></i></button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-objective-btn" class="mt-4 text-sm font-semibold text-primary hover:text-primary/80">+ Add Objective</button>
        </div>

        <!-- Career Opportunities -->
        <div class="border-b border-gray-200 pb-6">
            <h3 class="text-lg font-semibold text-gray-900">Career Opportunities</h3>
            <div id="careers-container" class="mt-4 space-y-3">
                {% for career in program.career_opportunities or [] %}
                <div class="flex items-center gap-x-3">
                    <input type="text" name="careers[]" value="{{ career }}" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700"><i class="ri-delete-bin-line"></i></button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-career-btn" class="mt-4 text-sm font-semibold text-primary hover:text-primary/80">+ Add Career Opportunity</button>
        </div>
        
        <!-- Core Courses -->
        <div class="pb-6">
            <h3 class="text-lg font-semibold text-gray-900">Core Courses</h3>
            <div id="courses-container" class="mt-4 space-y-4">
                {% for course in program.core_courses or [] %}
                <div class="course-item grid grid-cols-12 gap-3 p-3 border rounded-md">
                    <input type="text" name="course_codes[]" value="{{ course.course_code or '' }}" placeholder="Course Code" class="col-span-12 sm:col-span-2 rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <input type="text" name="course_names[]" value="{{ course.course_name or '' }}" placeholder="Course Name" class="col-span-10 sm:col-span-4 rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <input type="text" name="course_descs[]" value="{{ course.desc or '' }}" placeholder="Description" class="col-span-10 sm:col-span-5 rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 col-span-2 sm:col-span-1 justify-self-center self-center"><i class="ri-delete-bin-line"></i></button>
                </div>
                {% endfor %}
            </div>
            <button type="button" id="add-course-btn" class="mt-4 text-sm font-semibold text-primary hover:text-primary/80">+ Add Course</button>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end gap-x-6">
        <a href="{{ url_for('auth.admin_manage_programs') }}" class="text-sm font-semibold leading-6 text-gray-900">Cancel</a>
        <button type="submit" class="rounded-md bg-primary px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary">Save Program</button>
    </div>
</form>

<!-- Templates for JS -->
<template id="simple-item-template">
    <div class="flex items-center gap-x-3">
        <input type="text" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
        <button type="button" class="remove-item-btn text-red-500 hover:text-red-700"><i class="ri-delete-bin-line"></i></button>
    </div>
</template>
<template id="course-item-template">
    <div class="course-item grid grid-cols-12 gap-3 p-3 border rounded-md">
        <input type="text" name="course_codes[]" placeholder="Course Code" class="col-span-12 sm:col-span-2 rounded-md border-gray-300 shadow-sm sm:text-sm">
        <input type="text" name="course_names[]" placeholder="Course Name" class="col-span-10 sm:col-span-4 rounded-md border-gray-300 shadow-sm sm:text-sm">
        <input type="text" name="course_descs[]" placeholder="Description" class="col-span-10 sm:col-span-5 rounded-md border-gray-300 shadow-sm sm:text-sm">
        <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 col-span-2 sm:col-span-1 justify-self-center self-center"><i class="ri-delete-bin-line"></i></button>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function () {
    function setupDynamicList(containerId, addButtonId, templateId, inputName) {
        const container = document.getElementById(containerId);
        const addButton = document.getElementById(addButtonId);
        const template = document.getElementById(templateId);

        addButton.addEventListener('click', () => {
            const clone = template.content.cloneNode(true);
            const input = clone.querySelector('input[type="text"]');
            input.name = inputName;
            container.appendChild(clone);
        });

        container.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-btn')) {
                e.target.closest('.flex, .grid').remove();
            }
        });
    }

    setupDynamicList('objectives-container', 'add-objective-btn', 'simple-item-template', 'objectives[]');
    setupDynamicList('careers-container', 'add-career-btn', 'simple-item-template', 'careers[]');

    // Special setup for courses
    const coursesContainer = document.getElementById('courses-container');
    const addCourseButton = document.getElementById('add-course-btn');
    const courseTemplate = document.getElementById('course-item-template');
    
    addCourseButton.addEventListener('click', () => {
        const clone = courseTemplate.content.cloneNode(true);
        coursesContainer.appendChild(clone);
    });

    coursesContainer.addEventListener('click', (e) => {
        if (e.target.closest('.remove-item-btn')) {
            e.target.closest('.course-item').remove();
        }
    });
});
</script>
{% endblock %}