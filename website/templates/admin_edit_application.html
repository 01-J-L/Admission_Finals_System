{% extends 'base.html' %}

{% block style %}
<style>
    /* Styles from new_student.html/edit_application.html, adopted for admin_edit_application.html */
    :where([class^="ri-"])::before { content: "\f3c2"; } 
    body {
        background-color: #f9fafb; /* Light gray background */
    }
    html {
      scroll-behavior: smooth;
    }
    .scale-110 {
        transform: scale(1.1);
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }
    /* Simplified custom checkbox/radio for brevity, assuming Tailwind handles most of it */
    .go-top-btn {
        position: fixed; bottom: 20px; right: 20px; border-radius: 50%; cursor: pointer;
        height: 50px; width: 50px; background: #162938; color: white; border: none; /* Primary color */
        display: none; justify-content: center; align-items: center; z-index: 999;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .go-top-btn i { font-size: 24px; } /* Using Remixicon */
    
    /* Primary color from Tailwind config in admin_dashboard.html: primary:'#4f46e5' */
    .bg-primary { background-color: #4f46e5; }
    .text-primary { color: #4f46e5; }
    .border-primary { border-color: #4f46e5; }
    .hover\:bg-primary\/80:hover { background-color: rgba(79, 70, 229, 0.8); }
    .focus\:ring-primary\/50:focus { ring-color: rgba(79, 70, 229, 0.5); }
    .rounded-button { border-radius: 8px; } /* From Tailwind config */

    .file-download-link {
        color: #4f46e5; /* primary color */
        text-decoration: underline;
        font-weight: 500;
    }
    .file-download-link:hover {
        color: #4338ca; /* darker primary */
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
{% endblock %}

{% block head %}
<link rel="icon" href="{{ url_for('static', filename='logopgpc.png') }}" type="image/x-icon">
<header class="bg-primary text-white py-3 px-6 shadow-md fixed top-0 left-0 w-full z-[1001]">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-xl font-semibold">Admin: Edit Application P2025{{ "%04d" | format(application.applicant_id) }}</h1>
        {% if admin_logged_in %}
        <a href="{{ url_for('auth.admin_dashboard') }}" class="text-sm bg-gray-100 text-primary hover:bg-gray-200 px-4 py-2 rounded-button transition-colors">Back to Dashboard</a>
        {% endif %}
    </div>
</header>
{% endblock %}

{% block body %}
<div class="main-content-area pt-20"> <!-- Adjusted padding top for fixed header -->
  <div class="min-h-screen flex flex-col">
    <main class="flex-grow container mx-auto px-4 py-8">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
          <div class="mb-4 p-4 rounded-md text-sm
            {% if category == 'danger' %} bg-red-100 text-red-700 border border-red-200
            {% elif category == 'success' %} bg-green-100 text-green-700 border border-green-200
            {% elif category == 'warning' %} bg-yellow-100 text-yellow-700 border border-yellow-200
            {% else %} bg-blue-100 text-blue-700 border border-blue-200 {% endif %}"
            role="alert">
            {{ message }}
          </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="max-w-5xl mx-auto bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        Edit Application Data (Admin)
                    </h2>
                    <p class="text-gray-600 mt-1">
                        Modify the applicant's information below. Fields marked with <span class="text-red-500">*</span> are generally required.
                    </p>
                </div>
                <a href="{{ url_for('auth.admin_dashboard') }}" class="text-sm text-primary hover:text-primary/80 flex items-center whitespace-nowrap ml-4 px-4 py-2 rounded-button border border-primary hover:bg-primary/10 transition-colors">
                    <i class="ri-arrow-left-line mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
        
        <div class="px-6 py-4 border-b border-gray-200">
          <div class="flex items-center">
            <div class="flex flex-col items-center flex-1"><div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center relative z-10"><i class="ri-user-line"></i></div><p class="text-sm font-medium text-primary mt-2">Personal Information</p></div>
            <div class="h-1 bg-gray-200 flex-1 relative -mx-2"><div class="absolute inset-0 bg-primary transform origin-left transition-transform duration-300" style="transform: scaleX(0)"></div></div>
            <div class="flex flex-col items-center flex-1"><div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center relative z-10"><i class="ri-team-line"></i></div><p class="text-sm font-medium text-gray-500 mt-2">Family Details</p></div>
            <div class="h-1 bg-gray-200 flex-1 relative -mx-2"><div class="absolute inset-0 bg-primary transform origin-left transition-transform duration-300" style="transform: scaleX(0)"></div></div>
            <div class="flex flex-col items-center flex-1"><div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center relative z-10"><i class="ri-book-open-line"></i></div><p class="text-sm font-medium text-gray-500 mt-2">Educational Background</p></div>
            <div class="h-1 bg-gray-200 flex-1 relative -mx-2"><div class="absolute inset-0 bg-primary transform origin-left transition-transform duration-300" style="transform: scaleX(0)"></div></div>
            <div class="flex flex-col items-center flex-1"><div class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center relative z-10"><i class="ri-check-line"></i></div><p class="text-sm font-medium text-gray-500 mt-2">Review & Update</p></div>
          </div>
        </div>
        
        <form action="{{ url_for('auth.admin_update_application_action', applicant_id=application.applicant_id) }}" method="POST" enctype="multipart/form-data">
        <div class="p-6">
          <div id="step1" class="block">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Personal Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="md:col-span-2">
                <div class="mb-6">
                  <label class="block text-gray-700 font-medium mb-2">Program (Course) <span class="text-red-500">*</span></label>
                  <select
                    name="program_choice"
                    id="program"
                    class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                    required
                  >
                    <option value="">Select a Program</option>
                    <option value="Bachelor of Science in Computer Science" {% if application.program_choice == 'Bachelor of Science in Computer Science' %}selected{% endif %}>Bachelor of Science in Computer Science</option>
                    <option value="Bachelor of Science in Management Accounting" {% if application.program_choice == 'Bachelor of Science in Management Accounting' %}selected{% endif %}>Bachelor of Science in Management Accounting</option>
                    <option value="Bachelor of Public Administration" {% if application.program_choice == 'Bachelor of Public Administration' %}selected{% endif %}>Bachelor of Public Administration</option>
                    <option value="Bachelor of Science in Criminology" {% if application.program_choice == 'Bachelor of Science in Criminology' %}selected{% endif %}>Bachelor of Science in Criminology</option>
                  </select>
                </div>
                <div class="mb-6">
                  <label class="block text-gray-700 font-medium mb-2">Full Name <span class="text-red-500">*</span></label>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Last Name" name="last_name" value="{{ application.last_name | e }}" required /><p class="text-xs text-gray-500 mt-1">Last Name</p></div>
                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="First Name" name="first_name" value="{{ application.first_name | e }}" required /><p class="text-xs text-gray-500 mt-1">First Name</p></div>
                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Middle Name" name="middle_name" value="{{ application.middle_name | default('', true) | e }}" /><p class="text-xs text-gray-500 mt-1">Middle Name (Optional)</p></div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div><label class="block text-gray-700 font-medium mb-2">Date of Birth <span class="text-red-500">*</span></label><input type="date" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" name="date_of_birth" value="{{ application.date_of_birth }}" required /></div>
                  <div><label class="block text-gray-700 font-medium mb-2">Place of Birth <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="City/Municipality" name="place_of_birth" value="{{ application.place_of_birth | e }}" required /></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">Sex <span class="text-red-500">*</span></label>
                    <div class="flex gap-6 mt-2">
                      <div class="flex items-center"><input type="radio" name="sex" value="female" {% if application.sex == 'female' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Female</label></div>
                      <div class="flex items-center"><input type="radio" name="sex" value="male" {% if application.sex == 'male' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Male</label></div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">Civil Status <span class="text-red-500">*</span></label>
                    <div class="flex flex-wrap gap-4 mt-2">
                      <div class="flex items-center"><input type="radio" name="civil_status" value="single" {% if application.civil_status == 'single' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Single</label></div>
                      <div class="flex items-center"><input type="radio" name="civil_status" value="married" {% if application.civil_status == 'married' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Married</label></div>
                      <div class="flex items-center"><input type="radio" name="civil_status" value="widower" {% if application.civil_status == 'widower' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Widower</label></div>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div><label class="block text-gray-700 font-medium mb-2">Religion <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's religion" name="religion" value="{{ application.religion | e }}" required /></div>
                  <div><label class="block text-gray-700 font-medium mb-2">Citizenship <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's citizenship" name="citizenship" value="{{ application.citizenship | e }}" required /></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div><label class="block text-gray-700 font-medium mb-2">Mobile No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's mobile number" name="mobile_number" value="{{ application.mobile_number | e }}" required /></div>
                  <div><label class="block text-gray-700 font-medium mb-2">Email Address <span class="text-red-500">*</span></label><input type="email" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's email address" name="email_address" value="{{ application.email_address | e }}" required /></div>
                </div>
                <div class="mb-6">
                  <label class="block text-gray-700 font-medium mb-2">Permanent Address <span class="text-red-500">*</span></label>
                  <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Street, Barangay" name="permanent_address_street_barangay" value="{{ application.permanent_address_street_barangay | e }}" required />
                  <div class="grid grid-cols-2 gap-4 mt-2">
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="City/Municipality" name="permanent_address_city_municipality" value="{{ application.permanent_address_city_municipality | e }}" required />
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Province" name="permanent_address_province" value="{{ application.permanent_address_province | e }}" required />
                  </div>
                  <div class="mt-2"><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Postal Code" name="permanent_address_postal_code" value="{{ application.permanent_address_postal_code | e }}" required /></div>
                </div>
                <div class="mb-6">
                  <label class="block text-gray-700 font-medium mb-2">Member of Cultural Minority Group? <span class="text-red-500">*</span></label>
                  <div class="flex gap-6 mt-2">
                    <div class="flex items-center"><input type="radio" name="cultural_minority_group" value="No" {% if application.cultural_minority_group == 'No' %}checked{% endif %} required /><label class="ml-2 text-gray-700">No</label></div>
                    <div class="flex items-center"><input type="radio" name="cultural_minority_group" value="Yes" {% if application.cultural_minority_group == 'Yes' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Yes</label></div>
                  </div>
                </div>
                <div class="mb-6">
                  <label class="block text-gray-700 font-medium mb-2">Physical disability or condition? <span class="text-red-500">*</span></label>
                  <div class="flex gap-6 mt-2">
                    <div class="flex items-center"><input type="radio" name="physical_disability" value="No" {% if application.physical_disability == 'No' %}checked{% endif %} required /><label class="ml-2 text-gray-700">No</label></div>
                    <div class="flex items-center"><input type="radio" name="physical_disability" value="Yes" {% if application.physical_disability == 'Yes' %}checked{% endif %} required /><label class="ml-2 text-gray-700">Yes (Specify attached certification)</label></div>
                  </div>
                </div>
              </div>
              <div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                  <div class="flex flex-col items-center justify-center">
                    <div id="photoPreviewContainer" class="w-32 h-32 bg-gray-200 border border-gray-300 rounded flex items-center justify-center mb-2 relative overflow-hidden">
                      <img id="photoPreview" class="w-full h-full object-cover {% if not application.photo %}hidden{% endif %}" src="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) if application.photo else '' }}" alt="Applicant Photo" />
                      <i id="photoPlaceholder" class="ri-user-line text-gray-400 text-4xl {% if application.photo %}hidden{% endif %}"></i>
                    </div>
                    <p class="text-sm text-gray-700 text-center mb-2">Current 2x2 Photo. Upload a new one below to replace it.</p>
                    <input type="file" id="photoInput" name="photo" accept="image/*" class="hidden" />
                    <button type="button" id="uploadPhotoBtn" class="bg-primary text-white px-4 py-2 rounded-button text-sm whitespace-nowrap">Upload New Photo</button>
                    <div id="photoToast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white text-sm z-50 transform transition-transform duration-300 translate-y-full hidden"></div>
                  </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <h4 class="font-medium text-gray-800 mb-2">Application Details</h4>
                  <div class="mb-4"><label class="block text-gray-700 text-sm mb-1">Date of Application <span class="text-red-500">*</span></label><input type="date" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" name="date_of_application" value="{{ application.date_of_application }}" required /></div>
                  <div><label class="block text-gray-700 text-sm mb-1">Academic Year <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" name="academic_year" value="{{ application.academic_year | e }}" required /></div>
                </div>
              </div>
            </div>
            <div class="mt-8 flex justify-end">
              <button type="button" id="nextToStep2" class="bg-primary text-white px-6 py-2 rounded-button font-medium whitespace-nowrap">Next: Family Details</button>
            </div>
          </div>

          <div id="step2" class="hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Family Details</h3>
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Average Family Income (Monthly) <span class="text-red-500">*</span></label>
              <select name="average_family_income" required class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                <option value="">Select income</option>
                <option value="10000_below" {% if application.average_family_income == '10000_below' %}selected{% endif %}>₱10,000 below</option>
                <option value="10001_to_20000" {% if application.average_family_income == '10001_to_20000' %}selected{% endif %}>₱10,001 - 20,000</option>
                <option value="20001_to_30000" {% if application.average_family_income == '20001_to_30000' %}selected{% endif %}>₱20,001 - 30,000</option>
                <option value="30001_to_40000" {% if application.average_family_income == '30001_to_40000' %}selected{% endif %}>₱30,001 - 40,000</option>
                <option value="40001_to_50000" {% if application.average_family_income == '40001_to_50000' %}selected{% endif %}>₱40,001 - 50,000</option>
                <option value="50001_to_100000" {% if application.average_family_income == '50001_to_100000' %}selected{% endif %}>₱50,001 - 100,000</option>
                <option value="100001_above" {% if application.average_family_income == '100001_above' %}selected{% endif %}>₱100,001 above</option>
              </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div>
                <h4 class="font-medium text-gray-800 mb-4">Father's Information</h4>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Father's Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="father_name" value="{{ application.father_name | e }}" required /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="father_occupation" value="{{ application.father_occupation | e }}" required /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="father_company_address" value="{{ application.father_company_address | e }}" required /></div>
                <div><label class="block text-gray-700 text-sm mb-2">Contact No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded" name="father_contact_number" value="{{ application.father_contact_number | e }}" required /></div>
              </div>
              <div>
                <h4 class="font-medium text-gray-800 mb-4">Mother's Information</h4>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Mother's Maiden Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="mother_maiden_name" value="{{ application.mother_maiden_name | e }}" required /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="mother_occupation" value="{{ application.mother_occupation | e }}" required /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="mother_company_address" value="{{ application.mother_company_address | e }}" required /></div>
                <div><label class="block text-gray-700 text-sm mb-2">Contact No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded" name="mother_contact_number" value="{{ application.mother_contact_number | e }}" required /></div>
              </div>
              <div>
                <h4 class="font-medium text-gray-800 mb-4">Guardian's Information (Optional)</h4>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Guardian's Name</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="guardian_name" value="{{ application.guardian_name | default('', true) | e }}" /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="guardian_occupation" value="{{ application.guardian_occupation | default('', true) | e }}" /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="guardian_company_address" value="{{ application.guardian_company_address | default('', true) | e }}" /></div>
                <div><label class="block text-gray-700 text-sm mb-2">Contact No.</label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded" name="guardian_contact_number" value="{{ application.guardian_contact_number | default('', true) | e }}" /></div>
              </div>
            </div>
            <div class="mt-8 flex justify-between">
              <button type="button" id="backToStep1" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-button font-medium whitespace-nowrap">Previous: Personal Information</button>
              <button type="button" id="nextToStep3" class="bg-primary text-white px-6 py-2 rounded-button font-medium whitespace-nowrap">Next: Educational Background</button>
            </div>
          </div>

          <div id="step3" class="hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Educational Background</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <h4 class="font-medium text-gray-800 mb-4">Senior High School</h4>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">SHS Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="senior_high_school" value="{{ application.senior_high_school | e }}" required /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Address (Brgy, City/Town, Province) <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="senior_high_school_address" value="{{ application.senior_high_school_address | e }}" required /></div>
                <div class="mb-4">
                  <label class="block text-gray-700 text-sm mb-2">Strand <span class="text-red-500">*</span></label>
                  <select name="senior_high_school_track_strand" class="w-full px-4 py-2 border border-gray-300 rounded pr-8" required>
                    <option value="">Select strand</option>
                    <option value="STEM" {% if application.senior_high_school_track_strand == 'STEM' %}selected{% endif %}>STEM</option>
                    <option value="ABM" {% if application.senior_high_school_track_strand == 'ABM' %}selected{% endif %}>ABM</option>
                    <option value="HUMSS" {% if application.senior_high_school_track_strand == 'HUMSS' %}selected{% endif %}>HUMSS</option>
                    <option value="GAS" {% if application.senior_high_school_track_strand == 'GAS' %}selected{% endif %}>GAS</option>
                    <option value="TVL" {% if application.senior_high_school_track_strand == 'TVL' %}selected{% endif %}>TVL</option>
                    <option value="SPORTS" {% if application.senior_high_school_track_strand == 'SPORTS' %}selected{% endif %}>Sports</option>
                    <option value="ARTS" {% if application.senior_high_school_track_strand == 'ARTS' %}selected{% endif %}>Arts and Design</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 text-sm mb-2">Inclusive Dates (Year) <span class="text-red-500">*</span></label>
                  <div class="grid grid-cols-2 gap-4">
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" placeholder="From (Year)" name="senior_high_school_year_from" value="{{ application.senior_high_school_year_from | e }}" required />
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" placeholder="To (Year)" name="senior_high_school_year_to" value="{{ application.senior_high_school_year_to | e }}" required />
                  </div>
                </div>
              </div>
              <div>
                <h4 class="font-medium text-gray-800 mb-4">College (if any) / ALS Graduate (Optional)</h4>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">School Name</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="tertiary_school" value="{{ application.tertiary_school | default('', true) | e }}" /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Address</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="tertiary_school_address" value="{{ application.tertiary_school_address | default('', true) | e }}" /></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Program</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" name="tertiary_course" value="{{ application.tertiary_course | default('', true) | e }}" /></div>
                <div>
                  <label class="block text-gray-700 text-sm mb-2">Inclusive Dates (Year)</label>
                  <div class="grid grid-cols-2 gap-4">
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" placeholder="From (Year)" name="tertiary_year_from" value="{{ application.tertiary_year_from | default('', true) | e }}" />
                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded" placeholder="To (Year)" name="tertiary_year_to" value="{{ application.tertiary_year_to | default('', true) | e }}" />
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <h4 class="font-medium text-gray-800 mb-4">Update Required Documents</h4>
                <p class="text-sm text-gray-600 mb-4">Upload new files only if you need to replace the current ones. Max 5MB per file. Accepted: PDF, JPG, PNG.</p>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="shs_diploma_file_input">
                        1. Certified True Copy of Senior High School Diploma
                    </label>
                    {% if application.shs_diploma_filename %}
                    <p class="text-xs text-gray-600 mb-1">Current: 
                        <a href="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type='diploma') }}" target="_blank" class="file-download-link">{{ application.shs_diploma_filename }}</a>
                    </p>
                    {% endif %}
                    <input type="file" id="shs_diploma_file_input" name="shs_diploma_file_input"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           accept=".pdf,.jpg,.jpeg,.png">
                    <p class="text-xs text-gray-500 mt-1">Upload a new file to replace the current one (if any).</p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="shs_card_file_input">
                        2. Original Senior High School Report Card (Form 138)
                    </label>
                     {% if application.shs_card_filename %}
                    <p class="text-xs text-gray-600 mb-1">Current: 
                        <a href="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type='card') }}" target="_blank" class="file-download-link">{{ application.shs_card_filename }}</a>
                    </p>
                    {% endif %}
                    <input type="file" id="shs_card_file_input" name="shs_card_file_input"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           accept=".pdf,.jpg,.jpeg,.png">
                    <p class="text-xs text-gray-500 mt-1">Upload a new file to replace the current one (if any).</p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="birth_certificate_file_input">
                        3. Photocopy of PSA/NSO Birth Certificate
                    </label>
                    {% if application.birth_certificate_filename %}
                    <p class="text-xs text-gray-600 mb-1">Current: 
                        <a href="{{ url_for('auth.get_applicant_document', applicant_id=application.applicant_id, doc_type='birth_cert') }}" target="_blank" class="file-download-link">{{ application.birth_certificate_filename }}</a>
                    </p>
                    {% endif %}
                    <input type="file" id="birth_certificate_file_input" name="birth_certificate_file_input"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           accept=".pdf,.jpg,.jpeg,.png">
                    <p class="text-xs text-gray-500 mt-1">Upload a new file to replace the current one (if any).</p>
                </div>
            </div>

            <div class="mt-8 flex justify-between">
              <button type="button" id="backToStep2From3" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-button font-medium whitespace-nowrap">Previous: Family Details</button>
              <button type="button" id="nextToStep4" class="bg-primary text-white px-6 py-2 rounded-button font-medium whitespace-nowrap">Next: Review & Update</button>
            </div>
          </div>

          <div id="step4" class="hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Review & Update Applicant Data</h3>
            
            <div id="reviewDataContainer" class="mb-6">
                <!-- JS will insert review content here -->
            </div>

            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
              <h4 class="font-medium text-gray-800 mb-4">Consent and Declaration (as submitted by applicant)</h4>
              <div class="mb-6"><h5 class="font-medium text-gray-700 mb-2">CONSENT</h5><p class="text-sm text-gray-600 mb-4">The applicant was made aware that Padre Garcia Polytechnic College is bound by the Data Privacy Act of 2012. Information, including personal data and documents, collected through this application will be treated as confidential and used solely for admission processing, academic, and statistical purposes by the College. It will not be shared with external parties without explicit consent, unless required by law. By submitting the application, the applicant consented to the collection and processing of their data under these terms.</p></div>
              <div><h5 class="font-medium text-gray-700 mb-2">OATH</h5><p class="text-sm text-gray-600">The applicant certified that all information supplied in the application is true, complete, and accurate. Any misinformation or withholding of information will automatically disqualify the applicant or be grounds for dismissal if already admitted. The applicant understood that all documents submitted become part of the College's records and cannot be withdrawn.</p></div>
            </div>
            <div class="flex items-center mb-6">
              <input type="checkbox" name="agreements" value="Yes" id="agreements" {% if application.agreements == 'Yes' %}checked{% endif %} /> <!-- NOT required for admin edit to proceed -->
              <label class="ml-2 text-gray-700">Applicant's Agreement (View/modify if necessary. Original student agreement should be preserved unless there's a specific reason to change).</label>
            </div>
            <div class="grid grid-cols-1 gap-6 mb-6">
              <div>
                <label class="block text-gray-700 text-sm mb-2" for="final_submission_date_input">Final Submission Date (as set by applicant or admin) <span class="text-red-500">*</span></label>
                <input type="date" id="final_submission_date_input" name="final_submission_date" class="w-full px-4 py-2 border border-gray-300 rounded" value="{{ application.final_submission_date }}" required />
              </div>
            </div>
            <div class="mt-8 flex justify-between">
              <button type="button" id="backToStep3From4" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-button font-medium whitespace-nowrap">Previous: Educational Background</button>
              <button id="submitApplicationAdminBtn" class="bg-gray-300 text-white px-6 py-2 rounded-button font-medium whitespace-nowrap cursor-not-allowed" type="submit" disabled>Update Application (Admin)</button>
            </div>
          </div>
        </div>
        </form>
      </div>
    </main>
  </div>
</div>
<button class="go-top-btn" id="goTopBtn" title="Go to top"><i class="ri-arrow-up-s-line"></i></button>

<script>
    const initialApplicationFilenames = {
        photo: "{{ 'photo_on_file.jpg' if application.photo else '' }}", 
        shs_diploma_filename: "{{ application.shs_diploma_filename | default('', true) | e }}",
        shs_card_filename: "{{ application.shs_card_filename | default('', true) | e }}",
        birth_certificate_filename: "{{ application.birth_certificate_filename | default('', true) | e }}"
    };
    const applicantIdForLinks = "{{ application.applicant_id }}";

    document.addEventListener("DOMContentLoaded", function () {
      const requiredFields = document.querySelectorAll(
        "form input[required]:not([type='file']), form select[required], form textarea[required]"
      ); 
      const submitButton = document.getElementById("submitApplicationAdminBtn");
  
      function validateForm() {
        let isValid = true;
        requiredFields.forEach((field) => {
          if (field.type === 'radio' || field.type === 'checkbox') {
            if (field.type === 'radio') { 
                 const radioGroup = document.querySelectorAll(`input[name="${field.name}"][required]`);
                 if (radioGroup.length > 0) { 
                    let oneChecked = false;
                    radioGroup.forEach(radio => { if (radio.checked) oneChecked = true; });
                    if (!oneChecked) isValid = false;
                 }
            }
          } else if (field.required && (!field.value || (typeof field.value === 'string' && !field.value.trim()))) { 
            isValid = false;
          }
        });
        
        if(submitButton){ 
            if (isValid) {
              submitButton.disabled = false;
              submitButton.classList.remove("bg-gray-300", "cursor-not-allowed");
              submitButton.classList.add("bg-primary");
            } else {
              submitButton.disabled = true;
              submitButton.classList.add("bg-gray-300", "cursor-not-allowed");
              submitButton.classList.remove("bg-primary");
            }
        }
      }
  
      requiredFields.forEach((field) => {
        field.addEventListener("input", validateForm);
        if (field.type === 'radio' || field.type === 'checkbox') {
            field.addEventListener("change", validateForm);
        }
      });
      const agreementCheckbox = document.getElementById('agreements');
      if (agreementCheckbox) agreementCheckbox.addEventListener('change', validateForm);
      
      validateForm(); 
    });
  
    document.addEventListener("DOMContentLoaded", function () {
      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const step3 = document.getElementById("step3");
      const step4 = document.getElementById("step4");
      
      const nextToStep2Btn = document.getElementById("nextToStep2");
      const backToStep1Btn = document.getElementById("backToStep1");
      const nextToStep3Btn = document.getElementById("nextToStep3");
      const backToStep2Btn = document.getElementById("backToStep2From3"); 
      const nextToStep4Btn = document.getElementById("nextToStep4");
      const backToStep3Btn = document.getElementById("backToStep3From4"); 

      function collectFormDataForReview() {
        return {
            // Step 1: Personal Information
            program: document.querySelector('select[name="program_choice"]').value,
            lastName: document.querySelector('input[name="last_name"]').value,
            firstName: document.querySelector('input[name="first_name"]').value,
            middleName: document.querySelector('input[name="middle_name"]').value,
            dateOfBirth: document.querySelector('input[name="date_of_birth"]').value,
            placeOfBirth: document.querySelector('input[name="place_of_birth"]').value,
            sex: document.querySelector('input[name="sex"]:checked') ? document.querySelector('input[name="sex"]:checked').value : "",
            civilStatus: document.querySelector('input[name="civil_status"]:checked') ? document.querySelector('input[name="civil_status"]:checked').value : "",
            religion: document.querySelector('input[name="religion"]').value,
            citizenship: document.querySelector('input[name="citizenship"]').value,
            mobileNo: document.querySelector('input[name="mobile_number"]').value,
            email: document.querySelector('input[name="email_address"]').value,
            address: {
                street: document.querySelector('input[name="permanent_address_street_barangay"]').value,
                city: document.querySelector('input[name="permanent_address_city_municipality"]').value,
                province: document.querySelector('input[name="permanent_address_province"]').value,
                postalCode: document.querySelector('input[name="permanent_address_postal_code"]').value,
            },
            culturalMinority: document.querySelector('input[name="cultural_minority_group"]:checked') ? document.querySelector('input[name="cultural_minority_group"]:checked').value : "",
            physicalDisability: document.querySelector('input[name="physical_disability"]:checked') ? document.querySelector('input[name="physical_disability"]:checked').value : "",
            dateOfApplication: document.querySelector('input[name="date_of_application"]').value,
            academicYear: document.querySelector('input[name="academic_year"]').value,

            // Step 2: Family Details
            averageFamilyIncome: document.querySelector('select[name="average_family_income"]').value,
            father: {
                name: document.querySelector('input[name="father_name"]').value,
                occupation: document.querySelector('input[name="father_occupation"]').value,
                company: document.querySelector('input[name="father_company_address"]').value,
                contact: document.querySelector('input[name="father_contact_number"]').value,
            },
            mother: {
                name: document.querySelector('input[name="mother_maiden_name"]').value,
                occupation: document.querySelector('input[name="mother_occupation"]').value,
                company: document.querySelector('input[name="mother_company_address"]').value,
                contact: document.querySelector('input[name="mother_contact_number"]').value,
            },
            guardian: {
                name: document.querySelector('input[name="guardian_name"]').value,
                occupation: document.querySelector('input[name="guardian_occupation"]').value,
                company: document.querySelector('input[name="guardian_company_address"]').value,
                contact: document.querySelector('input[name="guardian_contact_number"]').value,
            },

            // Step 3: Educational Background
            education: {
                shs: {
                    name: document.querySelector('input[name="senior_high_school"]').value,
                    address: document.querySelector('input[name="senior_high_school_address"]').value,
                    strand: document.querySelector('select[name="senior_high_school_track_strand"]').value,
                    yearFrom: document.querySelector('input[name="senior_high_school_year_from"]').value,
                    yearTo: document.querySelector('input[name="senior_high_school_year_to"]').value,
                },
                tertiary: {
                    name: document.querySelector('input[name="tertiary_school"]').value,
                    address: document.querySelector('input[name="tertiary_school_address"]').value,
                    course: document.querySelector('input[name="tertiary_course"]').value,
                    yearFrom: document.querySelector('input[name="tertiary_year_from"]').value,
                    yearTo: document.querySelector('input[name="tertiary_year_to"]').value,
                }
            }
        };
      }

      if(nextToStep2Btn) nextToStep2Btn.addEventListener("click", function (e) { e.preventDefault(); if(step1)step1.classList.add("hidden"); if(step2)step2.classList.remove("hidden"); window.scrollTo(0, 0); updateStepperUI(2); });
      if(backToStep1Btn) backToStep1Btn.addEventListener("click", function (e) { e.preventDefault(); if(step2)step2.classList.add("hidden"); if(step1)step1.classList.remove("hidden"); window.scrollTo(0, 0); updateStepperUI(1); });
      if(nextToStep3Btn) nextToStep3Btn.addEventListener("click", function (e) { e.preventDefault(); if(step2)step2.classList.add("hidden"); if(step3)step3.classList.remove("hidden"); window.scrollTo(0, 0); updateStepperUI(3); });
      if(backToStep2Btn) backToStep2Btn.addEventListener("click", function (e) { e.preventDefault(); if(step3)step3.classList.add("hidden"); if(step2)step2.classList.remove("hidden"); window.scrollTo(0, 0); updateStepperUI(2); });
      
      if(nextToStep4Btn) nextToStep4Btn.addEventListener("click", function (e) {
        e.preventDefault();
        const formData = collectFormDataForReview();
        
        const newPhotoFile = document.getElementById('photoInput').files[0];
        const newDiplomaFile = document.getElementById('shs_diploma_file_input').files[0];
        const newCardFile = document.getElementById('shs_card_file_input').files[0];
        const newBirthCertFile = document.getElementById('birth_certificate_file_input').files[0];

        let photoReview = newPhotoFile ? `New Photo Uploaded: ${newPhotoFile.name}` : (initialApplicationFilenames.photo ? 'Current photo retained' : 'No photo on file');
        let diplomaReview = newDiplomaFile ? `New SHS Diploma Uploaded: ${newDiplomaFile.name}` : (initialApplicationFilenames.shs_diploma_filename ? `Current SHS Diploma retained (<a href="/applicant-document/${applicantIdForLinks}/diploma" target="_blank" class="file-download-link">${initialApplicationFilenames.shs_diploma_filename}</a>)` : 'No SHS Diploma on file');
        let cardReview = newCardFile ? `New SHS Card Uploaded: ${newCardFile.name}` : (initialApplicationFilenames.shs_card_filename ? `Current SHS Card retained (<a href="/applicant-document/${applicantIdForLinks}/card" target="_blank" class="file-download-link">${initialApplicationFilenames.shs_card_filename}</a>)` : 'No SHS Card on file');
        let birthCertReview = newBirthCertFile ? `New Birth Certificate Uploaded: ${newBirthCertFile.name}` : (initialApplicationFilenames.birth_certificate_filename ? `Current Birth Certificate retained (<a href="/applicant-document/${applicantIdForLinks}/birth_cert" target="_blank" class="file-download-link">${initialApplicationFilenames.birth_certificate_filename}</a>)` : 'No Birth Certificate on file');
        
        const incomeText = formData.averageFamilyIncome ? formData.averageFamilyIncome.replace(/_/g, ' ').replace('to', '-').replace('above', ' above').replace('below', ' below') : "Not specified";


        const reviewContent = `
        <div class="space-y-6">
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 class="text-md font-semibold text-gray-700 mb-4">Personal Information</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><p class="text-sm text-gray-600">Program:</p><p class="font-medium">${formData.program || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Full Name:</p><p class="font-medium">${formData.lastName || ""}, ${formData.firstName || ""} ${formData.middleName || ''}</p></div>
                    <div><p class="text-sm text-gray-600">Date of Birth:</p><p class="font-medium">${formData.dateOfBirth || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Place of Birth:</p><p class="font-medium">${formData.placeOfBirth || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Sex:</p><p class="font-medium">${formData.sex || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Civil Status:</p><p class="font-medium">${formData.civilStatus || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Religion:</p><p class="font-medium">${formData.religion || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Citizenship:</p><p class="font-medium">${formData.citizenship || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Mobile No:</p><p class="font-medium">${formData.mobileNo || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Email:</p><p class="font-medium">${formData.email || "Not specified"}</p></div>
                    <div class="sm:col-span-2"><p class="text-sm text-gray-600">Permanent Address:</p><p class="font-medium">${formData.address.street || ""}, ${formData.address.city || ""}, ${formData.address.province || ""} ${formData.address.postalCode || ""}</p></div>
                    <div><p class="text-sm text-gray-600">Cultural Minority Group:</p><p class="font-medium">${formData.culturalMinority || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Physical Disability:</p><p class="font-medium">${formData.physicalDisability || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Date of Application:</p><p class="font-medium">${formData.dateOfApplication || "Not specified"}</p></div>
                    <div><p class="text-sm text-gray-600">Academic Year:</p><p class="font-medium">${formData.academicYear || "Not specified"}</p></div>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 class="text-md font-semibold text-gray-700 mb-4">Family Details</h4>
                 <div><p class="text-sm text-gray-600">Average Family Income (Monthly):</p><p class="font-medium">${incomeText}</p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                    <div>
                        <h5 class="font-medium text-gray-700 mb-2">Father's Information</h5>
                        <p class="text-sm text-gray-600">Name: <span class="font-medium">${formData.father.name || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Occupation: <span class="font-medium">${formData.father.occupation || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Company & Address: <span class="font-medium">${formData.father.company || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Contact No: <span class="font-medium">${formData.father.contact || "Not specified"}</span></p>
                    </div>
                    <div>
                        <h5 class="font-medium text-gray-700 mb-2">Mother's Information</h5>
                        <p class="text-sm text-gray-600">Maiden Name: <span class="font-medium">${formData.mother.name || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Occupation: <span class="font-medium">${formData.mother.occupation || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Company & Address: <span class="font-medium">${formData.mother.company || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Contact No: <span class="font-medium">${formData.mother.contact || "Not specified"}</span></p>
                    </div>
                    <div>
                        <h5 class="font-medium text-gray-700 mb-2">Guardian's Information (Optional)</h5>
                        <p class="text-sm text-gray-600">Name: <span class="font-medium">${formData.guardian.name || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Occupation: <span class="font-medium">${formData.guardian.occupation || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Company & Address: <span class="font-medium">${formData.guardian.company || "Not specified"}</span></p>
                        <p class="text-sm text-gray-600">Contact No: <span class="font-medium">${formData.guardian.contact || "Not specified"}</span></p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 class="text-md font-semibold text-gray-700 mb-4">Educational Background</h4>
                <div>
                    <h5 class="font-medium text-gray-700 mb-2">Senior High School</h5>
                    <p class="text-sm text-gray-600">School Name: <span class="font-medium">${formData.education.shs.name || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Address: <span class="font-medium">${formData.education.shs.address || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Strand: <span class="font-medium">${formData.education.shs.strand || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Year: <span class="font-medium">${formData.education.shs.yearFrom || "N/A"} - ${formData.education.shs.yearTo || "N/A"}</span></p>
                </div>
                <div class="mt-4">
                    <h5 class="font-medium text-gray-700 mb-2">College (if any) / ALS Graduate (Optional)</h5>
                    <p class="text-sm text-gray-600">School Name: <span class="font-medium">${formData.education.tertiary.name || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Address: <span class="font-medium">${formData.education.tertiary.address || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Program: <span class="font-medium">${formData.education.tertiary.course || "Not specified"}</span></p>
                    <p class="text-sm text-gray-600">Year: <span class="font-medium">${formData.education.tertiary.yearFrom || "N/A"} - ${formData.education.tertiary.yearTo || "N/A"}</span></p>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h4 class="text-md font-semibold text-gray-700 mb-3">Document Updates:</h4>
                <p class="text-xs">${photoReview}</p>
                <p class="text-xs">${diplomaReview}</p>
                <p class="text-xs">${cardReview}</p>
                <p class="text-xs">${birthCertReview}</p>
            </div>
        </div>`;
        
        const reviewContainer = document.getElementById("reviewDataContainer");
        if(reviewContainer) reviewContainer.innerHTML = reviewContent;
        
        if(step3)step3.classList.add("hidden"); 
        if(step4)step4.classList.remove("hidden"); 
        window.scrollTo(0, 0); 
        updateStepperUI(4); 
      });

      if(backToStep3Btn) backToStep3Btn.addEventListener("click", function (e) { 
        e.preventDefault(); 
        const reviewContainer = document.getElementById("reviewDataContainer");
        if(reviewContainer) reviewContainer.innerHTML = ""; 
        if(step4)step4.classList.add("hidden"); 
        if(step3)step3.classList.remove("hidden"); 
        window.scrollTo(0, 0); 
        updateStepperUI(3); 
      });
      
      updateStepperUI(1);

      function updateStepperUI(activeStep) {
        const stepperItems = document.querySelectorAll(".px-6.py-4.border-b .flex.items-center > div.flex.flex-col");
        const progressBars = document.querySelectorAll(".px-6.py-4.border-b .h-1.bg-gray-200 > div");
        stepperItems.forEach((item, index) => {
          const stepNumber = index + 1;
          const circle = item.querySelector("div.w-10.h-10");
          const text = item.querySelector("p");
          if(!circle || !text) return;

          if (stepNumber < activeStep) {
            circle.classList.remove("bg-gray-200", "text-gray-500"); circle.classList.add("bg-primary", "text-white");
            text.classList.remove("text-gray-500"); text.classList.add("text-primary");
            if (progressBars[index]) progressBars[index].style.transform = "scaleX(1)";
          } else if (stepNumber === activeStep) {
            circle.classList.remove("bg-gray-200", "text-gray-500"); circle.classList.add("bg-primary", "text-white");
            text.classList.remove("text-gray-500"); text.classList.add("text-primary");
            circle.classList.add("scale-110"); setTimeout(() => circle.classList.remove("scale-110"), 300);
            if (index > 0 && progressBars[index -1]) progressBars[index-1].style.transform = "scaleX(1)";
          } else {
            circle.classList.remove("bg-primary", "text-white", "scale-110"); circle.classList.add("bg-gray-200", "text-gray-500");
            text.classList.remove("text-primary"); text.classList.add("text-gray-500");
            if (progressBars[index - 1]) progressBars[index - 1].style.transform = "scaleX(0)";
          }
        });
      }
    
        const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
        const photoInput = document.getElementById("photoInput");
        const photoPreview = document.getElementById("photoPreview");
        const photoPlaceholder = document.getElementById("photoPlaceholder");
        const photoToast = document.getElementById("photoToast");

        function showToast(message, type = "success") { 
            if(!photoToast) return;
            photoToast.textContent = message;
            photoToast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white text-sm z-50 transform transition-transform duration-300`;
            if (type === "error") photoToast.classList.add("bg-red-500");
            else photoToast.classList.add("bg-green-500");
            photoToast.classList.remove("hidden", "translate-y-full");
            setTimeout(() => {
              photoToast.classList.add("translate-y-full");
              setTimeout(() => photoToast.classList.add("hidden"), 300);
            }, 3000);
        }

        if(uploadPhotoBtn) uploadPhotoBtn.addEventListener('click', function (e) {
            e.preventDefault(); if(photoInput) photoInput.click();
        });

        if(photoInput) photoInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith("image/")) { showToast("⚠️ Please select an image file for photo.", "error"); photoInput.value = ""; return; }
                const MAX_SIZE = 5 * 1024 * 1024; 
                if (file.size > MAX_SIZE) { showToast("⚠️ Photo is too large (max 5MB).", "error"); photoInput.value = ""; return; }
                const reader = new FileReader();
                reader.onload = (event) => {
                    if(photoPreview) { photoPreview.src = event.target.result; photoPreview.classList.remove("hidden"); }
                    if(photoPlaceholder) photoPlaceholder.classList.add("hidden");
                };
                reader.readAsDataURL(file);
                showToast("✅ New photo selected: " + file.name, "success"); 
            }
        });

        const documentInputs = document.querySelectorAll('input[type="file"][name$="_file_input"]'); 
        documentInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                const labelText = input.labels[0] ? input.labels[0].textContent.split('*')[0].trim().replace(/^[\d.]+\s*/, '') : 'Document';
                if (file) {
                    const MAX_DOC_SIZE = 5 * 1024 * 1024; 
                    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const isAllowedExtension = ['pdf', 'jpg', 'jpeg', 'png'].includes(fileExtension);
                    
                    if (!allowedTypes.includes(file.type) && !isAllowedExtension) {
                        showToast(`⚠️ Invalid file type for ${labelText}. Allowed: PDF, JPG, PNG.`, "error");
                        input.value = ""; return;
                    }
                    if (file.size > MAX_DOC_SIZE) {
                        showToast(`⚠️ ${labelText} is too large (max 5MB).`, "error");
                        input.value = ""; return;
                    }
                    showToast(`✅ New file selected for ${labelText}: ${file.name}`, "success");
                }
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const goTopBtn = document.getElementById('goTopBtn');
        if(goTopBtn){
            window.addEventListener('scroll', () => { goTopBtn.style.display = window.scrollY > 200 ? "flex" : "none"; });
            goTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: "smooth" }); });
        }
    });
</script>
{% endblock %}