<!-- --- START OF FILE pending_application.html --- -->

{% extends 'base.html' %}

{% block title %}Application Status{% endblock %}

{% block head %}
{{ super() }}
<link rel="icon" href="{{ url_for('static', filename='logopgpc.png') }}" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.min.css" rel="stylesheet">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<!-- html2pdf Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                primary: '#1e40af', 
                secondary: '#3b82f6',
                pgpc_blue: '#1e40af'
            },
            borderRadius: {
                DEFAULT: '8px',
                'xl': '12px',
                '2xl': '16px'
            }
        }
    }
}
</script>
<style>
    :where([class^="ri-"])::before { content: "\f3c2"; }
    
    /* --- Custom Print Layout Styles --- */
    .permit-layout {
        font-family: Arial, sans-serif;
        color: #000;
        background: #fff;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 10px;
        box-sizing: border-box; /* Ensure padding doesn't add to width */
    }
    .permit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 10px;
    }
    .permit-logo img {
        height: 80px;
        width: auto;
        flex-shrink: 0;
    }
    .permit-title {
        text-align: center;
        font-weight: bold;
        font-size: 14pt;
        text-transform: uppercase;
        flex-grow: 1;
        padding: 0 10px;
    }
    .permit-photo {
        width: 100px;
        height: 100px;
        border: 1px solid #000;
        object-fit: cover;
        flex-shrink: 0; /* Prevent photo from squishing */
    }
    .permit-main-title {
        text-align: center;
        font-weight: bold;
        font-size: 12pt;
        margin-bottom: 5px;
        text-transform: uppercase;
    }
    .permit-table {
        width: 100%;
        border-collapse: collapse;
        border: 2px solid #000;
        font-size: 10pt;
    }
    .permit-table td {
        border: 1px solid #000;
        padding: 5px 8px;
        vertical-align: top;
    }
    .permit-label {
        font-size: 8pt;
        text-transform: uppercase;
        margin-bottom: 2px;
        color: #333;
    }
    .permit-value {
        font-weight: bold;
        font-size: 10pt;
        text-transform: uppercase;
    }
    .permit-footer {
        display: none;
    }

    @media print {
        body, html { background-color: white !important; margin: 0 !important; padding: 0 !important; }
        
        /* Hide UI elements */
        aside, header, .no-print, #sidebar, #sidebar-overlay, .bg-gray-50, .status-card-ui { display: none !important; }
        
        .main-content-wrapper { margin: 0 !important; padding: 0 !important; }
        
        /* Force Modal Content Visibility */
        #permitStubModal { position: static !important; display: block !important; background: white !important; padding: 0 !important; width: 100%; height: auto; }
        .modal-content-wrapper { 
            box-shadow: none !important; 
            max-width: 100% !important; 
            height: auto !important; 
            border: none !important; 
            max-height: none !important; 
            overflow: visible !important;
            display: block !important;
        }
        
        /* HIDE Screen Layout, SHOW Print Layout */
        #screen-permit-layout { display: none !important; }
        #hidden-print-layout { display: block !important; }
        
        /* Hide modal header/footer in print */
        .modal-header-print-hidden, .modal-footer-print-hidden { display: none !important; }

        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    .sidebar-scroll::-webkit-scrollbar { width: 4px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
</style>
{% endblock %}

{% block body %}
<div class="flex h-screen bg-gray-50 overflow-hidden">
    
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex-shrink-0 fixed lg:static inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 sidebar-scroll overflow-y-auto flex flex-col">
        <div class="h-16 flex items-center px-6 border-b border-gray-200">
            <a href="{{ url_for('views.home') }}" class="flex items-center gap-2">
                <img src="{{ url_for('static', filename='logopgpc.png') }}" alt="Logo" class="w-8 h-8 object-contain">
                <span class="text-blue-900 font-['Georgia'] text-lg">PGPC Dashboard</span>
            </a>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <a href="{{ url_for('views.application_status_page') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors bg-blue-50 text-blue-700">
                <i class="ri-dashboard-line text-lg"></i><span>Dashboard</span>
            </a>
            <a href="{{ url_for('views.view_student_statement') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <i class="ri-wallet-3-line text-lg"></i><span>Statement of Account</span>
            </a>
            <a href="{{ url_for('auth.view_student_grades') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <i class="ri-book-read-line text-lg"></i><span>My Grades</span>
            </a>
            <a href="{{ url_for('views.student_resources') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <i class="ri-download-cloud-2-line text-lg"></i><span>Downloads</span>
            </a>
            <a href="{{ url_for('auth.student_messenger') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <i class="ri-messenger-line text-lg"></i><span>Messenger</span>
            </a>
             <a href="{{ url_for('auth.change_password_page') }}" class="flex items-center space-x-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                <i class="ri-lock-password-line text-lg"></i><span>Change Password</span>
            </a>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <a href="{{ url_for('auth.logout') }}" class="flex items-center justify-center space-x-2 px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors border border-red-200 w-full">
                <i class="ri-logout-box-line"></i><span>Sign Out</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col min-w-0 main-content-wrapper">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between shadow-sm z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle" class="lg:hidden text-gray-500 hover:text-blue-600">
                    <i class="ri-menu-2-line text-2xl"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-800">Dashboard</h2>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-3 pl-4 border-l border-gray-200">
                    <div class="text-right hidden sm:block">
                        <div class="text-sm font-bold text-gray-800">{{ application.first_name }} {{ application.last_name }}</div>
                        <div class="text-xs text-gray-500">{{ application.program_choice }}</div>
                    </div>
                    <img src="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) }}?t={{ application.last_updated_at.timestamp() if application.last_updated_at else '' }}"
                         onerror="this.src='{{ url_for('static', filename='images/default_avatar.png') }}'"
                         alt="Avatar" class="w-9 h-9 rounded-full object-cover border border-gray-300">
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                
                {% if application %}
                {% set status = application.application_status %}

                <!-- Welcome Banner -->
                <div class="bg-white rounded-xl p-6 mb-8 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center justify-between gap-4 status-card-ui">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Welcome, {{ application.first_name }}!</h1>
                        <p class="text-gray-600 mt-1">Academic Year: <span class="font-semibold text-blue-600">{{ active_term.year_name if active_term else '2025-2026' }}</span></p>
                    </div>
                    <div class="text-left md:text-right w-full md:w-auto bg-gray-50 md:bg-transparent p-3 md:p-0 rounded-lg">
                        <p class="text-xs text-gray-400 uppercase font-bold">Student ID</p>
                        <p class="text-lg font-mono font-bold text-gray-800 break-all">
                            {% if application.old_student_id %}{{ application.old_student_id }}
                            {% elif application.control_number %}{{ application.control_number }}
                            {% else %}P{{ application.academic_year[:4] if application.academic_year else '2025' }}{{ "%04d" | format(application.applicant_id) }}
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 status-card-ui">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        
                        <!-- Progress Tracker -->
                        {% set hide_tracker = status in ['Rejected', 'Failed', 'Enrolling', 'Enrolled', 'Dropped', 'Not Enrolled', 'Eligible for Enrollment'] %}
                        {% if not hide_tracker %}
                            {% set current_step = 1 %}
                            {% if status == 'Approved' %}{% set current_step = 2 %}{% endif %}
                            {% if status == 'Scheduled' %}{% set current_step = 3 %}{% endif %}
                            {% if status == 'Passed' %}{% set current_step = 4 %}{% endif %}
                            
                            <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm border border-gray-200">
                                <h3 class="text-xs sm:text-sm font-bold text-gray-500 uppercase tracking-wider mb-6">Application Progress</h3>
                                <div class="relative px-2 sm:px-4">
                                    <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -translate-y-1/2 rounded -z-10"></div>
                                    <div class="absolute top-1/2 left-0 h-1 bg-blue-600 -translate-y-1/2 rounded -z-10 transition-all duration-500" style="width: {{ ((current_step - 1) / 3 * 100) }}%;"></div>
                                    <div class="flex justify-between w-full">
                                        {% for step in range(1, 5) %}
                                        <div class="flex flex-col items-center bg-white px-1 sm:px-2">
                                            <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-full flex items-center justify-center font-bold text-xs sm:text-sm border-2 transition-all duration-300 {{ 'bg-blue-600 border-blue-600 text-white' if current_step >= step else 'bg-white border-gray-300 text-gray-400' }}">
                                                {% if current_step > step %}<i class="ri-check-line"></i>{% else %}{{ step }}{% endif %}
                                            </div>
                                            <span class="mt-2 text-[9px] sm:text-[10px] uppercase font-bold {{ 'text-blue-700' if current_step >= step else 'text-gray-400' }}">
                                                {% if step == 1 %}Submitted{% elif step == 2 %}Approved{% elif step == 3 %}Exam{% else %}Passed{% endif %}
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Main Status Card -->
                        {% set status_config = {
                            'Pending': {'color': 'yellow', 'icon': 'ri-time-line', 'title': 'Pending Review', 'bg': 'bg-yellow-50', 'text': 'text-yellow-700', 'border': 'border-yellow-200'},
                            'In Review': {'color': 'blue', 'icon': 'ri-file-search-line', 'title': 'In Review', 'bg': 'bg-blue-50', 'text': 'text-blue-700', 'border': 'border-blue-200'},
                            'Approved': {'color': 'emerald', 'icon': 'ri-checkbox-circle-line', 'title': 'Approved', 'bg': 'bg-emerald-50', 'text': 'text-emerald-700', 'border': 'border-emerald-200'},
                            'Scheduled': {'color': 'indigo', 'icon': 'ri-calendar-check-line', 'title': 'Exam Scheduled', 'bg': 'bg-indigo-50', 'text': 'text-indigo-700', 'border': 'border-indigo-200'},
                            'Rejected': {'color': 'red', 'icon': 'ri-close-circle-line', 'title': 'Rejected', 'bg': 'bg-red-50', 'text': 'text-red-700', 'border': 'border-red-200'},
                            'Passed': {'color': 'teal', 'icon': 'ri-shield-check-line', 'title': 'Passed', 'bg': 'bg-teal-50', 'text': 'text-teal-700', 'border': 'border-teal-200'},
                            'Failed': {'color': 'orange', 'icon': 'ri-shield-cross-line', 'title': 'Failed', 'bg': 'bg-orange-50', 'text': 'text-orange-700', 'border': 'border-orange-200'},
                            'Eligible for Enrollment': {'color': 'purple', 'icon': 'ri-calendar-event-line', 'title': 'Eligible for Enrollment', 'bg': 'bg-purple-50', 'text': 'text-purple-700', 'border': 'border-purple-200'},
                            'Enrolling': {'color': 'blue', 'icon': 'ri-loader-4-line', 'title': 'Enrollment in Progress', 'bg': 'bg-blue-50', 'text': 'text-blue-700', 'border': 'border-blue-200'},
                            'Enrolled': {'color': 'green', 'icon': 'ri-school-line', 'title': 'Enrolled', 'bg': 'bg-green-50', 'text': 'text-green-700', 'border': 'border-green-200'},
                            'Dropped': {'color': 'gray', 'icon': 'ri-user-unfollow-line', 'title': 'Dropped', 'bg': 'bg-gray-100', 'text': 'text-gray-700', 'border': 'border-gray-300'},
                            'Not Enrolled': {'color': 'red', 'icon': 'ri-error-warning-line', 'title': 'Not Enrolled', 'bg': 'bg-red-50', 'text': 'text-red-700', 'border': 'border-red-200'},
                        } %}
                        {% set current = status_config.get(status, {'color': 'gray', 'icon': 'ri-question-mark', 'title': status, 'bg': 'bg-gray-50', 'text': 'text-gray-700', 'border': 'border-gray-200'}) %}

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <div class="p-6 border-b border-gray-100 flex items-center gap-4">
                                <div class="w-12 h-12 {{ current.bg }} {{ current.text }} rounded-full flex items-center justify-center text-2xl">
                                    <i class="{{ current.icon }}"></i>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-gray-900">{{ current.title }}</h2>
                                    <p class="text-sm text-gray-500">Last Updated: {{ application.last_updated_at.strftime('%B %d, %Y') if application.last_updated_at else 'N/A' }}</p>
                                </div>
                            </div>
                            
                            <div class="p-6">
                                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-700 border border-gray-200 leading-relaxed mb-6">
                                    <p class="font-bold text-gray-900 mb-2">Message:</p>
                                    {% if status == 'Pending' %}{{ global_content.status_msg_pending | safe }}
                                    {% elif status == 'In Review' %}{{ global_content.status_msg_review | safe }}
                                    {% elif status == 'Approved' %}{{ global_content.status_msg_approved | safe }}
                                    {% elif status == 'Scheduled' %}{{ global_content.status_msg_scheduled | safe }}
                                    {% elif status == 'Rejected' %}{{ global_content.status_msg_rejected | safe }}
                                    {% elif status == 'Passed' %}{{ global_content.status_msg_passed | safe }}
                                    {% elif status == 'Failed' %}{{ global_content.status_msg_failed | safe }}
                                    {% elif status == 'Enrolling' %}{{ global_content.status_msg_enrolling | safe }}
                                    {% elif status == 'Enrolled' %}{{ global_content.status_msg_enrolled | safe }}
                                    {% elif status == 'Dropped' %}{{ global_content.status_msg_dropped | safe }}
                                    {% elif status == 'Not Enrolled' %}{{ global_content.status_msg_not_enrolled | safe }}
                                    {% elif status == 'Eligible for Enrollment' %}{{ global_content.status_msg_enrolling | safe }}
                                    {% else %}Please check your email or contact the registrar.{% endif %}
                                </div>

                                <!-- Requirements -->
                                {% set req_key = 'status_msg_' ~ status.lower().replace(' ', '_') %}
                                {% if status == 'Eligible for Enrollment' %}{% set req_key = 'status_msg_enrolling' %}{% endif %}
                                
                                {% if global_requirements[req_key] %}
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">{{ global_content.requirements_header_text or 'Requirements' }}</h4>
                                    <ul class="space-y-2 mb-6">
                                        {% for req in global_requirements[req_key] %}
                                        <li class="flex items-start gap-2 text-sm text-gray-700">
                                            <i class="ri-checkbox-circle-fill text-blue-600 mt-0.5"></i>
                                            <span>{{ req.requirement_text }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                                
                                <!-- Action Buttons -->
                                <div class="flex flex-wrap gap-3">
                                    {% if status == 'Eligible for Enrollment' %}
                                    <form action="{{ url_for('auth.student_initiate_enrollment') }}" method="POST">
                                        <button type="submit" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm">
                                            <span>Proceed to Enrollment</span> <i class="ri-arrow-right-line"></i>
                                        </button>
                                    </form>
                                    {% endif %}

                                    {% if status in ['Approved', 'Scheduled'] %}
                                    <button id="viewPermitBtn" class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-indigo-700 transition-colors shadow-sm flex items-center gap-2">
                                        <i class="ri-ticket-line"></i> View Exam Permit
                                    </button>
                                    {% endif %}

                                    {% if status == 'Passed' %}
                                    <a href="{{ url_for('auth.enrollment_form_page', applicant_id=application.applicant_id) }}" class="bg-green-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-green-700 transition-colors shadow-sm flex items-center gap-2">
                                        <i class="ri-file-edit-line"></i> Complete Enrollment Form
                                    </a>
                                    <button id="viewPassedConfirmationBtn" class="bg-white border border-gray-300 text-gray-700 px-5 py-2.5 rounded-lg font-medium hover:bg-gray-50 transition-colors shadow-sm flex items-center gap-2">
                                        <i class="ri-printer-line"></i> Print Result
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Admin Notes -->
                        {% if application.admin_notes %}
                        <div class="bg-yellow-50 rounded-xl p-4 border border-yellow-200 flex gap-3">
                            <i class="ri-sticky-note-fill text-yellow-600 text-xl"></i>
                            <div>
                                <h4 class="font-bold text-yellow-800 text-sm uppercase">Note from Admin</h4>
                                <p class="text-yellow-900 text-sm mt-1 whitespace-pre-wrap">{{ application.admin_notes }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Contact Card -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                            <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide mb-4 pb-2 border-b border-gray-100">
                                {{ global_content.sidebar_contact_title or 'Contact Admissions' }}
                            </h3>
                            <ul class="space-y-4 text-sm">
                                <li class="flex gap-3">
                                    <i class="ri-phone-fill text-blue-600 text-lg"></i>
                                    <div>
                                        <p class="font-semibold text-gray-800">Phone</p>
                                        <a href="tel:{{ global_content.contact_phone }}" class="text-gray-600 hover:text-blue-600">{{ global_content.contact_phone }}</a>
                                    </div>
                                </li>
                                <li class="flex gap-3">
                                    <i class="ri-mail-fill text-blue-600 text-lg"></i>
                                    <div>
                                        <p class="font-semibold text-gray-800">Email</p>
                                        <a href="mailto:{{ global_content.sidebar_email_value }}" class="text-gray-600 hover:text-blue-600 break-all">{{ global_content.sidebar_email_value }}</a>
                                    </div>
                                </li>
                                <li class="flex gap-3">
                                    <i class="ri-time-fill text-blue-600 text-lg"></i>
                                    <div>
                                        <p class="font-semibold text-gray-800">Hours</p>
                                        <p class="text-gray-600">{{ global_content.sidebar_hours_value }}</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 1. PERMIT MODAL (UPDATED LAYOUT - RESPONSIVE & FIXED HEADER) -->
                <div id="permitStubModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4 overflow-y-auto">
                    <!-- Modal Wrapper: Flex Column + Max Height -->
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh] modal-content-wrapper">
                         
                         <!-- Modal Header: Sticky Logic Removed (Uses Flexbox order now) -->
                         <div class="flex justify-between items-center p-4 sm:p-5 border-b border-gray-200 no-print flex-shrink-0 bg-white rounded-t-xl modal-header-print-hidden">
                            <h3 class="text-lg font-bold text-gray-900">Admission Test Permit</h3>
                            <button id="closePermitStubModalBtn" class="text-gray-500 hover:text-gray-800 p-2 rounded hover:bg-gray-100"><i class="ri-close-line text-2xl"></i></button>
                        </div>
                        
                        <!-- Printable Content Area: Scrollable -->
                        <div id="printable-content" class="p-4 sm:p-8 overflow-y-auto flex-1">
                             {% if application %}
                             <!-- A. ON-SCREEN LAYOUT (Modern Dashed Card - Responsive) -->
                             <div id="screen-permit-layout" class="border-2 border-dashed border-gray-300 p-4 sm:p-8 rounded-xl bg-white relative">
                                <div class="flex flex-col sm:flex-row justify-between items-start mb-6 sm:mb-8 gap-4 sm:gap-0">
                                    <div>
                                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">APPLICATION NO.</p>
                                        <p class="text-xl sm:text-2xl font-bold text-gray-900 font-mono">{{ application.old_student_id or application.control_number or 'N/A' }}</p>
                                    </div>
                                    <div class="text-left sm:text-right">
                                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">EXAM DATE</p>
                                        <p class="text-lg sm:text-xl font-bold text-gray-900">{{ application.permit_exam_date.strftime('%B %d, %Y') if application.permit_exam_date else 'TBA' }}</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
                                     <div>
                                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">TIME</p>
                                        <p class="text-lg font-bold text-gray-900">{{ application.permit_exam_time or 'TBA' }}</p>
                                     </div>
                                     <div>
                                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">ROOM</p>
                                        <p class="text-lg font-bold text-gray-900">{{ application.permit_testing_room or 'TBA' }}</p>
                                     </div>
                                </div>

                                <div class="border-t border-gray-100 pt-6 flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-5 text-center sm:text-left">
                                     <img src="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) }}" class="w-20 h-20 sm:w-16 sm:h-16 rounded-lg object-cover border border-gray-200">
                                     <div>
                                         <h4 class="text-lg sm:text-lg font-black text-gray-900 uppercase leading-tight">{{ application.last_name }}, {{ application.first_name }}</h4>
                                         <p class="text-sm text-gray-600 font-medium mt-1 sm:mt-0">{{ application.program_choice }}</p>
                                     </div>
                                </div>
                            </div>

                            <!-- B. HIDDEN PRINT LAYOUT (Formal Table - Matches 1st Screenshot) -->
                             <div id="hidden-print-layout" class="hidden">
                                 <div class="permit-layout">
                                    <div class="permit-header">
                                        <div class="permit-logo">
                                            <img src="{{ url_for('static', filename='logopgpc.png') }}" alt="PGPC Logo">
                                        </div>
                                        <div class="permit-title">OFFICE OF ADMISSIONS</div>
                                        <img src="{{ url_for('auth.get_applicant_photo', applicant_id=application.applicant_id) }}" class="permit-photo" alt="Photo">
                                    </div>

                                    <div class="permit-main-title">ADMISSION TEST PERMIT</div>

                                    <table class="permit-table">
                                        <tr>
                                            <td width="33%">
                                                <div class="permit-label">DATE OF APPLICATION:</div>
                                                <div class="permit-value">
                                                    {{ application.submitted_at.strftime('%B %d, %Y') if application.submitted_at else (application.date_of_application.strftime('%B %d, %Y') if application.date_of_application else 'N/A') }}
                                                </div>
                                            </td>
                                            <td width="33%">
                                                <div class="permit-label">SCHEDULE OF TEST AND TIME:</div>
                                                <div class="permit-value">
                                                    {{ application.permit_exam_date.strftime('%B %d, %Y') if application.permit_exam_date else 'TBA' }}
                                                    <br>
                                                    {{ application.permit_exam_time or 'TBA' }}
                                                    <br>
                                                    <!-- Explicitly showing Room here as requested -->
                                                    ROOM: {{ application.permit_testing_room or 'TBA' }}
                                                </div>
                                            </td>
                                            <td width="33%">
                                                <div class="permit-label">APPLICATION NO.:</div>
                                                <div class="permit-value">{{ application.old_student_id or application.control_number or 'N/A' }}</div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="permit-label">LAST NAME:</div>
                                                <div class="permit-value">{{ application.last_name | upper }}</div>
                                            </td>
                                            <td>
                                                <div class="permit-label">FIRST NAME:</div>
                                                <div class="permit-value">{{ application.first_name | upper }}</div>
                                            </td>
                                            <td>
                                                <div class="permit-label">MIDDLE NAME:</div>
                                                <div class="permit-value">{{ application.middle_name | upper if application.middle_name else '' }}</div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                <div class="permit-label">COURSE APPLIED FOR:</div>
                                                <div class="permit-value">{{ application.program_choice | upper }}</div>
                                            </td>
                                        </tr>
                                    </table>

                                    <!-- Footer Instructions REMOVED as requested -->
                                 </div>
                             </div>
                             {% endif %}
                        </div>

                        <!-- Modal Footer -->
                        <div class="p-4 border-t border-gray-200 flex justify-end no-print bg-gray-50 rounded-b-xl flex-shrink-0 modal-footer-print-hidden">
                            <button id="printPermitBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-blue-700 w-full sm:w-auto shadow-sm">Print Permit</button>
                            <button id="downloadPermitBtn" class="ml-2 bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 w-full sm:w-auto shadow-sm">Download PDF</button>
                        </div>
                    </div>
                </div>

                <!-- 2. PASSED CONFIRMATION MODAL -->
                <div id="passedConfirmationModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex items-center justify-center p-4">
                     <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                        <div class="flex justify-between items-center p-5 border-b border-gray-200 no-print">
                            <h3 class="text-lg font-bold text-gray-900">Application Result</h3>
                            <button id="closePassedModalBtn" class="text-gray-500 hover:text-gray-800"><i class="ri-close-line text-2xl"></i></button>
                        </div>
                        <div id="printable-content-passed" class="p-8 text-center">
                            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="ri-trophy-line text-4xl"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-green-700 mb-2">Congratulations!</h2>
                            <p class="text-gray-600">You have passed the admission requirements for <strong>{{ application.program_choice }}</strong>.</p>
                        </div>
                        <div class="p-4 border-t border-gray-200 flex justify-end no-print">
                            <button id="printPassedBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Print</button>
                        </div>
                     </div>
                </div>

                {% else %}
                <div class="bg-white rounded-xl shadow-sm p-12 text-center border border-gray-200">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                        <i class="ri-folder-add-line text-3xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2">No Application Found</h2>
                    <p class="text-gray-500 mb-6">Start your journey with us today.</p>
                    <a href="{{ url_for('views.new_student') }}" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        Start Application
                    </a>
                </div>
                {% endif %}
                
            </div>
        </main>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
        }

        const openModal = (modal) => {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };
        const closeModal = (modal) => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        const permitModal = document.getElementById('permitStubModal');
        const passedModal = document.getElementById('passedConfirmationModal');

        document.getElementById('viewPermitBtn')?.addEventListener('click', () => openModal(permitModal));
        document.getElementById('closePermitStubModalBtn')?.addEventListener('click', () => closeModal(permitModal));

        document.getElementById('viewPassedConfirmationBtn')?.addEventListener('click', () => openModal(passedModal));
        document.getElementById('closePassedModalBtn')?.addEventListener('click', () => closeModal(passedModal));

        // Enhanced Printing Function
        const printContent = (modalId) => {
            let content;
            // logic to choose content
            if (modalId === 'permitStubModal') {
                // For permit, grab the HIDDEN formal layout
                const hiddenEl = document.getElementById('hidden-print-layout');
                content = hiddenEl ? hiddenEl.innerHTML : '';
            } else {
                // For passed modal, grab the standard printable area
                const visibleEl = document.getElementById('printable-content-passed');
                content = visibleEl ? visibleEl.innerHTML : '';
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print</title>');
            // Add CSS directly to print window
            printWindow.document.write(`
                <style>
                    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                    .permit-layout { width: 100%; max-width: 800px; margin: 0 auto; display: block !important; }
                    .permit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
                    .permit-logo img { height: 80px; }
                    .permit-title { text-align: center; font-weight: bold; font-size: 14pt; flex-grow: 1; }
                    .permit-photo { width: 100px; height: 100px; border: 1px solid #000; object-fit: cover; }
                    .permit-main-title { text-align: center; font-weight: bold; font-size: 12pt; margin-bottom: 5px; text-transform: uppercase; }
                    .permit-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 10pt; }
                    .permit-table td { border: 1px solid #000; padding: 5px 8px; vertical-align: top; }
                    .permit-label { font-size: 8pt; text-transform: uppercase; margin-bottom: 2px; }
                    .permit-value { font-weight: bold; font-size: 10pt; text-transform: uppercase; }
                    .permit-footer { display: none; }
                    ul { list-style-type: none; padding-left: 10px; margin: 0; }
                    /* Passed Message Styles */
                    .text-center { text-align: center; }
                    .font-bold { font-weight: bold; }
                    .text-2xl { font-size: 1.5rem; }
                    .mb-4 { margin-bottom: 1rem; }
                    .text-green-700 { color: #15803d; }
                </style>
            `);
            printWindow.document.write('</head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
        };

        document.getElementById('printPermitBtn')?.addEventListener('click', () => printContent('permitStubModal'));
        document.getElementById('printPassedBtn')?.addEventListener('click', () => printContent('passedConfirmationModal'));
        
        // PDF Download logic
        document.getElementById('downloadPermitBtn')?.addEventListener('click', function () {
            // 1. Get the content
            const element = document.getElementById('hidden-print-layout');
    
            // 2. Options for html2pdf
            const opt = {
                margin:       [0.5, 0.5, 0.5, 0.5], // Top, Left, Bottom, Right
                filename:     'Admission_Permit.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true, // Important for images
                    scrollY: 0 
                },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
    
            // 3. Clone and styling
            const clone = element.cloneNode(true);
            clone.classList.remove('hidden');
            clone.style.display = 'block';
            // Set specific width that fits within Letter (8.5") minus margins (1") = 7.5" ~ 720px
            clone.style.width = '700px'; 
            clone.style.margin = '0 auto';
            clone.style.backgroundColor = 'white';

            // Append to body temporarily to render
            document.body.appendChild(clone);
    
            // 4. Generate
            html2pdf().set(opt).from(clone).save().then(() => {
                document.body.removeChild(clone); // Cleanup
            });
        });
    });
</script>
{% endblock %}