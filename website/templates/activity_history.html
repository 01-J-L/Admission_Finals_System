<!-- --- START OF FILE templates/activity_history.html --- -->

{% extends base_template %}
{% block title %}Activity History{% endblock %}
{% block page_title %}Activity History{% endblock %}

{% block content %}
<div class="bg-white rounded-card shadow-sm p-4 sm:p-6 border border-gray-100">
    
    <!-- Web Controls -->
    <div class="no-print flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center mb-6">
        <div>
            <h3 class="text-lg font-semibold text-gray-900">Payment Activity Log</h3>
            <p class="text-sm text-gray-500">
                {% if view_all %}
                    Showing <strong>All Archived</strong> Records
                {% else %}
                    Showing <strong>Latest 100</strong> Records
                {% endif %}
            </p>
        </div>
        <div class="flex w-full sm:w-auto items-center gap-2">
            <!-- View Toggle Button -->
            {% if not view_all %}
                <a href="{{ url_for('auth.activity_history', view_all='true') }}" class="flex-1 sm:flex-none justify-center flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-button text-sm font-medium hover:bg-blue-100 transition-colors border border-blue-200">
                    <i class="ri-archive-line"></i><span>View All Archives</span>
                </a>
            {% else %}
                <a href="{{ url_for('auth.activity_history') }}" class="flex-1 sm:flex-none justify-center flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-button text-sm font-medium hover:bg-gray-200 transition-colors">
                    <i class="ri-history-line"></i><span>Show Latest Only</span>
                </a>
            {% endif %}

            <a href="{{ url_for('auth.export_activity_excel') }}" class="flex-1 sm:flex-none justify-center flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-button text-sm font-medium hover:bg-green-700 transition-colors">
                <i class="ri-file-excel-2-line"></i><span>Export</span>
            </a>
            <button onclick="window.print()" class="flex-1 sm:flex-none justify-center flex items-center gap-2 bg-gray-600 text-white px-4 py-2 rounded-button text-sm font-medium hover:bg-gray-700 transition-colors">
                <i class="ri-printer-line"></i><span>Print</span>
            </button>
        </div>
    </div>

    <!-- ... (PRINT HEADER & FILTER FORM remain the same) ... -->
    <!-- KEEP THE FILTER FORM CODE FROM PREVIOUS VERSION HERE -->
    <!-- FILTER FORM -->
    <form method="GET" action="{{ url_for('auth.activity_history') }}" class="no-print grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 mb-6 items-end bg-gray-50 p-4 rounded-lg border border-gray-200">
        
        <!-- Preserve view mode when filtering -->
        {% if view_all %}
        <input type="hidden" name="view_all" value="true">
        {% endif %}

        <select name="school_year" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
            <option value="">All School Years</option>
            {% for year in all_school_years %}
            <option value="{{ year.year_name }}" {% if school_year==year.year_name %}selected{% endif %}>{{ year.year_name }}</option>
            {% endfor %}
        </select>

        <select name="semester" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
            <option value="">All Semesters</option>
            <option value="1st Semester" {% if semester_filter=='1st Semester' %}selected{% endif %}>1st Semester</option>
            <option value="2nd Semester" {% if semester_filter=='2nd Semester' %}selected{% endif %}>2nd Semester</option>
            <option value="Summer" {% if semester_filter=='Summer' %}selected{% endif %}>Summer</option>
        </select>

        <select name="course" id="courseSelect" onchange="updateSections()" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
            <option value="">All Courses</option>
            <option value="Bachelor of Science in Computer Science" {% if course_filter=='Bachelor of Science in Computer Science' %}selected{% endif %}>BSCS</option>
            <option value="Bachelor of Science in Criminology" {% if course_filter=='Bachelor of Science in Criminology' %}selected{% endif %}>BSCrim</option>
            <option value="Bachelor of Science in Public Administration" {% if course_filter=='Bachelor of Science in Public Administration' %}selected{% endif %}>BSPA</option>
            <option value="Bachelor of Science in Management Accountancy" {% if course_filter=='Bachelor of Science in Management Accountancy' %}selected{% endif %}>BSMA</option>
        </select>

        <select name="year_level" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
            <option value="">All Years</option>
            <option value="1st Year" {% if year_level=='1st Year' %}selected{% endif %}>1st Year</option>
            <option value="2nd Year" {% if year_level=='2nd Year' %}selected{% endif %}>2nd Year</option>
            <option value="3rd Year" {% if year_level=='3rd Year' %}selected{% endif %}>3rd Year</option>
            <option value="4th Year" {% if year_level=='4th Year' %}selected{% endif %}>4th Year</option>
        </select>

        <select name="section" id="sectionSelect" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
            <option value="">All Sections</option>
            <!-- Populated by JS -->
        </select>

        <!-- Date Range -->
        <div class="sm:col-span-1 lg:col-span-1">
            <label class="block text-xs text-gray-500 mb-1">Start Date</label>
            <input type="date" name="start_date" value="{{ start_date or '' }}" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
        </div>

        <div class="sm:col-span-1 lg:col-span-1">
            <label class="block text-xs text-gray-500 mb-1">End Date</label>
            <input type="date" name="end_date" value="{{ end_date or '' }}" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
        </div>

        <div class="sm:col-span-2 lg:col-span-1">
             <label class="block text-xs text-gray-500 mb-1">Remark</label>
            <select name="remark" class="w-full bg-white border border-gray-300 text-sm rounded-lg p-2.5 focus:ring-primary focus:border-primary">
                <option value="">All Remarks</option>
                <option value="Down Payment" {% if remark_filter=='Down Payment' %}selected{% endif %}>Down Payment</option>
                <option value="Prelim" {% if remark_filter=='Prelim' %}selected{% endif %}>Prelim</option>
                <option value="Midterm" {% if remark_filter=='Midterm' %}selected{% endif %}>Midterm</option>
                <option value="Finals" {% if remark_filter=='Finals' %}selected{% endif %}>Finals</option>
            </select>
        </div>

        <div class="flex gap-2 col-span-1 sm:col-span-2 lg:col-span-2 mt-2">
            <button type="submit" class="flex-1 bg-primary text-white p-2.5 rounded-lg font-medium hover:bg-primary-dark transition-colors"><i class="ri-filter-3-line"></i> Filter</button>
            <a href="{{ url_for('auth.clear_filters') }}" class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors" title="Clear Filters"><i class="ri-refresh-line"></i></a>
        </div>
    </form>

    <!-- Table -->
    <div class="overflow-x-auto border rounded-lg">
        <table class="w-full text-sm text-left text-gray-600 min-w-[900px]">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                <tr>
                    <th class="px-4 py-3">Date</th>
                    <th class="px-4 py-3">Student Name</th>
                    <th class="px-4 py-3">Amount</th>
                    <th class="px-4 py-3">Type</th>
                    <th class="px-4 py-3">Course & Sec</th>
                    <th class="px-4 py-3">Semester</th>
                    <th class="px-4 py-3">Remark</th>
                    <th class="px-4 py-3">Cashier</th>
                </tr>
            </thead>
            <tbody>
                {% for record in history %}
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">{{ record.payment_date.strftime('%m/%d/%Y') }}</td>
                    <td class="px-4 py-3 font-medium text-gray-900">{{ record.student.last_name }}, {{ record.student.first_name }}</td>
                    <td class="px-4 py-3 font-bold text-green-600">â‚±{{ "{:,.2f}".format(record.amount_paid) }}</td>
                    <td class="px-4 py-3">{{ record.type or 'Cash' }}</td>
                    <td class="px-4 py-3">{{ record.student.course }} ({{ record.student.section }})</td>
                    <td class="px-4 py-3">{{ record.student.semester }}</td>
                    <td class="px-4 py-3">{{ record.remark }}</td>
                    <td class="px-4 py-3">{{ record.cashier_username }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-4 text-gray-500">No records found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if has_more and not view_all %}
    <div class="mt-4 text-center">
        <p class="text-sm text-gray-500 mb-2">There are older records not shown.</p>
        <a href="{{ url_for('auth.activity_history', view_all='true') }}" class="inline-flex items-center gap-2 text-primary hover:underline font-medium text-sm">
            Load Full Archive <i class="ri-arrow-right-line"></i>
        </a>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Include your existing updateSections script here
    const sectionMap = {
        "Bachelor of Science in Computer Science": ["A", "B", "C"],
        "Bachelor of Science in Criminology": ["A", "B", "C", "D", "E"],
        "Bachelor of Science in Public Administration": ["A", "B"],
        "Bachelor of Science in Management Accountancy": ["A", "B", "C"]
    };

    function updateSections() {
        const courseSelect = document.getElementById("courseSelect");
        const sectionSelect = document.getElementById("sectionSelect");
        const selectedCourse = courseSelect.value;
        const currentSection = "{{ section_filter }}"; 

        sectionSelect.innerHTML = '<option value="">All Sections</option>';

        if (selectedCourse && sectionMap[selectedCourse]) {
            sectionSelect.disabled = false;
            sectionMap[selectedCourse].forEach(section => {
                const option = document.createElement("option");
                option.value = section;
                option.text = "Section " + section;
                if (section === currentSection) option.selected = true;
                sectionSelect.appendChild(option);
            });
        } else if (selectedCourse) {
             ["A", "B", "C", "D", "E", "1", "2", "3"].forEach(section => {
                const option = document.createElement("option");
                option.value = section;
                option.text = "Section " + section;
                 if (section === currentSection) option.selected = true;
                sectionSelect.appendChild(option);
            });
        } else {
            sectionSelect.disabled = true;
        }
    }
    document.addEventListener('DOMContentLoaded', function() { updateSections(); });
</script>
{% endblock %}