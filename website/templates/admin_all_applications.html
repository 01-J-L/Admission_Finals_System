{% extends "admin_base.html" %}

{% block title %}All Applications{% endblock %}
{% block page_title %}All Applications{% endblock %}
{% block breadcrumb %}All Applications{% endblock %}

{% block content %}
<div id="applicationsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100"
    data-page-context="{{ active_page }}">
    
    <!-- Fixed Header Layout -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 id="mainPageTitle" class="text-xl font-semibold text-gray-800">{{ page_title }}</h3>
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('auth.admin_export_applications_list', export_type='all') }}"
                class="px-4 py-2 bg-green-600 text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-green-700 transition-colors">
                <i class="ri-file-excel-2-line mr-2"></i>Export Excel
            </a>
            <button id="printReportBtn"
                class="px-4 py-2 bg-primary text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-primary/90 transition-colors">
                <i class="ri-printer-line mr-2"></i>Print Report
            </button>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="bg-gray-50 p-4 rounded shadow-inner border border-gray-200 mb-6 filter-bar">
        <!-- Changed grid columns to fit the new Sort dropdown -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-x-4 gap-y-4 items-end">
            
            <!-- School Year Filter -->
            <div class="col-span-1">
                <label for="schoolYearFilter" class="text-sm font-medium text-gray-700">School Year:</label>
                <select id="schoolYearFilter"
                    class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="">All Years</option>
                    {% for sy in all_school_years %}
                    <option value="{{ sy.year_name }}" {% if selected_school_year==sy.year_name %}selected{% endif %}>{{
                        sy.year_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Program Filter -->
            <div class="col-span-1">
                <label for="programFilter" class="text-sm font-medium text-gray-700">Program:</label>
                <select id="programFilter" name="programFilter"
                    class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="all">All Programs</option>
                    {% for program in programs %}
                    <option value="{{ program.title }}">{{ program.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- NEW: Sort By Dropdown -->
            <div class="col-span-1">
                <label for="sortBy" class="text-sm font-medium text-gray-700">Sort By:</label>
                <select id="sortBy" class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="date_desc">Date (Newest First)</option>
                    <option value="date_asc">Date (Oldest First)</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="id_asc">ID Number (Ascending)</option>
                    <option value="id_desc">ID Number (Descending)</option>
                </select>
            </div>

            <!-- Date Filters -->
            <div class="col-span-1 md:col-span-2 lg:col-span-2">
                <span id="dateFilterLabel" class="text-sm font-medium text-gray-700 mb-2 block">Filter by Submission Date:</span>
                <div class="flex items-center space-x-2">
                    <div class="flex-1">
                        <input type="date" id="startDateFilter" name="startDateFilter"
                            class="w-full px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary" placeholder="From">
                    </div>
                    <div class="flex-1">
                        <input type="date" id="endDateFilter" name="endDateFilter"
                            class="w-full px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary" placeholder="To">
                    </div>
                </div>
            </div>

            <!-- Gender & Location (Row 2) -->
            <div class="col-span-1 md:col-span-2 flex flex-wrap gap-4 mt-2">
                <div>
                    <label class="text-xs font-medium text-gray-700 block mb-1">Gender:</label>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="All" checked class="mr-1"> All</label>
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="Male" class="mr-1"> Male</label>
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="Female" class="mr-1"> Female</label>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-700 block mb-1">Location:</label>
                    <div class="flex items-center space-x-2">
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="All" checked class="mr-1"> All</label>
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="Garciano" class="mr-1"> Garciano</label>
                        <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="Non-Garciano" class="mr-1"> Non-Garciano</label>
                    </div>
                </div>
            </div>

            <!-- Clear Button -->
            <div class="col-span-1 lg:col-start-5 justify-self-end">
                <button id="clearFiltersBtn"
                    class="w-full px-4 py-1.5 bg-gray-200 text-gray-700 rounded text-sm font-medium !rounded-button hover:bg-gray-300 flex items-center justify-center">
                    <i class="ri-filter-off-line mr-1"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="overflow-x-auto custom-scrollbar">
        <table class="min-w-full divide-y divide-gray-200" id="applicationsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ID
                    </th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Applicant
                    </th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                        Program
                    </th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                        Submission Date
                    </th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider no-print">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if applications %}
                {% for app in applications %}
                {% set display_id = app.old_student_id or app.control_number or ('App #' ~ app.applicant_id) %}
                <tr class="hover:bg-gray-50" data-applicant-id="{{ app.applicant_id }}"
                    data-gender="{{ app.sex or '' }}"
                    data-submission-date="{{ (app.submitted_at or app.date_of_application).strftime('%Y-%m-%d') if (app.submitted_at or app.date_of_application) else '' }}"
                    data-program="{{ app.program_choice }}" 
                    data-address="{{ app.permanent_address_city_municipality | lower | e if app.permanent_address_city_municipality else '' }}"
                    data-old-student-id="{{ app.old_student_id or '' }}"
                    data-control-number="{{ app.control_number or '' }}" 
                    data-display-id="{{ display_id }}"
                    data-search-string="{{ [
                        app.first_name, app.last_name, 'p2025' ~ '%04d'|format(app.applicant_id), app.old_student_id, app.control_number
                    ] | join(' ') | lower | e }}">

                    <!-- ID Column (Index 0) -->
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 font-medium sort-id">
                        {{ display_id }}
                    </td>
                    <!-- Name Column (Index 1) -->
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                                <span class="text-sm font-medium">{{ app.first_name[0] if app.first_name else 'N' }}{{ app.last_name[0] if app.last_name else 'A' }}</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900 applicant-name">
                                    {{ app.last_name | title }}, {{ app.first_name | title }}
                                </p>
                                <p class="text-xs sm:text-sm text-gray-500 applicant-email">{{ app.student_account_email or app.email_address or 'N/A' }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 applicant-program hidden sm:table-cell">
                        {{ app.program_choice or 'N/A' }}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 submission-date-cell hidden md:table-cell">
                        {{ app.submitted_at.strftime('%b %d, %Y %I:%M %p') if app.submitted_at else
                        (app.date_of_application.strftime('%b %d, %Y') if app.date_of_application else 'N/A') }}
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap status-cell">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge bg-gray-100 text-gray-800">
                            {{ app.application_status }}
                        </span>
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-500 text-right no-print">
                        <!-- Actions (unchanged) -->
                        <div class="flex space-x-1 justify-end items-center">
                            <a href="{{ url_for('auth.admin_view_application_page', applicant_id=app.applicant_id) }}" class="text-gray-500 hover:text-blue-600 p-0.5 sm:p-1" title="View"><i class="ri-external-link-line ri-lg"></i></a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No applications found.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Initialize Existing Filters
        const searchInput = document.getElementById('searchInput'); // Ensure this exists in base/header
        const startDateFilter = document.getElementById('startDateFilter');
        const endDateFilter = document.getElementById('endDateFilter');
        const programFilter = document.getElementById('programFilter');
        const genderFilters = document.querySelectorAll('input[name="genderFilter"]');
        const locationFilters = document.querySelectorAll('input[name="locationFilter"]');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const schoolYearFilter = document.getElementById('schoolYearFilter');
        
        // 2. New Sorting Logic
        const sortSelect = document.getElementById('sortBy');

        if (sortSelect) {
            sortSelect.addEventListener('change', function() {
                sortApplications(this.value);
            });
        }

        function sortApplications(sortValue) {
            const tbody = document.querySelector('#applicationsTable tbody');
            // Get all rows that have data (exclude 'no results' messages)
            const rows = Array.from(tbody.querySelectorAll('tr[data-applicant-id]'));

            rows.sort((a, b) => {
                let valA, valB;

                if (sortValue.includes('name')) {
                    // Sort by Last Name (extracted from .applicant-name)
                    valA = a.querySelector('.applicant-name').textContent.trim().toLowerCase();
                    valB = b.querySelector('.applicant-name').textContent.trim().toLowerCase();
                } else if (sortValue.includes('id')) {
                    // Sort by ID (Column Index 0)
                    valA = a.querySelector('.sort-id').textContent.trim().toLowerCase();
                    valB = b.querySelector('.sort-id').textContent.trim().toLowerCase();
                } else if (sortValue.includes('date')) {
                    // Sort by Submission Date (Data attribute is ISO format YYYY-MM-DD)
                    valA = a.dataset.submissionDate || '';
                    valB = b.dataset.submissionDate || '';
                }

                if (valA < valB) return sortValue.endsWith('asc') ? -1 : 1;
                if (valA > valB) return sortValue.endsWith('asc') ? 1 : -1;
                return 0;
            });

            // Re-append rows in new order
            rows.forEach(row => tbody.appendChild(row));
        }

        // 3. Existing Filtering Logic
        if (schoolYearFilter) {
            schoolYearFilter.addEventListener('change', () => {
                const selectedYear = schoolYearFilter.value;
                const currentUrl = new URL(window.location.href);
                if (selectedYear) { currentUrl.searchParams.set('sy', selectedYear); } 
                else { currentUrl.searchParams.delete('sy'); }
                window.location.href = currentUrl.toString();
            });
        }

        function applyAllFilters() {
            const tableRows = document.querySelectorAll('#applicationsTable tbody tr[data-applicant-id]');
            if (!tableRows || tableRows.length === 0) return;

            // Get Filter Values (Safely)
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const startDate = startDateFilter ? startDateFilter.value : '';
            const endDate = endDateFilter ? endDateFilter.value : '';
            const program = programFilter ? programFilter.value : 'all';
            const gender = document.querySelector('input[name="genderFilter"]:checked')?.value || 'All';
            const location = document.querySelector('input[name="locationFilter"]:checked')?.value || 'All';
            
            let visibleCount = 0;
            const tableBody = document.querySelector('#applicationsTable tbody');

            tableRows.forEach(row => {
                // 1. Search Match
                const searchMatch = (
                    (row.dataset.searchString || '').toLowerCase().includes(searchTerm) ||
                    (row.querySelector('.applicant-name')?.textContent.toLowerCase() || '').includes(searchTerm)
                );

                // 2. Date Match
                let dateMatch = true;
                if (startDate || endDate) {
                     const subDate = row.dataset.submissionDate;
                     if (!subDate) dateMatch = false;
                     else {
                        if (startDate && subDate < startDate) dateMatch = false;
                        if (endDate && subDate > endDate) dateMatch = false;
                     }
                }

                // 3. Program Match
                let programMatch = true;
                if (program && program !== 'all') {
                    if (row.dataset.program !== program) programMatch = false;
                }

                // 4. Gender Match
                let genderMatch = true;
                if (gender && gender !== 'All') {
                     if ((row.dataset.gender || '').toLowerCase() !== gender.toLowerCase()) genderMatch = false;
                }

                // 5. Location Match
                let locationMatch = true;
                if (location && location !== 'All') {
                    const address = row.dataset.address || '';
                    const isGarciano = address.includes('padre garcia');
                    if (location === 'Garciano' && !isGarciano) locationMatch = false;
                    else if (location === 'Non-Garciano' && isGarciano) locationMatch = false;
                }

                if (searchMatch && dateMatch && programMatch && genderMatch && locationMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Handle No Results
            let noResultsRow = tableBody.querySelector('.no-results-message');
            if (noResultsRow) noResultsRow.remove();
            if (visibleCount === 0) {
                const colspan = tableBody.parentElement.querySelector('thead th').length;
                const newRow = tableBody.insertRow();
                newRow.className = 'no-results-message';
                newRow.innerHTML = `<td colspan="${colspan}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No applications match the current filters.</td>`;
            }
        }

        // Event Listeners for Filters
        if (searchInput) searchInput.addEventListener('input', applyAllFilters);
        if (startDateFilter) startDateFilter.addEventListener('change', applyAllFilters);
        if (endDateFilter) endDateFilter.addEventListener('change', applyAllFilters);
        if (programFilter) programFilter.addEventListener('change', applyAllFilters);
        genderFilters.forEach(r => r.addEventListener('change', applyAllFilters));
        locationFilters.forEach(r => r.addEventListener('change', applyAllFilters));

        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                if (searchInput) searchInput.value = '';
                if (startDateFilter) startDateFilter.value = '';
                if (endDateFilter) endDateFilter.value = '';
                if (programFilter) programFilter.value = 'all';
                if (document.getElementById('genderFilterAll')) document.getElementById('genderFilterAll').checked = true;
                if (document.getElementById('locationFilterAll')) document.getElementById('locationFilterAll').checked = true;
                if (sortSelect) sortSelect.value = 'date_desc'; // Reset sort
                
                applyAllFilters();
                sortApplications('date_desc'); // Re-sort default
            });
        }
    });
</script>
{% endblock %}