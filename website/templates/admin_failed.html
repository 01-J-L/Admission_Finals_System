{% extends "admin_base.html" %}

{% block title %}Failed Applications{% endblock %}
{% block page_title %}Failed Applications{% endblock %}
{% block breadcrumb %}Failed Applications{% endblock %}

{% block content %}
<div id="applicationsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100"
    data-page-context="{{ active_page }}">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 id="mainPageTitle" class="text-xl font-semibold text-gray-800">{{ page_title }}</h3>
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('auth.admin_export_applications_list', export_type='failed') }}"
                class="px-4 py-2 bg-green-600 text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-green-700 transition-colors">
                <i class="ri-file-excel-2-line mr-2"></i>Export Excel
            </a>
            <button id="printReportBtn"
                class="px-4 py-2 bg-primary text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-primary/90 transition-colors">
                <i class="ri-printer-line mr-2"></i>Print Report
            </button>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="bg-gray-50 p-4 rounded shadow-inner border border-gray-200 mb-6 filter-bar">
         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-x-6 gap-y-4 items-end">
            <!-- Sort Dropdown -->
            <div class="col-span-1">
                <label for="sortBy" class="text-sm font-medium text-gray-700">Sort By:</label>
                <select id="sortBy" class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="date_desc">Date (Newest First)</option>
                    <option value="date_asc">Date (Oldest First)</option>
                    <option value="name_asc">Name (A-Z)</option>
                    <option value="name_desc">Name (Z-A)</option>
                    <option value="id_asc">ID Number (Ascending)</option>
                    <option value="id_desc">ID Number (Descending)</option>
                </select>
            </div>

            <div class="col-span-1 md:col-span-2 lg:col-span-2">
                <span id="dateFilterLabel" class="text-sm font-medium text-gray-700 mb-2 block">Filter by Submission Date:</span>
                <div class="flex items-center space-x-4">
                    <div class="flex-1"><input type="date" id="startDateFilter" class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary"></div>
                    <div class="flex-1"><input type="date" id="endDateFilter" class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary"></div>
                </div>
            </div>
            <div class="col-span-1">
                <label for="programFilter" class="text-sm font-medium text-gray-700">Program:</label>
                <select id="programFilter" class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="all">All Programs</option>
                    {% for program in programs %}
                    <option value="{{ program.title }}">{{ program.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-span-1 justify-self-end">
                <button id="clearFiltersBtn" class="w-full px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm font-medium !rounded-button hover:bg-gray-300 flex items-center justify-center">
                    <i class="ri-filter-off-line mr-1"></i> Reset
                </button>
            </div>

            <!-- Gender & Location -->
             <div class="col-span-1 md:col-span-5 flex flex-wrap gap-6 mt-2">
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-gray-700">Gender:</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="All" checked class="mr-1"> All</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="Male" class="mr-1"> Male</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="genderFilter" value="Female" class="mr-1"> Female</label>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-gray-700">Location:</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="All" checked class="mr-1"> All</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="Garciano" class="mr-1"> Garciano</label>
                    <label class="flex items-center text-xs text-gray-600"><input type="radio" name="locationFilter" value="Non-Garciano" class="mr-1"> Non-Garciano</label>
                </div>
            </div>
        </div>
    </div>

    <div id="bulkActions" class="bulk-actions bg-blue-50 p-3 rounded-md border border-blue-200 mb-6 flex-wrap items-center gap-y-2">
        <span id="selectedCount" class="text-sm font-medium text-blue-700 mr-4">0 items selected</span>
        <div class="flex flex-wrap gap-2">
            <button id="bulkPendingBtn" class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-yellow-200"><i class="ri-time-line mr-1"></i> Set Pending</button>
        </div>
        <button id="closeBulkActions" class="ml-auto text-gray-500 hover:text-gray-700 p-1"><i class="ri-close-line ri-lg"></i></button>
    </div>

    <div class="overflow-x-auto custom-scrollbar">
        <table class="min-w-full divide-y divide-gray-200" id="applicationsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><label class="custom-checkbox"><input type="checkbox" id="selectAll"><span class="checkmark"></span></label></th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicant</th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Program</th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Submission Date</th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if applications %}
                {% for app in applications %}
                {% set display_id = app.old_student_id or app.control_number or ('App #' ~ app.applicant_id) %}
                <tr class="hover:bg-gray-50" data-applicant-id="{{ app.applicant_id }}"
                    data-gender="{{ app.sex or '' }}"
                    data-submission-date="{{ (app.submitted_at or app.date_of_application).strftime('%Y-%m-%d') if (app.submitted_at or app.date_of_application) else '' }}"
                    data-program="{{ app.program_choice }}"
                    data-address="{{ app.permanent_address_city_municipality | lower | e if app.permanent_address_city_municipality else '' }}"
                    data-old-student-id="{{ app.old_student_id or '' }}"
                    data-control-number="{{ app.control_number or '' }}" 
                    data-display-id="{{ display_id }}"
                    data-search-string="{{ [
                'p2025' ~ '%04d'|format(app.applicant_id),
                app.first_name, app.last_name, app.student_account_email, app.email_address,
                app.mobile_number, app.senior_high_school, app.enrollment_student_type, app.old_student_id
            ] | join(' ') | lower | e }}">
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap"><label class="custom-checkbox"><input type="checkbox" class="row-checkbox" data-id="{{ app.applicant_id }}"><span class="checkmark"></span></label></td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 font-medium sort-id">{{ display_id }}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0"><span class="text-sm font-medium">{{ app.first_name[0] if app.first_name else 'N' }}{{ app.last_name[0] if app.last_name else 'A' }}</span></div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900 applicant-name">{{ app.last_name | title }}, {{ app.first_name | title }}</p>
                                <p class="text-xs sm:text-sm text-gray-500 applicant-email">{{ app.student_account_email or app.email_address or 'N/A' }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 applicant-program hidden sm:table-cell">{{ app.program_choice or 'N/A' }}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 submission-date-cell hidden md:table-cell">{{ app.submitted_at.strftime('%b %d, %Y %I:%M %p') if app.submitted_at else (app.date_of_application.strftime('%b %d, %Y') if app.date_of_application else 'N/A') }}</td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap status-cell"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge bg-orange-100 text-orange-800">Failed</span></td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                        <div class="flex space-x-1 justify-end items-center">
                            <a href="{{ url_for('auth.admin_view_application_page', applicant_id=app.applicant_id) }}" class="text-gray-500 hover:text-blue-600 p-0.5 sm:p-1" title="View"><i class="ri-external-link-line ri-lg"></i></a>
                            <a href="{{ url_for('auth.admin_print_application_form', applicant_id=app.applicant_id) }}" target="_blank" class="text-gray-500 hover:text-green-500 p-0.5 sm:p-1 action-print" title="Print Form"><i class="ri-printer-line ri-lg"></i></a>
                            <button class="text-gray-500 hover:text-yellow-600 p-0.5 sm:p-1 action-admin-notes" title="Admin Notes" data-id="{{ app.applicant_id }}"><i class="ri-sticky-note-line ri-lg"></i></button>
                            <button class="text-gray-500 hover:text-teal-600 p-0.5 sm:p-1 action-permit-details" title="Permit Details" data-id="{{ app.applicant_id }}"><i class="ri-ticket-line ri-lg"></i></button>
                            <div class="dropdown relative action-status-dropdown">
                                <button class="text-gray-500 hover:text-primary p-0.5 sm:p-1" title="Change Status"><i class="ri-arrow-down-s-fill ri-lg"></i></button>
                                <div class="dropdown-content w-36 text-left">
                                    <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Pending">Set Pending</a>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No failed applications found.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sortSelect = document.getElementById('sortBy');
        if (sortSelect) {
            sortSelect.addEventListener('change', function() {
                sortApplications(this.value);
            });
        }
        function sortApplications(sortValue) {
            const tbody = document.querySelector('#applicationsTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr[data-applicant-id]'));
            rows.sort((a, b) => {
                let valA, valB;
                if (sortValue.includes('name')) {
                    valA = a.querySelector('.applicant-name').textContent.trim().toLowerCase();
                    valB = b.querySelector('.applicant-name').textContent.trim().toLowerCase();
                } else if (sortValue.includes('id')) {
                    valA = a.querySelector('.sort-id').textContent.trim().toLowerCase();
                    valB = b.querySelector('.sort-id').textContent.trim().toLowerCase();
                } else if (sortValue.includes('date')) {
                    valA = a.dataset.submissionDate || '';
                    valB = b.dataset.submissionDate || '';
                }
                if (valA < valB) return sortValue.endsWith('asc') ? -1 : 1;
                if (valA > valB) return sortValue.endsWith('asc') ? 1 : -1;
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
        }
    });
</script>
{% endblock %}