{% extends "admin_base.html" %}

{% block title %}Passed Applications{% endblock %}
{% block page_title %}Passed Applications{% endblock %}
{% block breadcrumb %}Passed Applications{% endblock %}

{% block content %}
<div id="applicationsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100"
    data-page-context="{{ active_page }}">
    
    <!-- Fixed Header Layout -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h3 id="mainPageTitle" class="text-xl font-semibold text-gray-800">{{ page_title }}</h3>
        <div class="flex flex-wrap gap-2">
            <a href="{{ url_for('auth.admin_export_applications_list', export_type='passed') }}"
                class="px-4 py-2 bg-green-600 text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-green-700 transition-colors">
                <i class="ri-file-excel-2-line mr-2"></i>Export Excel
            </a>
            <button id="printReportBtn"
                class="px-4 py-2 bg-primary text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-primary/90 transition-colors">
                <i class="ri-printer-line mr-2"></i>Print Report
            </button>
        </div>
    </div>

    {% if session.user_role == 'admin' %}
    <!-- Filter Controls (Same as others) -->
    <div class="bg-gray-50 p-4 rounded shadow-inner border border-gray-200 mb-6 filter-bar">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4 items-end">
            <!-- Date Filters -->
            <div class="col-span-1 md:col-span-2 lg:col-span-2">
                <span id="dateFilterLabel" class="text-sm font-medium text-gray-700 mb-2 block">Filter by Submission
                    Date:</span>
                <div class="flex items-center space-x-4">
                    <div class="flex-1"><label for="startDateFilter" class="text-xs text-gray-600">From:</label><input
                            type="date" id="startDateFilter" name="startDateFilter"
                            class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    </div>
                    <div class="flex-1"><label for="endDateFilter" class="text-xs text-gray-600">To:</label><input
                            type="date" id="endDateFilter" name="endDateFilter"
                            class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    </div>
                </div>
            </div>

            <!-- Program Filter -->
            <div class="col-span-1">
                <label for="programFilter" class="text-sm font-medium text-gray-700">Program:</label>
                <select id="programFilter" name="programFilter"
                    class="w-full mt-1 px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary">
                    <option value="all">All Programs</option>
                    {% for program in programs %}
                    <option value="{{ program.title | lower }}">{{ program.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Gender Filter -->
            <div class="col-span-1">
                <label class="text-sm font-medium text-gray-700 block mb-2">Gender:</label>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center"><input type="radio" id="genderFilterAll" name="genderFilter"
                            value="All" checked><label for="genderFilterAll"
                            class="text-sm text-gray-600 ml-1">All</label></div>
                    <div class="flex items-center"><input type="radio" id="genderFilterMale" name="genderFilter"
                            value="Male"><label for="genderFilterMale" class="text-sm text-gray-600 ml-1">Male</label>
                    </div>
                    <div class="flex items-center"><input type="radio" id="genderFilterFemale" name="genderFilter"
                            value="Female"><label for="genderFilterFemale"
                            class="text-sm text-gray-600 ml-1">Female</label></div>
                </div>
            </div>

            <!-- Location Filter -->
            <div class="col-span-1">
                <label class="text-sm font-medium text-gray-700 block mb-2">Location:</label>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center"><input type="radio" id="locationFilterAll" name="locationFilter"
                            value="All" checked><label for="locationFilterAll"
                            class="text-sm text-gray-600 ml-1">All</label></div>
                    <div class="flex items-center"><input type="radio" id="locationFilterGarciano" name="locationFilter"
                            value="Garciano"><label for="locationFilterGarciano"
                            class="text-sm text-gray-600 ml-1">Garciano</label></div>
                    <div class="flex items-center"><input type="radio" id="locationFilterNonGarciano"
                            name="locationFilter" value="Non-Garciano"><label for="locationFilterNonGarciano"
                            class="text-sm text-gray-600 ml-1">Non-Garciano</label></div>
                </div>
            </div>

            <!-- Clear Button -->
            <div class="col-span-1 flex items-end">
                <button id="clearFiltersBtn"
                    class="w-full px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm font-medium !rounded-button hover:bg-gray-300 flex items-center justify-center">
                    <i class="ri-filter-off-line mr-1"></i> Clear All Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Action Bar -->
    <div id="bulkActions"
        class="bulk-actions bg-blue-50 p-3 rounded-md border border-blue-200 mb-6 flex-wrap items-center gap-y-2">
        <span id="selectedCount" class="text-sm font-medium text-blue-700 mr-4">0 items selected</span>
        <div class="flex flex-wrap gap-2">
            <button id="bulkPendingBtn"
                class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-yellow-200"><i
                    class="ri-time-line mr-1"></i> Set Pending</button>

        </div>
        <button id="closeBulkActions" class="ml-auto text-gray-500 hover:text-gray-700 p-1"><i
                class="ri-close-line ri-lg"></i></button>
    </div>
    {% endif %}

    <!-- Applications Table -->
    <div class="overflow-x-auto custom-scrollbar">
        <table class="min-w-full divide-y divide-gray-200" id="applicationsTable">
            <thead class="bg-gray-50">
                <tr>
                    {% if session.user_role == 'admin' %}
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <label class="custom-checkbox"><input type="checkbox" id="selectAll"><span
                                class="checkmark"></span></label>
                    </th>
                    {% endif %}
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ID</th>
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Applicant</th>
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                        Program</th>
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                        Submission Date</th>
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status</th>
                    <th scope="col"
                        class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if applications %}
                {% for app in applications %}
                {% set display_id = app.old_student_id or app.control_number or ('App #' ~ app.applicant_id) %}
                <tr class="hover:bg-gray-50" data-applicant-id="{{ app.applicant_id }}"
                    data-gender="{{ app.sex or '' }}"
                    data-submission-date="{{ (app.submitted_at or app.date_of_application).strftime('%Y-%m-%d') if (app.submitted_at or app.date_of_application) else '' }}"
                    data-program="{{ app.program_choice }}" data-program-id="{{ app.program_id | default('N/A') }}"
                    data-address="{{ app.permanent_address_city_municipality | lower | e if app.permanent_address_city_municipality else '' }}"
                    data-year-level="{{ app.enrollment_year_level }}" data-semester="{{ app.enrollment_semester }}"
                    data-student-type="{{ app.enrollment_student_type }}"
                    data-old-student-id="{{ app.old_student_id or '' }}"
                    data-control-number="{{ app.control_number or '' }}" data-display-id="{{ display_id }}"
                    data-search-string="{{ [
                'p2025' ~ '%04d'|format(app.applicant_id),
                app.first_name, app.last_name, app.student_account_email, app.email_address,
                app.mobile_number, app.senior_high_school, app.enrollment_student_type, app.old_student_id
            ] | join(' ') | lower | e }}">
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                        <label class="custom-checkbox"><input type="checkbox" class="row-checkbox"
                                data-id="{{ app.applicant_id }}"><span class="checkmark"></span></label>
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                        {{ display_id }}
                    </td>

                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div
                                class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                                <span class="text-sm font-medium">{{ app.first_name[0] if app.first_name else 'N' }}{{
                                    app.last_name[0] if app.last_name else 'A' }}</span>
                            </div>
                            <div class="ml-3">
                                <!-- MODIFIED: Name Format -->
                                <p class="text-sm font-medium text-gray-900 applicant-name">
                                    {{ app.last_name | title }}, {{ app.first_name | title }} {% if app.middle_name %}{{ app.middle_name[0]|upper }}.{% endif %}
                                </p>
                                <p class="text-xs sm:text-sm text-gray-500 applicant-email">{{ app.student_account_email
                                    or app.email_address or 'N/A' }}</p>
                            </div>
                        </div>
                    </td>
                    <td
                        class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 applicant-program hidden sm:table-cell">
                        {{ app.program_choice or 'N/A' }}</td>
                    <td
                        class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 submission-date-cell hidden md:table-cell">
                        {{ app.submitted_at.strftime('%b %d, %Y %I:%M %p') if app.submitted_at else
                        (app.date_of_application.strftime('%b %d, %Y') if app.date_of_application else 'N/A') }}
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap status-cell">
                        <span
                            class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge bg-teal-100 text-teal-800">Passed</span>
                    </td>
                    <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                        <div class="flex space-x-1 justify-end items-center">
                            <a href="{{ url_for('auth.admin_view_application_page', applicant_id=app.applicant_id) }}"
                                class="text-gray-500 hover:text-blue-600 p-0.5 sm:p-1" title="View Full Page"><i
                                    class="ri-external-link-line ri-lg"></i></a>

                            <a href="{{ url_for('auth.admin_print_application_form', applicant_id=app.applicant_id) }}"
                                target="_blank" class="text-gray-500 hover:text-green-500 p-0.5 sm:p-1 action-print"
                                title="Print Application Form"><i class="ri-printer-line ri-lg"></i></a>
                            {% if session.user_role == 'admin' %}
                            <button class="text-gray-500 hover:text-yellow-600 p-0.5 sm:p-1 action-admin-notes"
                                title="Admin Notes" data-id="{{ app.applicant_id }}"><i
                                    class="ri-sticky-note-line ri-lg"></i></button>
                            <button class="text-gray-500 hover:text-teal-600 p-0.5 sm:p-1 action-permit-details"
                                title="Permit Details" data-id="{{ app.applicant_id }}"><i
                                    class="ri-ticket-line ri-lg"></i></button>
                            <div class="dropdown relative action-status-dropdown">
                                <button class="text-gray-500 hover:text-primary p-0.5 sm:p-1" title="Change Status"><i
                                        class="ri-arrow-down-s-fill ri-lg"></i></button>
                                <div class="dropdown-content w-36 text-left">

                                    <a href="#"
                                        class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status"
                                        data-id="{{ app.applicant_id }}" data-status="Pending">Set Pending</a>

                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="{{ 7 if session.user_role == 'admin' else 6 }}"
                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No passed applications
                        found.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}