

{% extends 'base.html' %}

{% block title %}Re-Enrollment Form{% endblock %}

{% block body %}
<body class="bg-gray-50" style="margin-top: 100px;">
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6 sm:p-8">
            <div class="text-center border-b pb-6 mb-6">
                <i class="ri-refresh-line text-5xl text-primary"></i>
                <h1 class="text-3xl font-bold text-gray-900 mt-4">Re-Enrollment for {{ active_school_year }}</h1>
                <p class="text-gray-600 mt-2">Welcome back! Please confirm your details for the new academic term.</p>
            </div>

            {% if application %}
            <form action="{{ url_for('auth.submit_re_enrollment', applicant_id=application.applicant_id) }}" method="POST">

                <!-- Applicant Summary -->
                <div class="space-y-6 text-sm mb-8">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800 mb-3">Student Summary</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3 bg-gray-50 p-4 rounded-md border">
                            <p><strong>Applicant Name:</strong> {{ application.first_name }} {{ application.last_name }}</p>
                            <p><strong>Student ID:</strong> 
                                {% if application.old_student_id %}
                                    {{ application.old_student_id }}
                                {% elif application.control_number %}
                                    {{ application.control_number }}
                                {% else %}
                                    S-{{ "%05d" | format(application.student_user_id) }}
                                {% endif %}
                            </p>
                            <p><strong>Email:</strong> {{ application.email_address }}</p>
                            
                            <!-- Display Current Section if Assigned -->
                            {% if application.section_name %}
                            <p><strong>Current Section:</strong> <span class="text-primary font-bold">{{ application.section_name }}</span></p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Re-Enrollment Details -->
                <div class="mt-8 pt-6 border-t">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">New Enrollment Details</h2>
                    
                    <!-- Program Selection -->
                    <div class="mb-6">
                         <label for="program_choice" class="block text-sm font-medium text-gray-700 mb-1">1. Select Program <span class="text-red-500">*</span></label>
                         <select id="program_choice" name="program_choice" required class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-primary focus:border-primary">
                            <option value="" disabled>Choose Program...</option>
                            {% for prog in programs %}
                                <option value="{{ prog.title }}" {% if prog.title == application.program_choice %}selected{% endif %}>
                                    {{ prog.title }}
                                </option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-gray-500 mt-1">You can change your program here if you are shifting. (Section will reset to 1st Year)</p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="year_level" class="block text-sm font-medium text-gray-700 mb-1">2. Year Level <span class="text-red-500">*</span></label>
                            <select id="year_level" name="year_level" required class="w-full border-gray-300 rounded-md shadow-sm text-sm focus:ring-primary focus:border-primary transition-colors">
                                <option value="" disabled selected>Choose year...</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                                <option value="5th Year">5th Year</option>
                            </select>
                            <p id="year_level_note" class="text-xs text-orange-600 mt-1 hidden">Shifting program resets Year Level to 1st Year.</p>
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">3. Semester</label>
                            <input type="text" id="semester" name="semester" 
                                value="{{ active_term.semester if active_term else '' }}" 
                                readonly 
                                class="w-full border-gray-300 rounded-md shadow-sm text-sm bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0 focus:border-gray-300">
                            <p class="text-xs text-gray-500 mt-1">Automatically set based on the active academic term.</p>
                        </div>
                    </div>

                    <!-- SECTION DISPLAY (Read-Only / Locked) -->
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-md" id="section_status_container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">4. Assigned Section</label>
                        
                        <!-- If Student has a permanent section (Existing Student Flow) -->
                        {% if application.is_section_permanent and application.section_name %}
                            <div class="flex items-center">
                                <input type="text" id="locked_section_display" 
                                       value="Calculating..." 
                                       readonly 
                                       class="w-full border-gray-300 rounded-md shadow-sm text-sm bg-gray-100 text-gray-600 cursor-not-allowed focus:ring-0">
                                <i class="ri-lock-fill text-gray-400 ml-2" title="Section is permanent. Contact Admin to change."></i>
                            </div>
                            <p class="text-xs text-blue-600 mt-1">
                                Your section is permanent. It will automatically progress (e.g. 1A â†’ 2A) based on your selected Year Level.
                            </p>
                        
                        <!-- If Student is shifting or has no section yet -->
                        {% else %}
                            <div class="flex items-center">
                                <input type="text" value="Auto-Assigning..." readonly class="w-full border-gray-300 rounded-md shadow-sm text-sm bg-gray-100 text-gray-500 italic">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">A section will be automatically assigned upon enrollment approval.</p>
                        {% endif %}
                    </div>

                </div>

                <!-- Submission Controls -->
                <div class="mt-8 pt-6 border-t">
                    <div class="flex items-start p-4 rounded-md bg-yellow-50 border border-yellow-200 text-sm">
                        <i class="ri-alert-line text-yellow-500 text-xl mr-3 mt-1"></i>
                        <div>
                            <h3 class="font-semibold text-yellow-800">Final Confirmation</h3>
                            <p class="text-yellow-700">By submitting, you confirm your intent to re-enroll for the academic year <strong>{{ active_school_year }}</strong>. Your submission will be sent for verification.</p>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end items-center gap-4">
                        <!-- Cancel Link goes back to status page without changing DB -->
                        <a href="{{ url_for('views.application_status_page') }}" class="text-sm font-medium text-gray-600 hover:text-primary">Cancel and Go Back</a>
                        
                        <button type="submit" class="bg-primary text-white px-6 py-3 rounded-button font-medium whitespace-nowrap flex items-center text-sm hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                            <i class="ri-checkbox-circle-line mr-2"></i> Submit Re-Enrollment
                        </button>
                    </div>
                </div>
            </form>
            {% else %}
            <div class="text-center text-red-600 bg-red-50 p-4 rounded-md">
                <p>Error: Could not load application details. Please go back and try again.</p>
                <a href="{{ url_for('views.application_status_page') }}" class="mt-4 inline-block text-primary hover:underline">Return to Status Page</a>
            </div>
            {% endif %}
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const programSelect = document.getElementById('program_choice');
        const yearSelect = document.getElementById('year_level');
        const yearNote = document.getElementById('year_level_note');
        const lockedSectionDisplay = document.getElementById('locked_section_display');
        
        // Backend values
        const originalProgram = "{{ application.program_choice }}";
        const currentSectionName = "{{ application.section_name or '' }}"; 
        // Extract just the letter (assuming format "PROG 1A")
        const currentSectionLetter = currentSectionName ? currentSectionName.slice(-1) : ''; 

        function updateUI() {
            const selectedProgram = programSelect.value;
            const selectedYear = yearSelect.value; // e.g. "2nd Year"

            if (selectedProgram !== originalProgram) {
                // SHIFTING: Reset to 1st Year, New Section logic
                yearSelect.value = "1st Year";
                yearSelect.style.pointerEvents = 'none'; 
                yearSelect.style.backgroundColor = '#f3f4f6'; 
                yearNote.classList.remove('hidden');
                
                if(lockedSectionDisplay) {
                    lockedSectionDisplay.value = "New Section (Auto-Assign)";
                    lockedSectionDisplay.classList.add('italic', 'text-gray-500');
                }
            } else {
                // SAME PROGRAM: Normal Progression
                yearSelect.style.pointerEvents = 'auto';
                yearSelect.style.backgroundColor = '';
                yearNote.classList.add('hidden');

                if(lockedSectionDisplay && currentSectionLetter) {
                    // Predict next section name: Program + Year Digit + Letter
                    const yearDigit = selectedYear ? selectedYear.charAt(0) : '?';
                    
                    lockedSectionDisplay.value = `Section ${yearDigit}${currentSectionLetter} (Auto-Progression)`;
                    lockedSectionDisplay.classList.remove('italic', 'text-gray-500');
                }
            }
        }

        // Run on load
        updateUI();

        // Listeners
        programSelect.addEventListener('change', updateUI);
        yearSelect.addEventListener('change', updateUI);
    });
    </script>
</body>
{% endblock %}