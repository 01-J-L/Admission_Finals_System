<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Designer - PGPC Finance</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; }
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 320px; background: white; padding: 25px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.05); z-index: 20; flex-shrink: 0; }
        .sidebar h2 { font-size: 20px; margin: 0; color: #111827; display: flex; align-items: center; gap: 10px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-size: 12px; font-weight: 600; color: #374151; text-transform: uppercase; }
        
        /* Workspace */
        .workspace { flex: 1; display: flex; justify-content: center; align-items: flex-start; background-color: #64748b; overflow: auto; padding: 40px; position: relative; }
        
        /* Canvas */
        .receipt-canvas { 
            width: 4.5in; height: 8.5in; background-color: white; 
            position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.4); 
            flex-shrink: 0; overflow: hidden;
        }
        #bg-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: fill; pointer-events: none; opacity: 0.7; }

        /* Draggable Text */
        .draggable { 
            position: absolute; cursor: grab; font-family: 'Courier Prime', monospace; 
            font-weight: bold; color: #000; padding: 4px; border: 1px dashed #94a3b8; 
            white-space: nowrap; user-select: none; z-index: 10; background: rgba(255,255,255,0.3);
        }
        .draggable:hover { border-color: var(--primary); background: rgba(59, 130, 246, 0.2); }
        
        /* State for selected field */
        .draggable.selected { border: 2px solid var(--primary); background: white; z-index: 100; box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); }
        .draggable.active { cursor: grabbing; opacity: 0.8; }

        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; text-align: center; text-decoration: none; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-save { background: #059669; color: white; }
        .btn-exit { background: #1e293b; color: white; }

        #selected-indicator { font-size: 11px; color: var(--primary); font-weight: bold; margin-bottom: -5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2><i class="ri-layout-masonry-line"></i> Layout Editor</h2>
        
        <form action="{{ url_for('auth.upload_receipt_bg') }}" method="POST" enctype="multipart/form-data" class="control-group">
            <label>Template Image</label>
            <input type="file" name="receipt_bg" accept="image/*" onchange="this.form.submit()" style="font-size: 12px;">
        </form>

        <hr style="width: 100%; border: 0; border-top: 1px solid #e5e7eb;">

        <!-- Font Size Control -->
        <div class="control-group">
            <label>Text Scaling</label>
            <div id="selected-indicator">Selecting: None</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" id="fontSizeSlider" min="6" max="40" value="14" disabled style="flex: 1;">
                <span id="fontSizeVal" style="font-weight: bold; width: 40px; color: #6b7280;">--</span>
            </div>
            <p style="font-size: 10px; color: #94a3b8;">Click a field on the paper to enable resizing.</p>
        </div>

        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <button id="saveLayoutBtn" class="btn btn-save"><i class="ri-save-3-line"></i> Save To Database</button>
            <a href="{{ url_for('auth.cashier_dashboard') }}" class="btn btn-exit">Exit Designer</a>
        </div>
    </div>

    <div class="workspace">
        <div class="receipt-canvas" id="canvas">
            <img id="bg-image" src="{{ url_for('static', filename='images/uploads/' + bg_file) }}">
            
            <!-- Draggable Elements -->
            <div class="draggable" id="dragDate" data-name="Date" style="top: {{ layout.dragDate.top_pos }}; left: {{ layout.dragDate.left_pos }}; font-size: {{ layout.dragDate.font_size }};">2024-05-21</div>
            <div class="draggable" id="dragName" data-name="Payer Name" style="top: {{ layout.dragName.top_pos }}; left: {{ layout.dragName.left_pos }}; font-size: {{ layout.dragName.font_size }};">DELA CRUZ, JUAN PROTASIO</div>
            <div class="draggable" id="dragDesc" data-name="Description" style="top: {{ layout.dragDesc.top_pos }}; left: {{ layout.dragDesc.left_pos }}; font-size: {{ layout.dragDesc.font_size }};">Tuition Fee - Partial Payment</div>
            <div class="draggable" id="dragAmount" data-name="Amount" style="top: {{ layout.dragAmount.top_pos }}; left: {{ layout.dragAmount.left_pos }}; font-size: {{ layout.dragAmount.font_size }};">1,500.00</div>
            <div class="draggable" id="dragTotal" data-name="Total" style="top: {{ layout.dragTotal.top_pos }}; left: {{ layout.dragTotal.left_pos }}; font-size: {{ layout.dragTotal.font_size }};">1,500.00</div>
            <div class="draggable" id="dragWords" data-name="Amount Words" style="top: {{ layout.dragWords.top_pos }}; left: {{ layout.dragWords.left_pos }}; font-size: {{ layout.dragWords.font_size }};">One Thousand Five Hundred Pesos Only</div>
            <div class="draggable" id="dragOfficer" data-name="Cashier Name" style="top: {{ layout.dragOfficer.top_pos }}; left: {{ layout.dragOfficer.left_pos }}; font-size: {{ layout.dragOfficer.font_size }};">{{ session.get('user_name') }}</div>
        </div>
    </div>

    <script>
        let activeDragItem = null;
        let selectedItem = null;
        let offsetX, offsetY;
        
        const canvas = document.getElementById('canvas');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeVal = document.getElementById('fontSizeVal');
        const selectedIndicator = document.getElementById('selected-indicator');

        // Selection Logic
        document.querySelectorAll('.draggable').forEach(item => {
            item.addEventListener('mousedown', (e) => {
                // Remove selection from others
                document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
                
                // Select this one
                selectedItem = item;
                activeDragItem = item;
                item.classList.add('selected');
                item.classList.add('active');

                // Update Sidebar UI
                selectedIndicator.textContent = "Selecting: " + item.dataset.name;
                fontSizeSlider.disabled = false;
                const currentFS = window.getComputedStyle(item).fontSize;
                fontSizeSlider.value = parseInt(currentFS);
                fontSizeVal.textContent = currentFS;
                fontSizeVal.style.color = "var(--primary)";

                // Drag Offset
                const rect = item.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
            });
        });

        // Dragging Logic
        window.addEventListener('mousemove', (e) => {
            if (activeDragItem) {
                e.preventDefault();
                const canvasRect = canvas.getBoundingClientRect();

                let x = e.clientX - canvasRect.left - offsetX;
                let y = e.clientY - canvasRect.top - offsetY;

                // Boundary Constraints
                if (x < 0) x = 0;
                if (y < 0) y = 0;
                if (x + activeDragItem.offsetWidth > canvasRect.width) x = canvasRect.width - activeDragItem.offsetWidth;
                if (y + activeDragItem.offsetHeight > canvasRect.height) y = canvasRect.height - activeDragItem.offsetHeight;

                activeDragItem.style.left = (x / canvasRect.width * 100) + "%";
                activeDragItem.style.top = (y / canvasRect.height * 100) + "%";
            }
        });

        window.addEventListener('mouseup', () => {
            if (activeDragItem) activeDragItem.classList.remove('active');
            activeDragItem = null;
        });

        // Font Size slider listener
        fontSizeSlider.addEventListener('input', (e) => {
            if (selectedItem) {
                selectedItem.style.fontSize = e.target.value + 'px';
                fontSizeVal.textContent = e.target.value + 'px';
            }
        });

        // Save Layout to Database
        document.getElementById('saveLayoutBtn').addEventListener('click', async () => {
            const draggables = document.querySelectorAll('.draggable');
            const layoutData = [];

            draggables.forEach(el => {
                layoutData.push({
                    id: el.id,
                    top: el.style.top,
                    left: el.style.left,
                    fontSize: el.style.fontSize || window.getComputedStyle(el).fontSize
                });
            });

            try {
                const response = await fetch('/admin/save-receipt-layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ layout: layoutData })
                });
                const result = await response.json();
                alert(result.message);
            } catch (err) {
                alert("Connection error.");
            }
        });
    </script>
</body>
</html>