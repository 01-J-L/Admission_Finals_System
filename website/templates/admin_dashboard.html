<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - PGPC</title>
<script src="https://cdn.tailwindcss.com/3.4.1"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#4f46e5',secondary:'#6366f1', teal: { 100: '#ccfbf1', 600: '#0d9488', 800: '#115e59' }, orange: { 100: '#ffedd5', 600: '#ea580c', 800: '#9a3412' }, indigo: {100: '#e0e7ff', 700: '#4338ca', 200: '#c7d2fe'} },borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="icon" href="{{ url_for('static', filename='logopgpc.png') }}" type="image/x-icon">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
<style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    tr.selected { background-color: #eff6ff !important; }
    .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: none; z-index: 50; }
    .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: auto; min-width: 320px; max-height: 90vh; overflow-y: auto; display: none; z-index: 51; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1); }
    .modal.show, .modal-backdrop.show { display: block; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
    .custom-checkbox { position: relative; display: flex; align-items: center; cursor: pointer; }
    .custom-checkbox input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
    .checkmark { height: 18px; width: 18px; background-color: white; border: 1.5px solid #d1d5db; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .custom-checkbox input:checked ~ .checkmark { background-color: #4f46e5; border-color: #4f46e5; }
    .checkmark:after { content: ""; display: none; }
    .custom-checkbox input:checked ~ .checkmark:after { display: block; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); margin-bottom: 2px; }
    .dropdown-content { display: none; position: absolute; background-color: white; min-width: 144px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 50; border-radius: 8px; border: 1px solid #e5e7eb; right: 0; top: 100%; margin-top: 4px; }
    .dropdown.active .dropdown-content { display: block; }
    .action-status-dropdown.active { z-index: 51; }
    .bulk-actions { display: none; }
    .toast-notification { position: fixed; top: 20px; right: 20px; background-color: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out; font-size: 0.875rem; transform: translateY(-20px); }
    .toast-notification.show { opacity: 1; transform: translateY(0); }
    .toast-notification.success { background-color: #28a745; }
    .toast-notification.error { background-color: #dc3545; }
    .toast-notification.info { background-color: #17a2b8; }
    @keyframes status-flash { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.15); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
    .status-flash-animation { animation: status-flash 0.6s ease-in-out; }
    .document-link {
        color: #4f46e5; /* primary color */
        text-decoration: underline;
    }
    .document-link:hover {
        color: #4338ca; /* darker primary */
    }
    /* Styles for radio buttons in admin add form */
    #addApplicationContent input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid #d1d5db; /* gray-300 */
        border-radius: 50%;
        outline: none;
        cursor: pointer;
        margin-right: 0.25rem; /* Tailwind's mr-1 */
        transition: background-color 0.2s, border-color 0.2s;
    }
    #addApplicationContent input[type="radio"]:checked {
        background-color: #4f46e5; /* primary */
        border-color: #4f46e5; /* primary */
    }
    #addApplicationContent input[type="radio"]:checked::before {
        content: '';
        display: block;
        width: 8px;
        height: 8px;
        margin: 2px; /* Adjust to center the dot */
        background-color: white;
        border-radius: 50%;
    }
     /* Styles for checkbox in admin add form */
    #addApplicationContent input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid #d1d5db; /* gray-300 */
        border-radius: 4px; /* sm */
        outline: none;
        cursor: pointer;
        margin-right: 0.25rem; /* Tailwind's mr-1 */
        display: inline-block;
        vertical-align: middle;
        position: relative;
    }
    #addApplicationContent input[type="checkbox"]:checked {
        background-color: #4f46e5; /* primary */
        border-color: #4f46e5; /* primary */
    }
    #addApplicationContent input[type="checkbox"]:checked::before {
        content: "âœ“";
        font-size: 12px;
        color: white;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        line-height: 1;
    }
    /* Gender filter radio buttons */
    .filter-bar input[type="radio"] {
        appearance: none; /* For Tailwind, or use a custom class if preferred for more control */
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border: 1.5px solid #d1d5db; /* gray-300 */
        border-radius: 50%;
        outline: none;
        cursor: pointer;
        margin-right: 0.25rem; /* Tailwind's mr-1 */
        transition: background-color 0.2s, border-color 0.2s;
    }
    .filter-bar input[type="radio"]:checked {
        background-color: #4f46e5; /* primary */
        border-color: #4f46e5; /* primary */
    }
    .filter-bar input[type="radio"]:checked::before {
        content: '';
        display: block;
        width: 8px;
        height: 8px;
        margin: 2.5px; /* Adjust to center the dot for 16px circle with 1.5px border */
        background-color: white;
        border-radius: 50%;
    }


</style>
</head>
<body class="flex">

<aside id="sidebar" class="w-64 h-screen bg-white border-r border-gray-200 flex-shrink-0 fixed left-0 transition-transform duration-300 ease-in-out transform -translate-x-full sm:translate-x-0 z-40">
    <div class="h-16 border-b border-gray-200 flex items-center px-6">
        <div class="text-2xl font-['Pacifico'] text-primary">PGPC Admin</div>
    </div>
    <nav class="p-4 space-y-1 h-[calc(100vh-4rem-1px-4rem)] overflow-y-auto custom-scrollbar">
        <a href="#" id="sidebarDashboardMenuLink" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">
            <div class="w-5 h-5 flex items-center justify-center mr-3"><i class="ri-dashboard-line"></i></div>
            Dashboard
        </a>
        <div class="space-y-1">
            <a href="#" id="applicationsMenu" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">
                <div class="w-5 h-5 flex items-center justify-center mr-3"><i class="ri-file-list-line"></i></div>
                Applications
            </a>
            <div class="ml-12 space-y-1">
                 <a href="#" id="pendingFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-yellow-600 hover:bg-gray-50 rounded">
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-time-line"></i></div>
                    Pending <span class="ml-auto bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded-full" id="pendingCountSide">{{ stats.pending if stats else '0' }}</span>
                </a>
                <!-- REMOVED In Review Filter Link -->
                <a href="#" id="approvedFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-green-600 hover:bg-gray-50 rounded">
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-checkbox-circle-line"></i></div>
                    Approved <span class="ml-auto bg-green-100 text-green-800 text-xs font-medium px-2 py-0.5 rounded-full" id="approvedCountSide">{{ stats.approved if stats else '0' }}</span>
                </a>
                <a href="#" id="scheduledFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-indigo-700 hover:bg-gray-50 rounded"> <!-- No longer needs ml-4, it's a primary filter now -->
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-calendar-schedule-line"></i></div>
                    Scheduled <span class="ml-auto bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-0.5 rounded-full" id="scheduledCountSide">{{ stats.scheduled if stats else '0' }}</span>
                </a>
                <a href="#" id="rejectedFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-red-600 hover:bg-gray-50 rounded">
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-close-circle-line"></i></div>
                    Rejected <span class="ml-auto bg-red-100 text-red-800 text-xs font-medium px-2 py-0.5 rounded-full" id="rejectedCountSide">{{ stats.rejected if stats else '0' }}</span>
                </a>
                <a href="#" id="passedFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-teal-600 hover:bg-gray-50 rounded">
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-shield-check-line"></i></div>
                    Passed <span class="ml-auto bg-teal-100 text-teal-800 text-xs font-medium px-2 py-0.5 rounded-full" id="passedCountSide">{{ stats.passed if stats else '0' }}</span>
                </a>
                <a href="#" id="failedFilterLink" class="flex items-center px-4 py-2 text-sm font-medium text-orange-600 hover:bg-gray-50 rounded">
                    <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-shield-cross-line"></i></div>
                    Failed <span class="ml-auto bg-orange-100 text-orange-800 text-xs font-medium px-2 py-0.5 rounded-full" id="failedCountSide">{{ stats.failed if stats else '0' }}</span>
                </a>
            </div>
        </div>
         <a href="#" id="sidebarAddApplicationMenuLink" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-50 rounded">
            <div class="w-5 h-5 flex items-center justify-center mr-3"><i class="ri-user-add-line"></i></div>
            Add New Application
        </a>
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
        <a href="{{ url_for('auth.logout') }}" id="sidebarBackToHomeLink" class="flex items-center justify-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-button border border-gray-300 w-full">
            <div class="w-5 h-5 flex items-center justify-center mr-2"><i class="ri-arrow-left-line"></i></div>
           Back to Home Page
        </a>
    </div>
</aside>
<div id="sidebarBackdrop" class="fixed inset-0 bg-black/30 z-30 hidden sm:hidden"></div>


<div class="flex-1 sm:ml-64 transition-all duration-300 ease-in-out" id="mainContentArea">
    <header class="bg-white shadow-sm">
        <div class="flex items-center justify-between px-4 sm:px-6 h-16 border-b border-gray-200">
            <div class="flex items-center">
                <button id="sidebarToggle" class="text-gray-500 hover:text-primary mr-2 sm:mr-4 p-2 -ml-2 sm:ml-0 block sm:hidden">

                    <div class="w-6 h-6 flex items-center justify-center"><i class="ri-menu-line"></i></div>
                </button>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <div class="w-5 h-5 flex items-center justify-center text-gray-400"><i class="ri-search-line"></i></div>
                    </div>
                    <input type="text" id="searchInput" class="pl-10 pr-4 py-2 w-full sm:w-64 border border-gray-300 rounded text-sm focus:ring-primary focus:border-primary" placeholder="Search applications...">
                </div>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 ml-2 sm:ml-0">
                 <a href="{{ url_for('auth.logout') }}" class="text-gray-500 hover:text-primary" title="Logout">
                    <div class="w-6 h-6 flex items-center justify-center"><i class="ri-logout-box-line"></i></div>
                </a>
            </div>
        </div>
        <div class="px-4 sm:px-6 py-2 bg-white border-b border-gray-200 flex flex-wrap items-center text-sm">
            <a href="#" id="breadcrumbAdminHomeLink" class="text-gray-500 hover:text-primary">Admin Home</a>
            <div class="w-4 h-4 flex items-center justify-center text-gray-400 mx-1">
                <i class="ri-arrow-right-s-line"></i>
            </div>
            <span id="breadcrumbCurrentPage" class="text-primary">Dashboard</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <div class="mb-6">
            <h1 id="pageTitleHeader" class="text-2xl font-bold text-gray-900">Dashboard Overview</h1>
        </div>

        <div id="dashboardContent">
            <!-- Adjusted grid columns for overview stats: lg:grid-cols-4 or 6, instead of 5 or 7 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Total Applications</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsTotal">{{ stats.total_applications if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-lg">
                            <i class="ri-file-list-3-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Pending Review</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsPending">{{ stats.pending if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-yellow-100 text-yellow-600 rounded-lg">
                            <i class="ri-time-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Approved (Awaiting Schedule)</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsApproved">{{ stats.approved if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-green-100 text-green-600 rounded-lg">
                            <i class="ri-check-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                 <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Scheduled for Exam</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsScheduled">{{ stats.scheduled if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-indigo-100 text-indigo-700 rounded-lg">
                            <i class="ri-calendar-schedule-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Rejected</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsRejected">{{ stats.rejected if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-lg">
                            <i class="ri-close-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Passed</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsPassed">{{ stats.passed if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-teal-100 text-teal-600 rounded-lg">
                            <i class="ri-shield-check-line ri-lg"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">Failed</p>
                            <h2 class="text-3xl font-bold text-gray-900 mt-1" id="statsFailed">{{ stats.failed if stats else '0' }}</h2>
                        </div>
                        <div class="w-10 h-10 flex items-center justify-center bg-orange-100 text-orange-600 rounded-lg">
                            <i class="ri-shield-cross-line ri-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Application Trends (Last 7 Months)</h3>
                    </div>
                    <div id="applicationChart" style="width: 100%; height: 300px;"></div>
                </div>
                <div class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Application Status Breakdown</h3>
                    </div>
                    <div id="statusChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
        </div>

        <div id="applicationsContent" style="display: none;" class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                <h3 id="mainPageTitle" class="text-xl font-semibold text-gray-800">Applications</h3>
                <button id="printReportBtn" class="px-4 py-2 bg-primary text-white rounded text-sm font-medium !rounded-button flex items-center hover:bg-primary/90">
                    <i class="ri-printer-line mr-2"></i>Print Report
                </button>
            </div>

            <div class="bg-gray-50 p-4 rounded shadow-inner border border-gray-200 mb-6 filter-bar">
                <div class="flex flex-wrap items-center gap-x-6 gap-y-4">
                    <span class="text-sm font-medium text-gray-700">Filter by Submission Date:</span>
                    <div class="flex items-center space-x-2">
                        <label for="startDateFilter" class="text-sm text-gray-600">From:</label>
                        <input type="date" id="startDateFilter" name="startDateFilter" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary w-auto">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="endDateFilter" class="text-sm text-gray-600">To:</label>
                        <input type="date" id="endDateFilter" name="endDateFilter" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded text-sm !rounded-button focus:ring-primary focus:border-primary w-auto">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Gender:</label>
                        <div class="flex items-center">
                            <input type="radio" id="genderFilterAll" name="genderFilter" value="All" checked>
                            <label for="genderFilterAll" class="text-sm text-gray-600 ml-1 mr-3">All</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="genderFilterMale" name="genderFilter" value="Male">
                            <label for="genderFilterMale" class="text-sm text-gray-600 ml-1 mr-3">Male</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="genderFilterFemale" name="genderFilter" value="Female">
                            <label for="genderFilterFemale" class="text-sm text-gray-600 ml-1">Female</label>
                        </div>
                    </div>
                    <button id="clearFiltersBtn" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded text-sm font-medium !rounded-button hover:bg-gray-300 flex items-center">
                        <i class="ri-filter-off-line mr-1"></i> Clear Filters
                    </button>
                </div>
            </div>

            <div id="bulkActions" class="bulk-actions bg-blue-50 p-3 rounded-md border border-blue-200 mb-6 flex flex-wrap items-center gap-y-2">
                <span id="selectedCount" class="text-sm font-medium text-blue-700 mr-4">0 items selected</span>
                <div class="flex flex-wrap gap-2">
                    <button id="bulkApproveBtn" class="px-3 py-1.5 bg-green-100 text-green-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-green-200">
                        <i class="ri-check-line mr-1"></i> Approve
                    </button>
                    <button id="bulkRejectBtn" class="px-3 py-1.5 bg-red-100 text-red-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-red-200">
                        <i class="ri-close-line mr-1"></i> Reject
                    </button>
                    <button id="bulkPassBtn" class="px-3 py-1.5 bg-teal-100 text-teal-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-teal-200">
                        <i class="ri-shield-check-line mr-1"></i> Pass
                    </button>
                    <button id="bulkFailBtn" class="px-3 py-1.5 bg-orange-100 text-orange-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-orange-200">
                        <i class="ri-shield-cross-line mr-1"></i> Fail
                    </button>
                     <button id="bulkSetPermitDetailsBtn" class="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded text-sm font-medium !rounded-button flex items-center hover:bg-indigo-200">
                        <i class="ri-ticket-line mr-1"></i> Set Permit Details
                    </button>
                    
                </div>
                <button id="closeBulkActions" class="ml-auto text-gray-500 hover:text-gray-700 p-1">
                    <i class="ri-close-line ri-lg"></i>
                </button>
            </div>

            <!-- Modals -->
            <div id="deleteConfirmationModal" class="modal">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <i class="ri-error-warning-line ri-xl text-red-600"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mt-3" id="deleteModalTitle">Delete Application(s)</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="deleteModalMessage">Are you sure you want to delete the selected application(s)? This action cannot be undone.</p>
                    </div>
                    <div class="items-center px-4 py-3 space-x-2">
                        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Delete
                        </button>
                        <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
            <div id="deleteModalBackdrop" class="modal-backdrop"></div>

            <div id="viewApplicationModal" class="modal w-full max-w-2xl">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-semibold text-gray-900" id="viewModalTitle">Application Details</h3>
                    <button id="closeViewModalIcon" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line ri-lg"></i>
                    </button>
                </div>
                <div class="mt-4 custom-scrollbar pr-2" id="viewModalContent" style="max-height: 65vh;">
                    <p class="text-center text-gray-500">Loading details...</p>
                </div>
            </div>
            <div id="viewModalBackdrop" class="modal-backdrop"></div>

            <!-- Admin Notes Modal -->
            <div id="adminNotesModal" class="modal w-full max-w-lg">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-semibold text-gray-900" id="adminNotesModalTitle">Admin Notes</h3>
                    <button id="closeAdminNotesModalIcon" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line ri-lg"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <label for="adminNotesTextareaModal" class="block text-sm font-medium text-gray-700">Notes for Application <span id="adminNotesAppId" class="font-semibold"></span>:</label>
                    <textarea id="adminNotesTextareaModal" name="admin_notes_modal" rows="4" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-primary focus:border-primary p-2"></textarea>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="cancelAdminNotesBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                    <button id="saveAdminNotesModalBtn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md shadow-sm hover:bg-primary/90">Save Notes</button>
                </div>
            </div>
            <div id="adminNotesModalBackdrop" class="modal-backdrop"></div>

            <!-- Permit Details Modal (Single Application) -->
            <div id="adminPermitDetailsModal" class="modal w-full max-w-xl">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-semibold text-gray-900" id="adminPermitDetailsModalTitle">Admission Test Permit Details</h3>
                    <button id="closeAdminPermitDetailsModalIcon" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line ri-lg"></i>
                    </button>
                </div>
                <div class="mt-4 space-y-4">
                     <p class="text-sm text-gray-600">For Application <span id="adminPermitAppId" class="font-semibold"></span>:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <label for="permitControlNoModal" class="block text-xs font-medium text-gray-700">Permit Control No.</label>
                            <input type="text" id="permitControlNoModal" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 bg-gray-100 cursor-not-allowed" readonly title="Permit Control Number is auto-generated upon approval.">
                        </div>
                        <div>
                            <label for="permitExamDateModal" class="block text-xs font-medium text-gray-700">Date of Examination</label>
                            <input type="date" id="permitExamDateModal" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="permitExamTimeModal" class="block text-xs font-medium text-gray-700">Time</label>
                            <input type="text" id="permitExamTimeModal" placeholder="e.g., 09:00 AM" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                        </div>
                        <div>
                            <label for="permitTestingRoomModal" class="block text-xs font-medium text-gray-700">Testing Room</label>
                            <input type="text" id="permitTestingRoomModal" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button id="cancelAdminPermitDetailsBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                    <button id="saveAdminPermitDetailsModalBtn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md shadow-sm hover:bg-primary/90">Save Permit Details</button>
                </div>
            </div>
            <div id="adminPermitDetailsModalBackdrop" class="modal-backdrop"></div>

            <!-- Bulk Set Permit Details Modal -->
            <div id="bulkPermitDetailsModal" class="modal w-full max-w-md">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-xl font-semibold text-gray-900" id="bulkPermitDetailsModalTitle">Set Permit Details for Selected</h3>
                    <button id="closeBulkPermitDetailsModalIcon" class="text-gray-400 hover:text-gray-600">
                        <i class="ri-close-line ri-lg"></i>
                    </button>
                </div>
                <div class="mt-4 space-y-4">
                    <p class="text-sm text-gray-600">Enter common permit details to apply to all selected applications.</p>
                    <div>
                        <label for="bulkPermitExamDate" class="block text-xs font-medium text-gray-700">Date of Examination</label>
                        <input type="date" id="bulkPermitExamDate" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                    </div>
                    <div>
                        <label for="bulkPermitExamTime" class="block text-xs font-medium text-gray-700">Time</label>
                        <input type="text" id="bulkPermitExamTime" placeholder="e.g., 09:00 AM" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                    </div>
                    <div>
                        <label for="bulkPermitTestingRoom" class="block text-xs font-medium text-gray-700">Testing Room</label>
                        <input type="text" id="bulkPermitTestingRoom" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2">
                    </div>
                    <p class="text-xs text-gray-500">Note: Permit Control No. is auto-generated upon approval and set individually.</p>
                </div>
                <div class="mt-6 flex justify-end space-x-2">
                    <button id="cancelBulkPermitDetailsBtn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
                    <button id="saveBulkPermitDetailsBtn" class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-md shadow-sm hover:bg-primary/90">Apply to Selected</button>
                </div>
            </div>
            <div id="bulkPermitDetailsModalBackdrop" class="modal-backdrop"></div>


            <div class="overflow-x-auto custom-scrollbar">
                <table class="min-w-full divide-y divide-gray-200" id="applicationsTable">
                     <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <label class="custom-checkbox"><input type="checkbox" id="selectAll"><span class="checkmark"></span></label>
                            </th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicant</th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Program</th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Submission Date</th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-3 py-2 md:px-6 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if applications %}
                            {% for app in applications %}
                            <tr class="hover:bg-gray-50" data-applicant-id="{{ app.applicant_id }}">
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                                    <label class="custom-checkbox"><input type="checkbox" class="row-checkbox" data-id="{{ app.applicant_id }}"><span class="checkmark"></span></label>
                                </td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900">P2025{{ "%04d" | format(app.applicant_id) }}</td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center flex-shrink-0">
                                            <span class="text-sm font-medium">{{ app.first_name[0] if app.first_name else 'N' }}{{ app.last_name[0] if app.last_name else 'A' }}</span>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm font-medium text-gray-900 applicant-name">{{ app.first_name }} {{ app.last_name }}</p>
                                            <p class="text-xs sm:text-sm text-gray-500 applicant-email">{{ app.student_account_email or app.email_address or 'N/A' }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 applicant-program hidden sm:table-cell">{{ app.program_choice or 'N/A' }}</td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-900 submission-date-cell hidden md:table-cell">
                                    {{ app.submitted_at.strftime('%b %d, %Y %I:%M %p') if app.submitted_at else (app.date_of_application.strftime('%b %d, %Y') if app.date_of_application else 'N/A') }}
                                </td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap status-cell">
                                    {% set status_class = 'bg-gray-100 text-gray-800' %}
                                    {% set current_status_db = app.application_status | lower | replace(' ', '_') %}
                                    
                                    {# Determine effective status for display #}
                                    {% set has_permit_details = app.permit_exam_date and app.permit_exam_time and app.permit_testing_room %}
                                    {% set effective_status_display = current_status_db %}
                                    {% if current_status_db == 'approved' and has_permit_details %}
                                        {% set effective_status_display = 'scheduled' %}
                                    {% endif %}

                                    {% if effective_status_display == 'approved' %}{% set status_class = 'bg-green-100 text-green-800' %}
                                    {% elif effective_status_display == 'scheduled' %}{% set status_class = 'bg-indigo-100 text-indigo-800' %}
                                    {% elif effective_status_display == 'rejected' %}{% set status_class = 'bg-red-100 text-red-800' %}
                                    {% elif effective_status_display == 'in_review' %}{% set status_class = 'bg-blue-100 text-blue-800' %}
                                    {% elif effective_status_display == 'pending' %}{% set status_class = 'bg-yellow-100 text-yellow-800' %}
                                    {% elif effective_status_display == 'passed' %}{% set status_class = 'bg-teal-100 text-teal-800' %}
                                    {% elif effective_status_display == 'failed' %}{% set status_class = 'bg-orange-100 text-orange-800' %}
                                    {% endif %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge {{ status_class }}">{{ effective_status_display | replace('_', ' ') | title  }}</span>
                                </td>
                                <td class="px-3 py-2 md:px-6 md:py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                                    <div class="flex space-x-1 justify-end items-center">
                                        <button class="text-gray-500 hover:text-primary p-0.5 sm:p-1 action-view" title="View Details" data-id="{{ app.applicant_id }}"><i class="ri-eye-line ri-lg"></i></button>
                                        
                                        <a href="{{ url_for('auth.admin_print_application_form', applicant_id=app.applicant_id) }}" target="_blank" class="text-gray-500 hover:text-green-500 p-0.5 sm:p-1 action-print" title="Print Application Form">
                                            <i class="ri-printer-line ri-lg"></i>
                                        </a>

                                        <button class="text-gray-500 hover:text-yellow-600 p-0.5 sm:p-1 action-admin-notes" title="Admin Notes" data-id="{{ app.applicant_id }}"><i class="ri-sticky-note-line ri-lg"></i></button>
                                        <button class="text-gray-500 hover:text-teal-600 p-0.5 sm:p-1 action-permit-details" title="Permit Details" data-id="{{ app.applicant_id }}"><i class="ri-ticket-line ri-lg"></i></button>
                                        <div class="dropdown relative action-status-dropdown">
                                            <button class="text-gray-500 hover:text-primary p-0.5 sm:p-1" title="Change Status">
                                                 <i class="ri-arrow-down-s-fill ri-lg"></i>
                                            </button>
                                            <div class="dropdown-content w-36 text-left">
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Approved">Approve</a>
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Scheduled">Set Scheduled</a>
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Rejected">Reject</a>
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Pending">Set Pending</a>
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Passed">Set Passed</a>
                                                <a href="#" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 action-update-status" data-id="{{ app.applicant_id }}" data-status="Failed">Set Failed</a>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr><td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No applications found.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add New Application Form Section -->
        <div id="addApplicationContent" style="display: none;" class="bg-white p-4 sm:p-6 rounded-lg shadow-sm border border-gray-100">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Add New Student Application</h3>
            <form id="adminAddApplicationForm" enctype="multipart/form-data">
                <!-- Personal Information Section -->
                <fieldset class="mb-8 p-4 border border-gray-200 rounded-md">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Personal Information</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                        <div class="md:col-span-2">
                            <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">Program (Course) <span class="text-red-500">*</span></label>
                                <select name="program_choice" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" required>
                                    <option value="">Select a Program</option>
                                    <option value="Bachelor of Science in Computer Science">Bachelor of Science in Computer Science</option>
                                    <option value="Bachelor of Science in Management Accounting">Bachelor of Science in Management Accounting</option>
                                    <option value="Bachelor of Public Administration">Bachelor of Public Administration</option>
                                    <option value="Bachelor of Science in Criminology">Bachelor of Science in Criminology</option>
                                </select>
                            </div>
                            <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">Full Name <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Last Name" name="last_name" required><p class="text-xs text-gray-500 mt-1">Last Name</p></div>
                                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="First Name" name="first_name" required><p class="text-xs text-gray-500 mt-1">First Name</p></div>
                                    <div><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Middle Name" name="middle_name"><p class="text-xs text-gray-500 mt-1">Middle Name (Optional)</p></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div><label class="block text-gray-700 font-medium mb-2">Date of Birth <span class="text-red-500">*</span></label><input type="date" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" name="date_of_birth" required></div>
                                <div><label class="block text-gray-700 font-medium mb-2">Place of Birth <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="City/Municipality" name="place_of_birth" required></div>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Sex <span class="text-red-500">*</span></label>
                                    <div class="flex gap-6 mt-2">
                                        <div class="flex items-center"><input type="radio" name="sex" value="Female" required><label class="ml-2 text-gray-700">Female</label></div>
                                        <div class="flex items-center"><input type="radio" name="sex" value="Male" required><label class="ml-2 text-gray-700">Male</label></div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">Civil Status <span class="text-red-500">*</span></label>
                                    <div class="flex flex-wrap gap-4 mt-2">
                                        <div class="flex items-center"><input type="radio" name="civil_status" value="Single" required><label class="ml-2 text-gray-700">Single</label></div>
                                        <div class="flex items-center"><input type="radio" name="civil_status" value="Married" required><label class="ml-2 text-gray-700">Married</label></div>
                                        <div class="flex items-center"><input type="radio" name="civil_status" value="Widower" required><label class="ml-2 text-gray-700">Widower</label></div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div><label class="block text-gray-700 font-medium mb-2">Religion <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Your religion" name="religion" required></div>
                                <div><label class="block text-gray-700 font-medium mb-2">Citizenship <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Your citizenship" name="citizenship" required></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div><label class="block text-gray-700 font-medium mb-2">Mobile No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's mobile number" name="mobile_number" required></div>
                                <div><label class="block text-gray-700 font-medium mb-2">Email Address <span class="text-red-500">*</span></label><input type="email" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Applicant's email address" name="email_address" required></div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">Permanent Address <span class="text-red-500">*</span></label>
                                <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Street, Barangay" name="permanent_address_street_barangay" required>
                                <div class="grid grid-cols-2 gap-4 mt-2">
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="City/Municipality" name="permanent_address_city_municipality" required>
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Province" name="permanent_address_province" required>
                                </div>
                                <div class="mt-2"><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Postal Code" name="permanent_address_postal_code" required></div>
                            </div>
                             <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">Are you a member of Cultural Minority Group? <span class="text-red-500">*</span></label>
                                <div class="flex gap-6 mt-2">
                                    <div class="flex items-center"><input type="radio" name="cultural_minority_group" value="No" required><label class="ml-2 text-gray-700">No</label></div>
                                    <div class="flex items-center"><input type="radio" name="cultural_minority_group" value="Yes" required><label class="ml-2 text-gray-700">Yes</label></div>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-gray-700 font-medium mb-2">Do you have any physical disability or condition that requires special attention? <span class="text-red-500">*</span></label>
                                <div class="flex gap-6 mt-2">
                                    <div class="flex items-center"><input type="radio" name="physical_disability" value="No" required><label class="ml-2 text-gray-700">No</label></div>
                                    <div class="flex items-center"><input type="radio" name="physical_disability" value="Yes" required><label class="ml-2 text-gray-700">Yes</label></div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                                <div class="flex flex-col items-center justify-center">
                                    <div id="adminPhotoPreviewContainer" class="w-32 h-32 bg-gray-200 border border-gray-300 rounded flex items-center justify-center mb-2 relative overflow-hidden">
                                        <img id="adminPhotoPreview" class="hidden w-full h-full object-cover"/>
                                        <i id="adminPhotoPlaceholder" class="ri-user-line text-gray-400 text-4xl"></i>
                                    </div>
                                    <p class="text-sm text-gray-700 text-center mb-2">Attach Recent 2x2 Photo (Optional for Admin)</p>
                                    <input type="file" id="adminPhotoInput" name="photo" accept="image/*" class="hidden"/>
                                    <button type="button" id="adminUploadPhotoBtn" class="bg-primary text-white px-4 py-2 rounded-button text-sm whitespace-nowrap">Upload Photo</button>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h4 class="font-medium text-gray-800 mb-2">Application Details</h4>
                                <div class="mb-4">
                                    <label class="block text-gray-700 text-sm mb-1">Date of Application <span class="text-red-500">*</span></label>
                                    <input type="date" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" name="date_of_application" id="adminDateOfApplication" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm mb-1">Academic Year <span class="text-red-500">*</span></label>
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" value="2025-2026" name="academic_year" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Family Details Section -->
                <fieldset class="mb-8 p-4 border border-gray-200 rounded-md">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Family Details</legend>
                     <div class="mb-6 mt-4">
                        <label class="block text-gray-700 font-medium mb-2">Average Family Income (Monthly) <span class="text-red-500">*</span></label>
                        <select name="average_family_income" required class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                            <option value="">Select family income</option>
                            <option value="10000_below">â‚±10,000 below</option>
                            <option value="10001_to_20000">â‚±10,001 - 20,000</option>
                            <option value="20001_to_30000">â‚±20,001 - 30,000</option>
                            <option value="30001_to_40000">â‚±30,001 - 40,000</option>
                            <option value="40001_to_50000">â‚±40,001 - 50,000</option>
                            <option value="50001_to_100000">â‚±50,001 - 100,000</option>
                            <option value="100001_above">â‚±100,001 above</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">Father's Information</h4>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Father's Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Full name" name="father_name" required></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Occupation" name="father_occupation" required></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Company name and address" name="father_company_address" required></div>
                            <div><label class="block text-gray-700 text-sm mb-2">Contact No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Mobile number" name="father_contact_number" required></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">Mother's Information</h4>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Mother's Maiden Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Full maiden name" name="mother_maiden_name" required></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Occupation" name="mother_occupation" required></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Company name and address" name="mother_company_address" required></div>
                            <div><label class="block text-gray-700 text-sm mb-2">Contact No. <span class="text-red-500">*</span></label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Mobile number" name="mother_contact_number" required></div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">Guardian's Information (Optional)</h4>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Guardian's Name</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Full name" name="guardian_name"></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Occupation</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Occupation" name="guardian_occupation"></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Company & Address</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Company name and address" name="guardian_company_address"></div>
                            <div><label class="block text-gray-700 text-sm mb-2">Contact No.</label><input type="tel" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Mobile number" name="guardian_contact_number"></div>
                        </div>
                    </div>
                </fieldset>

                <!-- Educational Background Section -->
                <fieldset class="mb-8 p-4 border border-gray-200 rounded-md">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Educational Background</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 mt-4">
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">Senior High School</h4>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">SHS Name <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="School name" name="senior_high_school" required></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Address (Brgy, City/Town, Province) <span class="text-red-500">*</span></label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="School address" name="senior_high_school_address" required></div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm mb-2">Strand <span class="text-red-500">*</span></label>
                                <select name="senior_high_school_track_strand" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary pr-8" required>
                                    <option value="">Select strand</option>
                                    <option value="STEM">STEM (Science, Technology, Engineering, and Mathematics)</option>
                                    <option value="ABM">ABM (Accountancy, Business, and Management)</option>
                                    <option value="HUMSS">HUMSS (Humanities and Social Sciences)</option>
                                    <option value="GAS">GAS (General Academic Strand)</option>
                                    <option value="TVL">TVL (Technical-Vocational-Livelihood)</option>
                                    <option value="SPORTS">Sports</option>
                                    <option value="ARTS">Arts and Design</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm mb-2">Inclusive Dates (Year) <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="From (YYYY)" name="senior_high_school_year_from" pattern="\d{4}" title="Enter a 4-digit year" required>
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="To (YYYY)" name="senior_high_school_year_to" pattern="\d{4}" title="Enter a 4-digit year" required>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">College (if any) / ALS Graduate (Optional)</h4>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">School Name</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="School name" name="tertiary_school"></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Address (Brgy, City/Town, Province)</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="School address" name="tertiary_school_address"></div>
                            <div class="mb-4"><label class="block text-gray-700 text-sm mb-2">Program</label><input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="Program/Course" name="tertiary_course"></div>
                            <div>
                                <label class="block text-gray-700 text-sm mb-2">Inclusive Dates (Year)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="From (YYYY)" name="tertiary_year_from" pattern="\d{4}" title="Enter a 4-digit year">
                                    <input type="text" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" placeholder="To (YYYY)" name="tertiary_year_to" pattern="\d{4}" title="Enter a 4-digit year">
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- Required Documents Section -->
                <fieldset class="mb-8 p-4 border border-gray-200 rounded-md">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Required Documents (Optional for Admin)</legend>
                    <p class="text-sm text-gray-600 my-4">Upload clear copies. Max 5MB per file. Accepted formats: PDF, JPG, PNG.</p>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="admin_shs_diploma_file_input">1. Certified True Copy of Senior High School Diploma</label>
                        <input type="file" id="admin_shs_diploma_file_input" name="shs_diploma_file_input" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="admin_shs_card_file_input">2. Original Senior High School Report Card (Form 138)</label>
                        <input type="file" id="admin_shs_card_file_input" name="shs_card_file_input" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="admin_birth_certificate_file_input">3. Photocopy of PSA/NSO Birth Certificate</label>
                        <input type="file" id="admin_birth_certificate_file_input" name="birth_certificate_file_input" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </fieldset>

                 <!-- Final Submission Date & Agreements -->
                <fieldset class="mb-8 p-4 border border-gray-200 rounded-md">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Submission Details</legend>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                         <div>
                            <label class="block text-gray-700 text-sm mb-2" for="admin_final_submission_date_input">Final Submission Date (Student) <span class="text-red-500">*</span></label>
                            <input type="date" id="admin_final_submission_date_input" name="final_submission_date" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-2">Agreements (Student Declaration) <span class="text-red-500">*</span></label>
                            <div class="flex items-center mt-1">
                                <input type="checkbox" name="agreements" value="Yes" id="admin_agreements_checkbox" required>
                                <label for="admin_agreements_checkbox" class="ml-2 text-gray-700">Student agreed to terms & conditions.</label>
                            </div>
                             <p class="text-xs text-gray-500 mt-1">Admin confirms student's agreement.</p>
                        </div>
                    </div>
                </fieldset>


                <div class="mt-8 flex justify-end">
                    <button type="submit" id="adminSubmitNewApplicationBtn" class="bg-primary text-white px-6 py-2 rounded-button font-medium whitespace-nowrap hover:bg-primary/90">
                        Submit New Application
                    </button>
                </div>
            </form>
        </div>


    </main>
</div>

<div id="toast-container" class="fixed top-5 right-5 z-[1000] w-auto max-w-xs space-y-2"></div>

<script>
// Make logo URLs available to JavaScript
const PGPC_LOGO_URL_JS = "{{ url_for('static', filename='logopgpc.png') }}";
const BAYAN_LOGO_URL_JS = "{{ url_for('static', filename='images/bayan_padre_garcia_logo.png') }}"; 

document.addEventListener('DOMContentLoaded', function() {
    
    function updateIsScheduledFlag(appObject) {
        if (!appObject) return;
        const hasFullPermitDetails = (
            appObject.permit_exam_date &&
            appObject.permit_exam_time && String(appObject.permit_exam_time).trim() !== '' &&
            appObject.permit_testing_room && String(appObject.permit_testing_room).trim() !== ''
        );
        appObject.is_scheduled = (appObject.application_status === 'Scheduled') || (appObject.application_status === 'Approved' && hasFullPermitDetails);
    }

    const rawApplicationsData = ({{ applications | tojson | safe if applications else [] | tojson | safe }}).map(app => {
        updateIsScheduledFlag(app); // Initial calculation of is_scheduled
        return app;
    });


    const dashboardContentDiv = document.getElementById('dashboardContent');
    const applicationsContentDiv = document.getElementById('applicationsContent');
    const addApplicationContentDiv = document.getElementById('addApplicationContent'); 
    const pageTitleHeaderElement = document.getElementById('pageTitleHeader');
    const breadcrumbCurrentPageElement = document.getElementById('breadcrumbCurrentPage');
    const breadcrumbAdminHomeLink = document.getElementById('breadcrumbAdminHomeLink');

    const sidebarDashboardMenuLink = document.getElementById('sidebarDashboardMenuLink');
    const sidebarApplicationsMenuLink = document.getElementById('applicationsMenu');
    const sidebarAddApplicationMenuLink = document.getElementById('sidebarAddApplicationMenuLink'); 
    const sidebarBackToHomeLink = document.getElementById('sidebarBackToHomeLink'); 
    const sidebarFilterLinks = {
        pending: document.getElementById('pendingFilterLink'),
        approved: document.getElementById('approvedFilterLink'),
        scheduled: document.getElementById('scheduledFilterLink'), 
        rejected: document.getElementById('rejectedFilterLink'),
        passed: document.getElementById('passedFilterLink'),
        failed: document.getElementById('failedFilterLink'),
    };

    const applicationsTable = document.getElementById('applicationsTable');
    const tableBody = applicationsTable?.querySelector('tbody');
    const selectAllCheckbox = document.getElementById('selectAll');
    const bulkActionsBar = document.getElementById('bulkActions');
    const selectedCountElement = document.getElementById('selectedCount');

    // Main View Modal
    const viewApplicationModal = document.getElementById('viewApplicationModal');
    const viewModalBackdrop = document.getElementById('viewModalBackdrop');
    const viewModalTitleJS = document.getElementById('viewModalTitle');
    const viewModalContent = document.getElementById('viewModalContent');
    const closeViewModalIcon = document.getElementById('closeViewModalIcon');

    // Delete Modal
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const deleteModalBackdrop = document.getElementById('deleteModalBackdrop');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteModalMessage = document.getElementById('deleteModalMessage');
    const deleteModalTitle = document.getElementById('deleteModalTitle');

    // Admin Notes Modal
    const adminNotesModal = document.getElementById('adminNotesModal');
    const adminNotesModalBackdrop = document.getElementById('adminNotesModalBackdrop');
    const adminNotesModalTitle = document.getElementById('adminNotesModalTitle');
    const adminNotesAppIdSpan = document.getElementById('adminNotesAppId');
    const adminNotesTextareaModal = document.getElementById('adminNotesTextareaModal');
    const closeAdminNotesModalIcon = document.getElementById('closeAdminNotesModalIcon');
    const cancelAdminNotesBtn = document.getElementById('cancelAdminNotesBtn');
    const saveAdminNotesModalBtn = document.getElementById('saveAdminNotesModalBtn');

    // Permit Details Modal (Single Application)
    const adminPermitDetailsModal = document.getElementById('adminPermitDetailsModal');
    const adminPermitDetailsModalBackdrop = document.getElementById('adminPermitDetailsModalBackdrop');
    const adminPermitDetailsModalTitle = document.getElementById('adminPermitDetailsModalTitle');
    const adminPermitAppIdSpan = document.getElementById('adminPermitAppId');
    const permitControlNoModalInput = document.getElementById('permitControlNoModal');
    const permitExamDateModalInput = document.getElementById('permitExamDateModal');
    const permitExamTimeModalInput = document.getElementById('permitExamTimeModal');
    const permitTestingRoomModalInput = document.getElementById('permitTestingRoomModal');
    const closeAdminPermitDetailsModalIcon = document.getElementById('closeAdminPermitDetailsModalIcon');
    const cancelAdminPermitDetailsBtn = document.getElementById('cancelAdminPermitDetailsBtn');
    const saveAdminPermitDetailsModalBtn = document.getElementById('saveAdminPermitDetailsModalBtn');

    // Bulk Permit Details Modal
    const bulkSetPermitDetailsBtn = document.getElementById('bulkSetPermitDetailsBtn'); 
    const bulkPermitDetailsModal = document.getElementById('bulkPermitDetailsModal');
    const bulkPermitDetailsModalBackdrop = document.getElementById('bulkPermitDetailsModalBackdrop');
    const closeBulkPermitDetailsModalIcon = document.getElementById('closeBulkPermitDetailsModalIcon');
    const cancelBulkPermitDetailsBtn = document.getElementById('cancelBulkPermitDetailsBtn');
    const saveBulkPermitDetailsBtn = document.getElementById('saveBulkPermitDetailsBtn');
    const bulkPermitExamDateInput = document.getElementById('bulkPermitExamDate');
    const bulkPermitExamTimeInput = document.getElementById('bulkPermitExamTime');
    const bulkPermitTestingRoomInput = document.getElementById('bulkPermitTestingRoom');


    // Admin Add Application Form Elements
    const adminAddApplicationForm = document.getElementById('adminAddApplicationForm');
    const adminUploadPhotoBtn = document.getElementById('adminUploadPhotoBtn');
    const adminPhotoInput = document.getElementById('adminPhotoInput');
    const adminPhotoPreview = document.getElementById('adminPhotoPreview');
    const adminPhotoPlaceholder = document.getElementById('adminPhotoPlaceholder');
    const adminDateOfApplicationInput = document.getElementById('adminDateOfApplication');
    const adminFinalSubmissionDateInput = document.getElementById('admin_final_submission_date_input');


    let itemToDelete = null;
    let currentViewingApplicantId = null;
    let activeStatusFilter = 'All';

    const startDateInput = document.getElementById('startDateFilter');
    const endDateInput = document.getElementById('endDateFilter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn'); 
    const printReportBtn = document.getElementById('printReportBtn');

    const genderFilterRadios = document.querySelectorAll('input[name="genderFilter"]');


    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    const mainContentArea = document.getElementById('mainContentArea');
    const sidebarToggleBtn = document.getElementById('sidebarToggle');


    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toast.remove(); }, 500);
        }, 3000);
    }

    function toggleDropdown(dropdownElement, forceShow = null) {
        if (forceShow === true) {
            dropdownElement.classList.add('active');
        } else if (forceShow === false) {
            dropdownElement.classList.remove('active');
        } else {
            dropdownElement.classList.toggle('active');
        }
    }

    document.querySelectorAll('.action-status-dropdown > button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            const dropdown = this.closest('.action-status-dropdown');
            document.querySelectorAll('.action-status-dropdown.active').forEach(od => {
                if (od !== dropdown) toggleDropdown(od, false);
            });
            toggleDropdown(dropdown);
        });
    });

    document.addEventListener('click', function(event) {
        document.querySelectorAll('.action-status-dropdown.active').forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
                toggleDropdown(dropdown, false);
            }
        });
        document.querySelectorAll('.dropdown.active').forEach(dropdown => {
            if (!dropdown.contains(event.target) && !dropdown.classList.contains('action-status-dropdown') ) {
                dropdown.classList.remove('active');
            }
        });
    });

    function updateStatusBadge(row, newStatus, isScheduledFlag = false) { // isScheduledFlag added
        const badge = row.querySelector('.status-badge');
        if (!badge) return;

        let displayStatus = newStatus;
        let statusClass = 'bg-gray-100 text-gray-800';

        if (newStatus === 'Approved' && isScheduledFlag) {
            displayStatus = 'Scheduled'; // Override display
        }
        
        // Determine class based on displayStatus
        if (displayStatus === 'Approved') statusClass = 'bg-green-100 text-green-800';
        else if (displayStatus === 'Scheduled') statusClass = 'bg-indigo-100 text-indigo-800';
        else if (displayStatus === 'Rejected') statusClass = 'bg-red-100 text-red-800';
        else if (displayStatus === 'Pending') statusClass = 'bg-yellow-100 text-yellow-800';
        else if (displayStatus === 'Passed') statusClass = 'bg-teal-100 text-teal-800';
        else if (displayStatus === 'Failed') statusClass = 'bg-orange-100 text-orange-800';
        
        badge.textContent = displayStatus.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        badge.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge ${statusClass} status-flash-animation`;
        setTimeout(() => badge.classList.remove('status-flash-animation'), 600);
    }


    async function handleUpdateStatus(applicantId, newStatus, rowElement) {
        try {
            const formData = new FormData();
            formData.append('status', newStatus);
            const response = await fetch(`/admin/application/${applicantId}/status`, {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
                const appInRawData = rawApplicationsData.find(app => app.applicant_id == applicantId);
                if (appInRawData) {
                    appInRawData.application_status = newStatus; // This is the DB status
                    if (result.permit_control_no !== undefined) { 
                        appInRawData.permit_control_no = result.permit_control_no;
                    }
                    if (['Approved', 'Rejected', 'Passed', 'Failed'].includes(newStatus)) {
                         appInRawData.decision_date = new Date().toISOString(); 
                    } else if (newStatus === 'Scheduled' || newStatus === 'Pending') { // Added Pending
                         appInRawData.decision_date = null;
                    }
                    updateIsScheduledFlag(appInRawData); // Re-calculate is_scheduled
                }
                const targetRow = rowElement || tableBody?.querySelector(`tr[data-applicant-id="${applicantId}"]`);
                if (targetRow && appInRawData) {
                     updateStatusBadge(targetRow, appInRawData.application_status, appInRawData.is_scheduled);
                }
                updateGlobalStatsOnStatusChange(); 
                filterTableRows(); 
            } else {
                showToast(result.message || 'Failed to update status.', 'error');
            }
        } catch (error) {
            showToast('An error occurred: ' + error.toString(), 'error');
            console.error("Error updating status:", error);
        }
    }


    async function executeDelete(ids) {
        const idArray = Array.isArray(ids) ? ids : [ids];
        if (idArray.length === 0) return;
        let successCount = 0;
        for (const id of idArray) {
            try {
                const response = await fetch(`/admin/application/${id}/delete`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    successCount++;
                    const rowToRemove = tableBody?.querySelector(`tr[data-applicant-id="${id}"]`);
                    if (rowToRemove) rowToRemove.remove();
                    const indexToRemove = rawApplicationsData.findIndex(app => app.applicant_id == id);
                    if (indexToRemove > -1) rawApplicationsData.splice(indexToRemove, 1);
                } else {
                    showToast(result.message || `Failed to delete P2025${String(id).padStart(4, '0')}.`, 'error');
                }
            } catch (error) {
                showToast(`Error deleting P2025${String(id).padStart(4, '0')}: ${error.toString()}`, 'error');
                console.error("Error deleting:", error);
            }
        }
        if (successCount > 0) showToast(`${successCount} application(s) deleted successfully.`, 'success');
        closeModal(deleteConfirmationModal, deleteModalBackdrop);
        updateBulkActionsVisibility();
        updateSelectAllCheckboxState();
        updateGlobalStatsOnDelete(idArray.length); 
        filterTableRows();
    }

    if (tableBody) {
        tableBody.addEventListener('click', async function(event) {
            const target = event.target;
            const actionView = target.closest('.action-view');
            const actionUpdateStatus = target.closest('.action-update-status');
            const actionAdminNotes = target.closest('.action-admin-notes');
            const actionPermitDetails = target.closest('.action-permit-details');
            const actionPrint = target.closest('.action-print'); 


            if (actionView) {
                event.preventDefault();
                currentViewingApplicantId = actionView.dataset.id;
                openModal(viewApplicationModal, viewModalBackdrop);
                viewModalContent.innerHTML = '<p class="text-center text-gray-500">Loading details...</p>';
                try {
                    const response = await fetch(`/admin/application/${currentViewingApplicantId}/details`);
                    const result = await response.json();
                    if (result.success && result.data) populateViewModal(result.data);
                    else viewModalContent.innerHTML = `<p class="text-red-500 text-center">Error: ${result.message || 'Could not load details.'}</p>`;
                } catch (error) {
                    viewModalContent.innerHTML = `<p class="text-red-500 text-center">Error: ${error.toString()}</p>`;
                    console.error("Error fetching details:", error);
                }
            } else if (actionAdminNotes) {
                event.preventDefault();
                currentViewingApplicantId = actionAdminNotes.dataset.id;
                try {
                    const response = await fetch(`/admin/application/${currentViewingApplicantId}/details`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        adminNotesAppIdSpan.textContent = `P2025${String(result.data.applicant_id).padStart(4, '0')}`;
                        adminNotesTextareaModal.value = result.data.admin_notes || '';
                        openModal(adminNotesModal, adminNotesModalBackdrop);
                    } else { showToast('Could not load notes data.', 'error'); }
                } catch (error) { showToast('Error fetching notes data.', 'error'); }
            } else if (actionPermitDetails) {
                event.preventDefault();
                currentViewingApplicantId = actionPermitDetails.dataset.id;
                
                permitControlNoModalInput.readOnly = true; 
                permitControlNoModalInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                permitControlNoModalInput.title = "Permit Control Number is auto-generated upon approval.";

                 try {
                    const response = await fetch(`/admin/application/${currentViewingApplicantId}/details`);
                    const result = await response.json();
                    if (result.success && result.data) {
                        adminPermitAppIdSpan.textContent = `P2025${String(result.data.applicant_id).padStart(4, '0')}`;
                        permitControlNoModalInput.value = result.data.permit_control_no || '';
                        permitExamDateModalInput.value = result.data.permit_exam_date ? result.data.permit_exam_date.split('T')[0] : '';
                        permitExamTimeModalInput.value = result.data.permit_exam_time || '';
                        permitTestingRoomModalInput.value = result.data.permit_testing_room || '';
                        
                        openModal(adminPermitDetailsModal, adminPermitDetailsModalBackdrop);
                    } else { 
                        showToast('Could not load permit data.', 'error'); 
                    }
                } catch (error) { 
                    showToast('Error fetching permit data.', 'error'); 
                }
            } else if (actionUpdateStatus) {
                event.preventDefault();
                handleUpdateStatus(actionUpdateStatus.dataset.id, actionUpdateStatus.dataset.status, actionUpdateStatus.closest('tr'));
                toggleDropdown(actionUpdateStatus.closest('.action-status-dropdown'), false);
            } 
            else if (actionPrint) { 
                // Default link behavior
            }
        });
    }

    function populateViewModal(data) {
        if (viewModalTitleJS) viewModalTitleJS.textContent = `Application Details: P2025${String(data.applicant_id).padStart(4, '0')}`;
        let contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">`;
        const fieldOrder = [
            'applicant_id', 'student_account_email', 'first_name', 'last_name', 'middle_name', 'email_address', 'mobile_number', 'program_choice', 'application_status', 'exam_status', 'submitted_at', 'date_of_application', 'date_of_birth', 'place_of_birth', 'sex', 'civil_status', 'religion', 'citizenship', 'permanent_address_street_barangay', 'permanent_address_city_municipality', 'permanent_address_province', 'permanent_address_postal_code', 'cultural_minority_group', 'physical_disability', 'academic_year', 'average_family_income', 'father_name', 'father_occupation', 'father_company_address', 'father_contact_number', 'mother_maiden_name', 'mother_occupation', 'mother_company_address', 'mother_contact_number', 'guardian_name', 'guardian_occupation', 'guardian_company_address', 'guardian_contact_number', 'senior_high_school', 'senior_high_school_address', 'senior_high_school_track_strand', 'senior_high_school_year_from', 'senior_high_school_year_to', 'tertiary_school', 'tertiary_school_address', 'tertiary_course', 'tertiary_year_from', 'tertiary_year_to', 'agreements', 'final_submission_date', 'decision_date', 'last_updated_at'
        ];
        for (const key of fieldOrder) {
            if (data.hasOwnProperty(key) && key !== 'photo' && key !== 'admin_notes' && !key.startsWith('permit_') && key !== 'control_number' && !key.endsWith('_file') && !key.endsWith('_filename') && !key.endsWith('_mimetype')) {
                 let value = data[key] === null || data[key] === undefined || data[key] === '' ? 'N/A' : data[key];
                 if ((key.includes('date') || key.includes('_at')) && value !== 'N/A' && !(value instanceof Date)) { try { value = new Date(value).toLocaleString(); } catch (e) { /* keep original */ }} else if (value instanceof Date) { value = value.toLocaleString(); }
                 let displayName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                 if (key === 'applicant_id') displayName = 'Application ID (System)'; if (key === 'student_account_email') displayName = 'Student Account Email'; if (key === 'final_submission_date') displayName = 'Final Submission Date (Student)';
                 contentHtml += `<div><strong>${displayName}:</strong> <span class="text-gray-700">${value}</span></div>`;
            }
        }
        contentHtml += `</div>`; // Close main grid

        if (data.photo) {
            let photoFilename = `P2025${String(data.applicant_id).padStart(4, '0')}_2x2_photo`;
            try {
                const urlParts = data.photo.split('/');
                const originalFilename = urlParts[urlParts.length - 1].split('?')[0]; 
                const ext = originalFilename.split('.').pop();
                if (ext && ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext.toLowerCase())) {
                    photoFilename += `.${ext}`;
                } else {
                    photoFilename += `.jpg`; // Default extension
                }
            } catch (e) {
                photoFilename += `.jpg`; // Fallback
            }

            contentHtml += `
                <div class="mt-4">
                    <strong>2x2 Photo:</strong><br>
                    <a href="${data.photo}" download="${photoFilename}" title="Download Photo">
                        <img src="${data.photo}" alt="Applicant Photo" class="max-w-xs max-h-64 border rounded mt-1 mb-1">
                    </a>
                    <br>
                    <a href="${data.photo}" download="${photoFilename}" class="text-sm document-link inline-flex items-center">
                        <i class="ri-download-2-line mr-1"></i> Download Photo
                    </a>
                </div>`;
        } else {
            contentHtml += `<div class="mt-4"><strong>2x2 Photo:</strong> <span class="text-gray-700">Not provided</span></div>`;
        }


        // Admission Test Permit Details Section
        contentHtml += `<div class="mt-6 pt-4 border-t">`;
        contentHtml += `<h4 class="text-md font-semibold text-gray-800 mb-3">Admission Test Permit</h4>`;
        contentHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm">`;
        contentHtml += `<div><strong>Permit Control No:</strong> <span class="text-gray-700">${data.permit_control_no || 'N/A'}</span></div>`;
        let examDateDisplay = 'N/A';
        if (data.permit_exam_date) {
            try { 
                const dateObj = new Date(data.permit_exam_date);
                if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1970) {
                     examDateDisplay = dateObj.toLocaleDateString();
                } else {
                     examDateDisplay = data.permit_exam_date; 
                }
            } catch (e) { examDateDisplay = data.permit_exam_date; } 
        }
        contentHtml += `<div><strong>Exam Date:</strong> <span class="text-gray-700">${examDateDisplay}</span></div>`;
        contentHtml += `<div><strong>Exam Time:</strong> <span class="text-gray-700">${data.permit_exam_time || 'N/A'}</span></div>`;
        contentHtml += `<div><strong>Testing Room:</strong> <span class="text-gray-700">${data.permit_testing_room || 'N/A'}</span></div>`;
        contentHtml += `</div></div>`; 

        contentHtml += `<div class="mt-6 pt-4 border-t">`;
        contentHtml += `<h4 class="text-md font-semibold text-gray-800 mb-3">Uploaded Requirements</h4>`;
        contentHtml += `<div class="space-y-2 text-sm">`;
        if (data.shs_diploma_filename) { contentHtml += `<div><strong>Copy of Good Moral:</strong> <a href="/applicant-document/${data.applicant_id}/diploma" target="_blank" class="document-link">${data.shs_diploma_filename} (View/Download)</a></div>`; } else { contentHtml += `<div><strong>SHS Diploma:</strong> <span class="text-gray-500">Not provided</span></div>`; }
        if (data.shs_card_filename) { contentHtml += `<div><strong>Brgy. Certificate:</strong> <a href="/applicant-document/${data.applicant_id}/card" target="_blank" class="document-link">${data.shs_card_filename} (View/Download)</a></div>`; } else { contentHtml += `<div><strong>SHS Card (Form 138):</strong> <span class="text-gray-500">Not provided</span></div>`; }
        if (data.birth_certificate_filename) { contentHtml += `<div><strong>Birth Certificate:</strong> <a href="/applicant-document/${data.applicant_id}/birth_cert" target="_blank" class="document-link">${data.birth_certificate_filename} (View/Download)</a></div>`; } else { contentHtml += `<div><strong>Birth Certificate:</strong> <span class="text-gray-500">Not provided</span></div>`; }
        contentHtml += `</div></div>`;

        viewModalContent.innerHTML = contentHtml;
    }

    async function saveAdminNotes() {
        if (!currentViewingApplicantId || !adminNotesTextareaModal) return;
        const formData = new FormData(); formData.append('notes', adminNotesTextareaModal.value);
        try { const response = await fetch(`/admin/application/${currentViewingApplicantId}/notes`, { method: 'POST', body: formData }); const result = await response.json(); if (result.success) { showToast(result.message, 'success'); closeModal(adminNotesModal, adminNotesModalBackdrop); const appInRaw = rawApplicationsData.find(app => app.applicant_id == currentViewingApplicantId); if(appInRaw) appInRaw.admin_notes = adminNotesTextareaModal.value;} else showToast(result.message || 'Failed to save notes.', 'error'); } catch (error) { showToast('An error occurred while saving notes: ' + error.toString(), 'error'); console.error("Error saving notes:", error); }
    }

    async function savePermitDetails() {
        if (!currentViewingApplicantId) return;
        const formData = new FormData();
        formData.append('permit_exam_date', permitExamDateModalInput.value);
        formData.append('permit_exam_time', permitExamTimeModalInput.value);
        formData.append('permit_testing_room', permitTestingRoomModalInput.value);
        try { 
            const response = await fetch(`/admin/application/${currentViewingApplicantId}/permit-details`, { method: 'POST', body: formData }); 
            const result = await response.json(); 
            if (result.success) { 
                showToast(result.message, 'success'); 
                closeModal(adminPermitDetailsModal, adminPermitDetailsModalBackdrop); 
                const appInRaw = rawApplicationsData.find(app => app.applicant_id == currentViewingApplicantId); 
                if(appInRaw) { 
                    if (result.data) {
                        appInRaw.permit_control_no = result.data.permit_control_no; 
                        appInRaw.permit_exam_date = result.data.permit_exam_date;
                        appInRaw.permit_exam_time = result.data.permit_exam_time;
                        appInRaw.permit_testing_room = result.data.permit_testing_room;
                    }
                    updateIsScheduledFlag(appInRaw); // Recalculate is_scheduled
                    
                    const targetRow = tableBody?.querySelector(`tr[data-applicant-id="${currentViewingApplicantId}"]`);
                    if (targetRow) updateStatusBadge(targetRow, appInRaw.application_status, appInRaw.is_scheduled);
                    
                    updateGlobalStatsOnStatusChange(); 
                    filterTableRows(); 
                }
            } else {
                 showToast(result.message || 'Failed to save permit details.', 'error'); 
            } 
        } catch (error) { 
            showToast('An error occurred while saving permit details: ' + error.toString(), 'error'); 
            console.error("Error saving permit details:", error); 
        }
    }

    if(saveAdminNotesModalBtn) saveAdminNotesModalBtn.addEventListener('click', saveAdminNotes);
    if(saveAdminPermitDetailsModalBtn) saveAdminPermitDetailsModalBtn.addEventListener('click', savePermitDetails);

    if(closeAdminNotesModalIcon) closeAdminNotesModalIcon.addEventListener('click', () => closeModal(adminNotesModal, adminNotesModalBackdrop));
    if(adminNotesModalBackdrop) adminNotesModalBackdrop.addEventListener('click', (e) => { if(e.target === adminNotesModalBackdrop) closeModal(adminNotesModal, adminNotesModalBackdrop);});
    if(cancelAdminNotesBtn) cancelAdminNotesBtn.addEventListener('click', () => closeModal(adminNotesModal, adminNotesModalBackdrop));

    if(closeAdminPermitDetailsModalIcon) closeAdminPermitDetailsModalIcon.addEventListener('click', () => closeModal(adminPermitDetailsModal, adminPermitDetailsModalBackdrop));
    if(adminPermitDetailsModalBackdrop) adminPermitDetailsModalBackdrop.addEventListener('click', (e) => { if(e.target === adminPermitDetailsModalBackdrop) closeModal(adminPermitDetailsModal, adminPermitDetailsModalBackdrop);});
    if(cancelAdminPermitDetailsBtn) cancelAdminPermitDetailsBtn.addEventListener('click', () => closeModal(adminPermitDetailsModal, adminPermitDetailsModalBackdrop));


    function openModal(modal, backdrop) { modal.classList.add('show'); backdrop.classList.add('show'); document.body.style.overflow = 'hidden'; }
    function closeModal(modal, backdrop) { modal.classList.remove('show'); backdrop.classList.remove('show'); document.body.style.overflow = ''; itemToDelete = null; currentViewingApplicantId = null; }
    if (closeViewModalIcon) closeViewModalIcon.addEventListener('click', () => closeModal(viewApplicationModal, viewModalBackdrop));
    if (viewModalBackdrop) viewModalBackdrop.addEventListener('click', (e) => { if (e.target === viewModalBackdrop) closeModal(viewApplicationModal, viewModalBackdrop); });
    if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => closeModal(deleteConfirmationModal, deleteModalBackdrop));
    if (deleteModalBackdrop) deleteModalBackdrop.addEventListener('click', (e) => { if (e.target === deleteModalBackdrop) closeModal(deleteConfirmationModal, deleteModalBackdrop); });
    if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', () => { if (itemToDelete) executeDelete(itemToDelete); });

    function getSelectedIds() { if (!tableBody) return []; return Array.from(tableBody.querySelectorAll('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.id)); }
    function updateBulkActionsVisibility() {
        if (!bulkActionsBar || !selectedCountElement) return; const selectedIds = getSelectedIds();
        if (selectedIds.length > 0) { bulkActionsBar.style.display = 'flex'; selectedCountElement.textContent = `${selectedIds.length} item(s) selected`; } else { bulkActionsBar.style.display = 'none'; }
    }
    function updateSelectAllCheckboxState() {
        if (!tableBody || !selectAllCheckbox) return; const rowCheckboxes = tableBody.querySelectorAll('.row-checkbox'); const checkedRowCheckboxes = tableBody.querySelectorAll('.row-checkbox:checked');
        let visibleRowsCount = 0; rowCheckboxes.forEach(cb => { if (cb.closest('tr').style.display !== 'none') visibleRowsCount++; });
        selectAllCheckbox.checked = (visibleRowsCount > 0 && visibleRowsCount === checkedRowCheckboxes.length);
    }
    if (selectAllCheckbox && tableBody) { selectAllCheckbox.addEventListener('change', function() { tableBody.querySelectorAll('.row-checkbox').forEach(checkbox => { const row = checkbox.closest('tr'); if (row.style.display !== 'none') { checkbox.checked = this.checked; if (this.checked) row.classList.add('selected'); else row.classList.remove('selected'); }}); updateBulkActionsVisibility(); }); }
    if (tableBody) { tableBody.addEventListener('change', function(event) { if (event.target.classList.contains('row-checkbox')) { const row = event.target.closest('tr'); if (event.target.checked) row.classList.add('selected'); else row.classList.remove('selected'); updateBulkActionsVisibility(); updateSelectAllCheckboxState(); }}); }
    document.getElementById('bulkApproveBtn')?.addEventListener('click', () => handleBulkAction('Approved'));
    document.getElementById('bulkRejectBtn')?.addEventListener('click', () => handleBulkAction('Rejected'));
    document.getElementById('bulkPassBtn')?.addEventListener('click', () => handleBulkAction('Passed'));
    document.getElementById('bulkFailBtn')?.addEventListener('click', () => handleBulkAction('Failed'));
    // Bulk Delete was removed from UI, but if re-added, this is the handler:
    // document.getElementById('bulkDeleteBtn')?.addEventListener('click', () => { const selectedIds = getSelectedIds(); if (selectedIds.length > 0) { itemToDelete = selectedIds; deleteModalTitle.textContent = `Delete ${selectedIds.length} Application(s)`; deleteModalMessage.textContent = `Are you sure you want to delete ${selectedIds.length} selected application(s)? This action cannot be undone.`; openModal(deleteConfirmationModal, deleteModalBackdrop); } else { showToast('No applications selected for deletion.', 'info'); }});
    document.getElementById('closeBulkActions')?.addEventListener('click', () => { if (!bulkActionsBar || !tableBody || !selectAllCheckbox) return; bulkActionsBar.style.display = 'none'; selectAllCheckbox.checked = false; tableBody.querySelectorAll('.row-checkbox:checked').forEach(cb => { cb.checked = false; cb.closest('tr').classList.remove('selected'); }); });

    async function handleBulkAction(actionStatus) {
        const selectedIds = getSelectedIds(); if (selectedIds.length === 0) { showToast(`No applications selected to ${actionStatus.toLowerCase()}.`, 'info'); return; }
        let successCount = 0, failCount = 0;
        for (const id of selectedIds) {
            try { 
                const formData = new FormData(); 
                formData.append('status', actionStatus); 
                const response = await fetch(`/admin/application/${id}/status`, { method: 'POST', body: formData }); 
                const result = await response.json(); 
                if (result.success) { 
                    successCount++; 
                    const appInRawData = rawApplicationsData.find(app => app.applicant_id == id); 
                    if (appInRawData) {
                        appInRawData.application_status = actionStatus; // DB status
                        if (result.permit_control_no !== undefined) { 
                            appInRawData.permit_control_no = result.permit_control_no;
                        }
                        if (['Approved', 'Rejected', 'Passed', 'Failed'].includes(actionStatus)) {
                             appInRawData.decision_date = new Date().toISOString(); 
                        } else if (actionStatus === 'Scheduled' || actionStatus === 'Pending') { // Added Pending
                             appInRawData.decision_date = null;
                        }
                        updateIsScheduledFlag(appInRawData); // Re-calculate is_scheduled

                        const rowToUpdate = tableBody?.querySelector(`tr[data-applicant-id="${id}"]`); 
                        if(rowToUpdate) updateStatusBadge(rowToUpdate, appInRawData.application_status, appInRawData.is_scheduled); 
                    }
                } else { 
                    failCount++; 
                    showToast(`Failed P2025${String(id).padStart(4,'0')}: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) { 
                failCount++; 
                console.error(`Error updating P2025${id} to ${actionStatus}:`, error); 
                showToast(`Error for P2025${String(id).padStart(4,'0')}: ${error.toString()}`, 'error');
            }
        }
        if (successCount > 0) showToast(`${successCount} application(s) set to ${actionStatus}.`, 'success'); 
        if (failCount > 0) showToast(`${failCount} application(s) failed to update.`, 'error');
        document.getElementById('closeBulkActions')?.click(); 
        updateGlobalStatsOnStatusChange();
        filterTableRows();
    }

    if (bulkSetPermitDetailsBtn) {
        bulkSetPermitDetailsBtn.addEventListener('click', () => {
            const selectedIds = getSelectedIds();
            if (selectedIds.length === 0) {
                showToast('No applications selected.', 'info');
                return;
            }
            bulkPermitExamDateInput.value = '';
            bulkPermitExamTimeInput.value = '';
            bulkPermitTestingRoomInput.value = '';
            openModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop);
        });
    }

    if (closeBulkPermitDetailsModalIcon) closeBulkPermitDetailsModalIcon.addEventListener('click', () => closeModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop));
    if (bulkPermitDetailsModalBackdrop) bulkPermitDetailsModalBackdrop.addEventListener('click', (e) => { if(e.target === bulkPermitDetailsModalBackdrop) closeModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop);});
    if (cancelBulkPermitDetailsBtn) cancelBulkPermitDetailsBtn.addEventListener('click', () => closeModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop));
    
    async function handleBulkSetPermitDetails() {
        const selectedIds = getSelectedIds();
        if (selectedIds.length === 0) {
            showToast('No applications selected.', 'info');
            closeModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop);
            return;
        }

        const permitDetailsToSet = {
            exam_date: bulkPermitExamDateInput.value,
            exam_time: bulkPermitExamTimeInput.value,
            testing_room: bulkPermitTestingRoomInput.value
        };

        if (!permitDetailsToSet.exam_date && !permitDetailsToSet.exam_time && !permitDetailsToSet.testing_room) {
             showToast('Please fill in at least one permit detail (Date, Time, or Room).', 'error');
             return;
        }
         if (!permitDetailsToSet.exam_date || !permitDetailsToSet.exam_time || !permitDetailsToSet.testing_room) {
             showToast('Please fill in all permit details (Date, Time, Room) to apply them.', 'error');
             return;
        }


        let successCount = 0;
        let failCount = 0;

        for (const id of selectedIds) {
            const formData = new FormData();
            formData.append('permit_exam_date', permitDetailsToSet.exam_date);
            formData.append('permit_exam_time', permitDetailsToSet.exam_time);
            formData.append('permit_testing_room', permitDetailsToSet.testing_room);
            
            try {
                const response = await fetch(`/admin/application/${id}/permit-details`, {
                    method: 'POST', 
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    successCount++;
                    const appInRaw = rawApplicationsData.find(app => app.applicant_id == id);
                    if (appInRaw) { 
                        if(result.data){
                            appInRaw.permit_control_no = result.data.permit_control_no; 
                            appInRaw.permit_exam_date = result.data.permit_exam_date;
                            appInRaw.permit_exam_time = result.data.permit_exam_time;
                            appInRaw.permit_testing_room = result.data.permit_testing_room;
                        } else { // Fallback if result.data is not present (though it should be)
                            appInRaw.permit_exam_date = permitDetailsToSet.exam_date;
                            appInRaw.permit_exam_time = permitDetailsToSet.exam_time;
                            appInRaw.permit_testing_room = permitDetailsToSet.testing_room;
                        }
                        updateIsScheduledFlag(appInRaw); // Recalculate is_scheduled
                         const targetRow = tableBody?.querySelector(`tr[data-applicant-id="${id}"]`);
                         if (targetRow) updateStatusBadge(targetRow, appInRaw.application_status, appInRaw.is_scheduled);
                    }
                } else {
                    failCount++;
                    showToast(`Failed for P2025${String(id).padStart(4,'0')}: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                failCount++;
                showToast(`Error for P2025${String(id).padStart(4,'0')}: ${error.toString()}`, 'error');
                console.error("Error bulk setting permit details for ID " + id, error);
            }
        }

        if (successCount > 0) showToast(`${successCount} application(s) had permit details updated.`, 'success');
        if (failCount > 0) showToast(`${failCount} application(s) failed to update permit details.`, 'error');

        closeModal(bulkPermitDetailsModal, bulkPermitDetailsModalBackdrop);
        document.getElementById('closeBulkActions')?.click(); 
        updateGlobalStatsOnStatusChange(); 
        filterTableRows(); 
    }

    if (saveBulkPermitDetailsBtn) {
        saveBulkPermitDetailsBtn.addEventListener('click', handleBulkSetPermitDetails);
    }


    const mainPageTitleElement = document.getElementById('mainPageTitle');
    const searchInput = document.getElementById('searchInput');
    const allTableRows = () => Array.from(tableBody?.querySelectorAll('tr[data-applicant-id]') || []);
    
    function updateApplicationPageTitles() {
        if (applicationsContentDiv.style.display === 'none') return;
        const startDateVal = startDateInput?.value;
        const endDateVal = endDateInput?.value;
        const selectedGenderRadio = document.querySelector('input[name="genderFilter"]:checked');
        const selectedGender = selectedGenderRadio ? selectedGenderRadio.value : 'All';

        let title = activeStatusFilter === 'All' ? 'All Applications' : `${activeStatusFilter} Applications`;
         if (activeStatusFilter === 'Approved') {
            title = 'Approved (Awaiting Schedule) Applications';
        }

        let filtersApplied = [];
        if (startDateVal || endDateVal) {
            filtersApplied.push("submission date");
        }
        if (selectedGender !== 'All') {
            filtersApplied.push(`${selectedGender.toLowerCase()} applicants`);
        }

        if (filtersApplied.length > 0) {
            title += ` (filtered by ${filtersApplied.join(' and ')})`;
        }

        if (pageTitleHeaderElement && applicationsContentDiv.style.display !== 'none') pageTitleHeaderElement.textContent = title;
        if (mainPageTitleElement) mainPageTitleElement.textContent = title;
    }

    function filterTableRows() {
        if (!tableBody) return; 
        const searchTerm = searchInput.value.toLowerCase().trim(); 
        const startDateString = startDateInput?.value; 
        const endDateString = endDateInput?.value;
        const selectedGenderRadio = document.querySelector('input[name="genderFilter"]:checked');
        const selectedGender = selectedGenderRadio ? selectedGenderRadio.value : 'All';

        let filterByDate = false, startDateObj = null, endDateObj = null;
        if (startDateString) { startDateObj = new Date(startDateString); startDateObj.setHours(0, 0, 0, 0); filterByDate = true; } 
        if (endDateString) { endDateObj = new Date(endDateString); endDateObj.setHours(23, 59, 59, 999); filterByDate = true; }
        
        allTableRows().forEach(row => {
            const appInRawData = rawApplicationsData.find(app => app.applicant_id == row.dataset.applicantId);
            if (!appInRawData) { 
                row.style.display = 'none';
                return;
            }
            updateIsScheduledFlag(appInRawData); // Ensure is_scheduled is fresh

            let matchesSearch = false;
            if (searchTerm) {
                let combinedText = '';
                combinedText += `p2025${String(appInRawData.applicant_id).padStart(4, '0')} `;
                const fieldsToExcludeFromTextSearch = [ 'photo', 'shs_diploma_file', 'shs_card_file', 'birth_certificate_file', 'student_user_id', 'shs_diploma_filename', 'shs_diploma_mimetype', 'shs_card_filename', 'shs_card_mimetype', 'birth_certificate_filename', 'birth_certificate_mimetype', 'agreements' ];
                for (const key in appInRawData) {
                    if (appInRawData.hasOwnProperty(key) && !fieldsToExcludeFromTextSearch.includes(key)) {
                        const value = appInRawData[key];
                        if (value !== null && value !== undefined) {
                            combinedText += String(value).toLowerCase() + ' ';
                        }
                    }
                }
                matchesSearch = combinedText.includes(searchTerm);
            } else { 
                matchesSearch = true;
            }
            
            const submissionDateCell = row.querySelector('.submission-date-cell'); 
            const submissionDateText = submissionDateCell?.textContent.trim(); 
            let submissionDate = null;
            if (submissionDateText && submissionDateText !== 'N/A') { try { submissionDate = new Date(submissionDateText); if (isNaN(submissionDate.getTime())) submissionDate = null; } catch (e) { submissionDate = null; }}
            
            let matchesDate = true; 
            if (filterByDate) { 
                if (submissionDate) { 
                    if (startDateObj && endDateObj) matchesDate = submissionDate >= startDateObj && submissionDate <= endDateObj; 
                    else if (startDateObj) matchesDate = submissionDate >= startDateObj; 
                    else if (endDateObj) matchesDate = submissionDate <= endDateObj; 
                } else matchesDate = false; 
            }
            
            let matchesStatus = true;
            if (activeStatusFilter === 'Approved') {
                matchesStatus = (appInRawData.application_status === 'Approved' && !appInRawData.is_scheduled);
            } else if (activeStatusFilter === 'Scheduled') {
                matchesStatus = appInRawData.is_scheduled;
            } else if (activeStatusFilter !== 'All') {
                // For other statuses, match directly against application_status
                // This ensures an "Approved" app that is "is_scheduled" won't show up if filtering for "Approved"
                // but WILL show up if filtering for its actual DB status when activeStatusFilter is e.g. "Passed"
                matchesStatus = (appInRawData.application_status === activeStatusFilter);
            }


            let matchesGender = true;
            if (selectedGender !== 'All' && appInRawData.sex) {
                matchesGender = (appInRawData.sex.toLowerCase() === selectedGender.toLowerCase());
            } else if (selectedGender !== 'All' && !appInRawData.sex) { 
                matchesGender = false;
            }
            
            row.style.display = (matchesSearch && matchesDate && matchesStatus && matchesGender) ? '' : 'none';
             // Update status badge display after filtering logic
            const statusBadgeElement = row.querySelector('.status-badge');
            if (statusBadgeElement) {
                updateStatusBadge(row, appInRawData.application_status, appInRawData.is_scheduled);
            }
        });
        updateSelectAllCheckboxState(); 
        updateBulkActionsVisibility(); 
        updateApplicationPageTitles();
    }


    searchInput?.addEventListener('input', filterTableRows);
    startDateInput?.addEventListener('change', filterTableRows);
    endDateInput?.addEventListener('change', filterTableRows);
    genderFilterRadios.forEach(radio => radio.addEventListener('change', filterTableRows));

    clearFiltersBtn?.addEventListener('click', () => {
        if(startDateInput) startDateInput.value = '';
        if(endDateInput) endDateInput.value = '';
        if(document.getElementById('genderFilterAll')) document.getElementById('genderFilterAll').checked = true;
        filterTableRows();
    });


    const flaskStats = JSON.parse('{{ stats | tojson | safe }}');
    let currentJsStats = JSON.parse(JSON.stringify(flaskStats || {total_applications:0, pending:0, approved:0, rejected:0, passed:0, failed:0, scheduled:0 })); 
    
    function getApplicationTrends(applicationsInputData, numMonths = 7) {
        const trends = { 
            labels: [], 
            submittedInMonth: new Array(numMonths).fill(0),
            progressedApplicationsInMonth: new Array(numMonths).fill(0) 
        };
        const now = new Date();
        for (let i = 0; i < numMonths; i++) {
            const dateForLabel = new Date(now.getFullYear(), now.getMonth() - (numMonths - 1 - i), 1);
            trends.labels.push(dateForLabel.toLocaleString('default', { month: 'long' })); 

            const targetYear = dateForLabel.getFullYear();
            const targetMonth = dateForLabel.getMonth();
            applicationsInputData.forEach(app => {
                let submissionDateStr = app.submitted_at || app.date_of_application;
                if (submissionDateStr) {
                    const appDate = new Date(submissionDateStr);
                    if (!isNaN(appDate.getTime())) {
                        const appYear = appDate.getFullYear();
                        const appMonth = appDate.getMonth();
                        if (appYear === targetYear && appMonth === targetMonth) { 
                            trends.submittedInMonth[i]++;
                            if (['Approved', 'Passed', 'Failed'].includes(app.application_status)) {
                                trends.progressedApplicationsInMonth[i]++;
                            }
                        }
                    }
                }
            });
        }
        return trends;
    }

    function updateGlobalStatsDisplay() {
        document.getElementById('statsTotal').textContent = currentJsStats.total_applications || 0; 
        document.getElementById('statsPending').textContent = currentJsStats.pending || 0; 
        document.getElementById('statsApproved').textContent = currentJsStats.approved || 0; // Label this as "Approved (Awaiting Schedule)"
        document.getElementById('statsScheduled').textContent = currentJsStats.scheduled || 0; 
        document.getElementById('statsRejected').textContent = currentJsStats.rejected || 0; 
        document.getElementById('statsPassed').textContent = currentJsStats.passed || 0;
        document.getElementById('statsFailed').textContent = currentJsStats.failed || 0;

        document.getElementById('pendingCountSide').textContent = currentJsStats.pending || 0; 
        document.getElementById('approvedCountSide').textContent = currentJsStats.approved || 0; // Label this as "Approved (Awaiting Schedule)"
        document.getElementById('scheduledCountSide').textContent = currentJsStats.scheduled || 0; 
        document.getElementById('rejectedCountSide').textContent = currentJsStats.rejected || 0; 
        document.getElementById('passedCountSide').textContent = currentJsStats.passed || 0;
        document.getElementById('failedCountSide').textContent = currentJsStats.failed || 0;

        if (window.applicationChartInstance) { 
            const trendData = getApplicationTrends(rawApplicationsData, 7); 
            window.applicationChartInstance.setOption({ 
                xAxis: { data: trendData.labels }, 
                series: [
                    { name: 'Applications Submitted', data: trendData.submittedInMonth }, 
                    { name: 'Approved / Subsequently Passed or Failed', data: trendData.progressedApplicationsInMonth }
                ] 
            }); 
        }
        if (window.statusChartInstance) { window.statusChartInstance.setOption({ series: [{ data: [
            { value: currentJsStats.approved || 0, name: 'Approved (Awaiting Sch.)', itemStyle: { color: '#16a34a' } },
            { value: currentJsStats.scheduled || 0, name: 'Scheduled', itemStyle: { color: '#4338ca' } },
            { value: currentJsStats.rejected || 0, name: 'Rejected', itemStyle: { color: '#dc2626' } },
            { value: currentJsStats.pending || 0, name: 'Pending', itemStyle: { color: '#ca8a04' } },
            { value: currentJsStats.passed || 0, name: 'Passed', itemStyle: { color: '#0d9488' } },
            { value: currentJsStats.failed || 0, name: 'Failed', itemStyle: { color: '#ea580c' } }
        ].filter(item => item.value > 0) }] }); }
    }


    function updateGlobalStatsOnStatusChange() { 
        currentJsStats.pending = 0; 
        currentJsStats.approved = 0; 
        currentJsStats.rejected = 0; 
        currentJsStats.passed = 0; 
        currentJsStats.failed = 0;
        currentJsStats.scheduled = 0; 

        (rawApplicationsData || []).forEach(app => { 
            const status = app.application_status; 
            updateIsScheduledFlag(app); // Crucial: ensure app.is_scheduled is up-to-date before counting

            if (status === 'Pending') {
                currentJsStats.pending++;
            } else if (status === 'Approved') {
                if (app.is_scheduled) { // If 'Approved' AND effectively scheduled
                    currentJsStats.scheduled++;
                } else { // If 'Approved' but NOT effectively scheduled
                    currentJsStats.approved++;
                }
            } else if (status === 'Scheduled') { // Explicitly 'Scheduled'
                currentJsStats.scheduled++;
            } else if (status === 'Rejected') {
                currentJsStats.rejected++;
            } else if (status === 'Passed') {
                currentJsStats.passed++;
            } else if (status === 'Failed') {
                currentJsStats.failed++;
            }
        });
        currentJsStats.total_applications = (rawApplicationsData || []).length; 
        updateGlobalStatsDisplay();
    }

    function updateGlobalStatsOnDelete(count) { 
        updateGlobalStatsOnStatusChange(); // Recalculates all stats based on remaining rawApplicationsData
    }


    function initializeSidebarState() {
        if (!sidebar || !mainContentArea) return;
        if (window.innerWidth >= 640) { 
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            mainContentArea.classList.add('sm:ml-64');
        } else { 
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            mainContentArea.classList.remove('sm:ml-64');
        }
    }

    if (sidebarToggleBtn && sidebar && mainContentArea && sidebarBackdrop) {
        const openSidebar = () => {
            if (!sidebar) return;
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            if (window.innerWidth >= 640) { 
                mainContentArea.classList.add('sm:ml-64');
            } else { 
                sidebarBackdrop.classList.remove('hidden');
            }
            setTimeout(() => { if (dashboardContentDiv.style.display !== 'none') { window.applicationChartInstance?.resize(); window.statusChartInstance?.resize();}}, 350);
        };
        const closeSidebar = () => {
            if (!sidebar) return;
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            if (window.innerWidth >= 640) { 
                 mainContentArea.classList.remove('sm:ml-64');
            } else { 
                sidebarBackdrop.classList.add('hidden');
            }
            setTimeout(() => { if (dashboardContentDiv.style.display !== 'none') { window.applicationChartInstance?.resize(); window.statusChartInstance?.resize();}}, 350);
        };

        sidebarToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (sidebar.classList.contains('-translate-x-full')) { 
                openSidebar();
            } else { 
                closeSidebar();
            }
        });
        sidebarBackdrop.addEventListener('click', closeSidebar); 

        const mainSidebarLinks = [
            sidebarDashboardMenuLink,
            sidebarApplicationsMenuLink,
            sidebarAddApplicationMenuLink,
            ...Object.values(sidebarFilterLinks).filter(link => link),
            sidebarBackToHomeLink 
        ].filter(link => link); 

        mainSidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 640 && sidebar.classList.contains('translate-x-0')) { 
                    closeSidebar();
                }
            });
        });
    }


    function updateSidebarActiveState(activeView, activeStatus = null) {
        const allNavLinks = [ sidebarDashboardMenuLink, sidebarApplicationsMenuLink, sidebarAddApplicationMenuLink, ...Object.values(sidebarFilterLinks).filter(link => link)];
        allNavLinks.forEach(link => { 
            if (link) { 
                link.classList.remove('text-primary', 'bg-primary/5'); 
                if (link === sidebarFilterLinks.pending) link.classList.add('text-yellow-600'); 
                else if (link === sidebarFilterLinks.approved) link.classList.add('text-green-600'); 
                else if (link === sidebarFilterLinks.scheduled) link.classList.add('text-indigo-700'); 
                else if (link === sidebarFilterLinks.rejected) link.classList.add('text-red-600'); 
                else if (link === sidebarFilterLinks.passed) link.classList.add('text-teal-600'); 
                else if (link === sidebarFilterLinks.failed) link.classList.add('text-orange-600'); 
                else link.classList.add('text-gray-600'); 
                link.classList.add('hover:bg-gray-50'); 
            }
        });
        const setActiveStyles = (link) => { 
            if (!link) return; 
            link.classList.add('text-primary', 'bg-primary/5'); 
            link.classList.remove('text-gray-600', 'text-yellow-600', 'text-blue-600', 'text-green-600', 'text-red-600', 'text-teal-600', 'text-orange-600', 'text-indigo-700', 'hover:bg-gray-50'); 
        };
        
        if (activeView === 'dashboard') setActiveStyles(sidebarDashboardMenuLink);
        else if (activeView === 'addApplication') setActiveStyles(sidebarAddApplicationMenuLink);
        else if (activeView === 'applications') { 
            if (activeStatus === 'All' || !activeStatus) setActiveStyles(sidebarApplicationsMenuLink); 
            else { 
                setActiveStyles(sidebarApplicationsMenuLink); 
                let targetFilterLink; 
                switch(activeStatus.toLowerCase()) { 
                    case 'pending': targetFilterLink = sidebarFilterLinks.pending; break; 
                    case 'approved': targetFilterLink = sidebarFilterLinks.approved; break; 
                    case 'scheduled': targetFilterLink = sidebarFilterLinks.scheduled; break; 
                    case 'rejected': targetFilterLink = sidebarFilterLinks.rejected; break; 
                    case 'passed': targetFilterLink = sidebarFilterLinks.passed; break; 
                    case 'failed': targetFilterLink = sidebarFilterLinks.failed; break; 
                } 
                setActiveStyles(targetFilterLink); 
            }
        }
    }
    function showView(viewName, statusForSidebarHighlight = null) {
        dashboardContentDiv.style.display = 'none'; applicationsContentDiv.style.display = 'none'; addApplicationContentDiv.style.display = 'none';
        if (viewName === 'dashboard') {
            dashboardContentDiv.style.display = 'block'; 
            if (pageTitleHeaderElement) pageTitleHeaderElement.textContent = 'Dashboard Overview'; 
            if (breadcrumbCurrentPageElement) breadcrumbCurrentPageElement.textContent = 'Dashboard'; 
            updateSidebarActiveState('dashboard'); 
            activeStatusFilter = 'All'; 
            if(startDateInput) startDateInput.value = ''; 
            if(endDateInput) endDateInput.value = '';
            if(document.getElementById('genderFilterAll')) document.getElementById('genderFilterAll').checked = true; 
            updateGlobalStatsDisplay(); 
            if (window.applicationChartInstance) window.applicationChartInstance.resize(); 
            if (window.statusChartInstance) window.statusChartInstance.resize();
        } else if (viewName === 'applications') {
            applicationsContentDiv.style.display = 'block'; 
            if (breadcrumbCurrentPageElement) breadcrumbCurrentPageElement.textContent = 'Applications'; 
            updateSidebarActiveState('applications', statusForSidebarHighlight); 
            updateApplicationPageTitles(); // Will use activeStatusFilter
            const applicationsContentElement = document.getElementById('applicationsContent'); 
            if (applicationsContentElement) applicationsContentElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else if (viewName === 'addApplication') {
            addApplicationContentDiv.style.display = 'block'; 
            if (pageTitleHeaderElement) pageTitleHeaderElement.textContent = 'Add New Application'; 
            if (breadcrumbCurrentPageElement) breadcrumbCurrentPageElement.textContent = 'Add New Application'; 
            updateSidebarActiveState('addApplication');
             const today = new Date().toISOString().split('T')[0];
             if(adminDateOfApplicationInput) adminDateOfApplicationInput.value = today;
             if(adminFinalSubmissionDateInput) adminFinalSubmissionDateInput.value = today;
        }
    }
    sidebarDashboardMenuLink?.addEventListener('click', (e) => { e.preventDefault(); showView('dashboard'); });
    sidebarAddApplicationMenuLink?.addEventListener('click', (e) => { e.preventDefault(); showView('addApplication'); });
    breadcrumbAdminHomeLink?.addEventListener('click', (e) => { e.preventDefault(); showView('dashboard'); });
    
    const setupSidebarFilterClickHandler = (linkElement, statusValueToSet) => { 
        linkElement?.addEventListener('click', (e) => { 
            e.preventDefault(); 
            activeStatusFilter = statusValueToSet; 
            if(startDateInput) startDateInput.value = ''; 
            if(endDateInput) endDateInput.value = ''; 
            if(document.getElementById('genderFilterAll')) document.getElementById('genderFilterAll').checked = true; 
            showView('applications', statusValueToSet); 
            filterTableRows(); 
        }); 
    };
    setupSidebarFilterClickHandler(sidebarApplicationsMenuLink, 'All');
    Object.entries(sidebarFilterLinks).forEach(([statusKey, linkElement]) => { 
        if (!linkElement) return; 
        let statusValue = statusKey.charAt(0).toUpperCase() + statusKey.slice(1); 
        setupSidebarFilterClickHandler(linkElement, statusValue); 
    });

    const applicationChartDom = document.getElementById('applicationChart');
    if (applicationChartDom && typeof echarts !== 'undefined') { 
        window.applicationChartInstance = echarts.init(applicationChartDom); 
        const applicationOption = { 
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } }, 
            legend: { 
                data: ['Applications Submitted', 'Approved / Subsequently Passed or Failed'], 
                top: '5%' 
            }, 
            grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true }, 
            xAxis: { type: 'category', data: [] }, 
            yAxis: { type: 'value' }, 
            series: [ 
                { 
                    name: 'Applications Submitted', 
                    type: 'bar', 
                    barWidth: '30%', 
                    color: '#4f46e5', 
                    data: [] 
                }, 
                { 
                    name: 'Approved / Subsequently Passed or Failed', 
                    type: 'bar', 
                    barWidth: '30%', 
                    color: '#16a34a', 
                    data: [] 
                } 
            ]
        }; 
        window.applicationChartInstance.setOption(applicationOption); 
        window.addEventListener('resize', () => { if (dashboardContentDiv.style.display !== 'none' && window.applicationChartInstance) window.applicationChartInstance.resize(); }); 
    }

    const statusChartDom = document.getElementById('statusChart');
    if (statusChartDom && typeof echarts !== 'undefined') { window.statusChartInstance = echarts.init(statusChartDom); const statusOption = { tooltip: { trigger: 'item' }, legend: { top: 'bottom', left: 'center' }, series: [{ name: 'Application Status', type: 'pie', radius: ['40%', '70%'], center: ['50%', '45%'], avoidLabelOverlap: false, itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 }, label: { show: false, position: 'center' }, emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } }, labelLine: { show: false }, data: [
        { value: currentJsStats.approved || 0, name: 'Approved (Awaiting Sch.)', itemStyle: { color: '#16a34a' } }, // Updated label
        { value: currentJsStats.scheduled || 0, name: 'Scheduled', itemStyle: { color: '#4338ca' } },
        { value: currentJsStats.rejected || 0, name: 'Rejected', itemStyle: { color: '#dc2626' } },
        { value: currentJsStats.pending || 0, name: 'Pending', itemStyle: { color: '#ca8a04' } },
        { value: currentJsStats.passed || 0, name: 'Passed', itemStyle: { color: '#0d9488' } },
        { value: currentJsStats.failed || 0, name: 'Failed', itemStyle: { color: '#ea580c' } }
    ].filter(item => item.value > 0) }]}; window.statusChartInstance.setOption(statusOption); window.addEventListener('resize', () => { if (dashboardContentDiv.style.display !== 'none' && window.statusChartInstance) window.statusChartInstance.resize(); }); }

    function generateAndPrintReport() {
        const visibleRows = allTableRows().filter(row => row.style.display !== 'none');
        if (visibleRows.length === 0) {
            showToast('No applications to print in the current view.', 'info');
            return;
        }

        let reportTitleText = activeStatusFilter === 'All' ? 'ALL APPLICATIONS' : `${activeStatusFilter.toUpperCase()} APPLICATIONS`;
        if (activeStatusFilter === 'Approved') reportTitleText = 'APPROVED (AWAITING SCHEDULE) APPLICATIONS';

        const selectedGenderRadio = document.querySelector('input[name="genderFilter"]:checked');
        const selectedGender = selectedGenderRadio ? selectedGenderRadio.value : 'All';
        if (selectedGender !== 'All') {
            reportTitleText += ` (${selectedGender.toUpperCase()})`;
        }
        
        let reportSubtitleHTML = '';
        const startDateVal = startDateInput?.value;
        const endDateVal = endDateInput?.value;
        if (startDateVal || endDateVal) {
            let dateFilterText = "Filtered by Submission Date: ";
            if (startDateVal && endDateVal) {
                dateFilterText += `From ${new Date(startDateVal).toLocaleDateString()} to ${new Date(endDateVal).toLocaleDateString()}`;
            } else if (startDateVal) {
                dateFilterText += `From ${new Date(startDateVal).toLocaleDateString()} onwards`;
            } else if (endDateVal) {
                dateFilterText += `Up to ${new Date(endDateVal).toLocaleDateString()}`;
            }
            reportSubtitleHTML = `<p class="report-subtitle">${dateFilterText}</p>`;
        }


        let tableContentHTML = `
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Applicant</th>
                    <th>Program</th>
                    <th>Submission Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
        `;

        visibleRows.forEach(row => {
            const appId = row.cells[1]?.textContent.trim() || 'N/A';
            const applicantName = row.querySelector('.applicant-name')?.textContent.trim() || 'N/A';
            const program = row.querySelector('.applicant-program')?.textContent.trim() || 'N/A';
            const submissionDate = row.querySelector('.submission-date-cell')?.textContent.trim() || 'N/A';
            const status = row.querySelector('.status-badge')?.textContent.trim() || 'N/A';

            tableContentHTML += `
                <tr>
                    <td>${appId}</td>
                    <td>${applicantName}</td>
                    <td>${program}</td>
                    <td>${submissionDate}</td>
                    <td>${status}</td>
                </tr>
            `;
        });
        tableContentHTML += `</tbody>`;

        const reportHtml = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="utf-8">
                <title>Application Report</title> 
                <style>
                    body.print-popup-body { 
                        font-family: 'Times New Roman', Times, serif;
                        margin: 20mm 15mm 15mm 20mm; 
                        color: #000000; 
                        background-color: #ffffff !important; 
                        font-size: 11pt; 
                        line-height: 1.4;
                        -webkit-print-color-adjust: exact; 
                        print-color-adjust: exact;
                    }
                    .print-page-container { width: 100%; max-width: 100%; margin: 0 auto; }
                    .print-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000000; padding-bottom: 10px; page-break-inside: avoid; }
                    .print-header-top-logos { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; }
                    .print-header .logo { max-height: 50px; width: auto; object-fit: contain; }
                    .print-header .header-text-block { margin-bottom: 5px; }
                    .print-header .republic { font-size: 9pt; margin-bottom: 1px; text-transform: uppercase; letter-spacing: 0.5px; }
                    .print-header .school-name { font-size: 13pt; font-weight: bold; margin-bottom: 1px; text-transform: uppercase; }
                    .print-header .address-line { font-size: 8pt; margin-bottom: 1px; }
                    .print-header .contact-line { font-size: 8pt; margin-bottom: 0; }
                    .report-title-section { text-align: center; margin-top: 15px; margin-bottom: 15px; page-break-inside: avoid; page-break-after: avoid; } 
                    .report-title { font-size: 14pt; margin-top: 0; margin-bottom: 3px; font-weight: bold; color: #000000; text-transform: uppercase; }
                    .report-subtitle { font-size: 10pt; color: #333333; margin-top: 0; margin-bottom: 10px; }
                    .print-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; page-break-inside: auto; }
                    .print-table th, .print-table td { border: 1px solid #333333; padding: 5px 7px; text-align: left; word-break: break-word; vertical-align: top; }
                    .print-table th { background-color: #f0f0f0 !important; font-weight: bold; color: #000000 !important; text-align: center; }
                    .print-table thead { display:table-header-group; } 
                    .print-table tr { page-break-inside:avoid; page-break-after:auto; }
                    .print-table td a { color: #000000; text-decoration: none; }
                    .prepared-by-section { margin-top: 35px; font-size: 10pt; page-break-inside: avoid; line-height: 1.5; }
                    .prepared-by-section p { margin-bottom: 2px; }
                    .prepared-by-section .signature-line { border-bottom: 1px solid #000000; width: 250px; margin-top: 20px; margin-bottom: 2px; }
                    .prepared-by-section .name-title { font-weight: bold; text-transform: uppercase; }
                    .print-footer { text-align: center; margin-top: 20px; padding-top: 8px; border-top: 1px solid #cccccc; font-size: 8pt; font-style: italic; page-break-inside: avoid; color: #555555; }
                    .no-print-in-iframe, .site-header, .main-navigation, .page-title-bar, .messages-container, .site-footer, .action-buttons-cell, th.no-print, td.no-print, form.delete-form, .btn, .btn-primary, .btn-secondary, .btn-info, .btn-danger, .btn-action, .btn-link { display: none !important; }
                </style>
            </head>
            <body class="print-popup-body">
                <div class="print-page-container">
                    <div class="print-header">
                        <div class="print-header-top-logos">
                            <img src="${PGPC_LOGO_URL_JS}" alt="PGPC Logo" class="logo">
                            <img src="${BAYAN_LOGO_URL_JS}" alt="Bayan ng Padre Garcia Logo" class="logo">
                        </div>
                        <div class="header-text-block">
                            <p class="republic">Republic of the Philippines</p>
                            <p class="school-name">PADRE GARCIA POLYTECHNIC COLLEGE (PGPC)</p>
                            <p class="address-line">Padre Garcia, Batangas, Philippines 4224</p>
                            <p class="contact-line">padregarciapolytechniccollege@gmail.com     (043) 515-9207</p>
                        </div>
                    </div>
                    <div class="report-title-section">
                        <h1 class="report-title">${reportTitleText}</h1>
                        ${reportSubtitleHTML}
                    </div>
                    <table class="print-table">${tableContentHTML}</table>
                    <div class="prepared-by-section">
                        <p>Date Printed: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <br><br><p>Prepared by:</p>
                        <div class="signature-line"></div>
                        <p class="name-title">[ MRS. NICKY JANE A. SOLIS ]</p> 
                        <p>College Registrar Coordinator</p>
                         <br><br><p>Noted by:</p>
                        <div class="signature-line"></div>
                        <p class="name-title">[ MRS. JENNIFER BUYA ]</p> 
                        <p>Guidance Counselor</p>
                    </div>
                    <div class="print-footer">
                        <p class="tagline">â€œGARCIANO AKO, DISIPLINADO, MABUTING TAO.â€</p>
                    </div>
                </div>
            </body>
            </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.open();
        printWindow.document.write(reportHtml);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.focus(); 
            printWindow.print();
        };
    }

    if (printReportBtn) {
        printReportBtn.addEventListener('click', generateAndPrintReport);
    }

    if (adminUploadPhotoBtn) {
        adminUploadPhotoBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if(adminPhotoInput) adminPhotoInput.click();
        });
    }
    if (adminPhotoInput) {
        adminPhotoInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith("image/")) {
                    showToast("âš ï¸ Please select an image file for the photo.", "error");
                    adminPhotoInput.value = ""; 
                    return;
                }
                const MAX_SIZE = 5 * 1024 * 1024; 
                if (file.size > MAX_SIZE) {
                    showToast("âš ï¸ Photo is too large (max 5MB).", "error");
                    adminPhotoInput.value = ""; 
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    if(adminPhotoPreview) adminPhotoPreview.src = event.target.result;
                    if(adminPhotoPreview) adminPhotoPreview.classList.remove("hidden");
                    if(adminPhotoPlaceholder) adminPhotoPlaceholder.classList.add("hidden");
                };
                reader.readAsDataURL(file);
                showToast("âœ… Photo selected: " + file.name, "success");
            }
        });
    }
    const adminFileInputs = addApplicationContentDiv.querySelectorAll('input[type="file"]:not(#adminPhotoInput)');
    adminFileInputs.forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const labelText = this.labels && this.labels.length > 0 ? this.labels[0].textContent.split('*')[0].trim().replace(/\d+\.\s*/, '') : "Document";
            if (file) {
                const MAX_DOC_SIZE = 5 * 1024 * 1024; 
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
                const fileExt = file.name.split('.').pop().toLowerCase();
                const isAllowedType = allowedTypes.includes(file.type) || allowedTypes.map(t => t.split('/')[1]).includes(fileExt);

                if (!isAllowedType) {
                    showToast(`âš ï¸ Invalid file type for ${labelText}. Allowed: PDF, JPG, PNG.`, "error");
                    input.value = ""; 
                    return;
                }
                if (file.size > MAX_DOC_SIZE) {
                    showToast(`âš ï¸ ${labelText} is too large (max 5MB).`, "error");
                    input.value = ""; 
                    return;
                }
                showToast(`âœ… File selected for ${labelText}: ${file.name}`, "success");
            }
        });
    });


    if (adminAddApplicationForm) {
        adminAddApplicationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = document.getElementById('adminSubmitNewApplicationBtn');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            submitButton.classList.add('opacity-50', 'cursor-not-allowed');

            const formData = new FormData(adminAddApplicationForm);
            try {
                const response = await fetch("{{ url_for('auth.admin_add_application_by_admin_action') }}", {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message, 'success');
                    adminAddApplicationForm.reset(); 
                    if(adminPhotoPreview) adminPhotoPreview.src = "";
                    if(adminPhotoPreview) adminPhotoPreview.classList.add("hidden");
                    if(adminPhotoPlaceholder) adminPhotoPlaceholder.classList.remove("hidden");
                    
                    const newApp = result.application_data; 
                    if (newApp) {
                        updateIsScheduledFlag(newApp); // Calculate is_scheduled for new app
                        rawApplicationsData.unshift(newApp); 
                    }
                    updateGlobalStatsOnStatusChange(); 
                    showView('applications', 'All'); 
                    filterTableRows(); 
                } else {
                    showToast(result.message || 'Failed to add application.', 'error');
                }
            } catch (error) {
                showToast('An error occurred: ' + error.toString(), 'error');
                console.error("Error submitting new application by admin:", error);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Submit New Application';
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }


    initializeSidebarState(); 
    updateGlobalStatsOnStatusChange(); 
    showView('dashboard'); 
    filterTableRows(); 

    window.addEventListener('resize', initializeSidebarState);
});

</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    const mainContentArea = document.getElementById('mainContentArea'); 

    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        if (window.innerWidth < 640) { 
             sidebarBackdrop.classList.toggle('hidden');
        }
    });

    sidebarBackdrop.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        sidebarBackdrop.classList.add('hidden');
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth >= 640) { 
            sidebar.classList.remove('-translate-x-full'); 
            if(mainContentArea) mainContentArea.classList.add('sm:ml-64'); 
            sidebarBackdrop.classList.add('hidden'); 
        } else {
            if(mainContentArea) mainContentArea.classList.remove('sm:ml-64');
        }
    });
});
</script>

</body>
</html>